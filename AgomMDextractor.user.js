// ==UserScript==
// @name         Agom Markdownæå–å™¨
// @namespace    http://tampermonkey.net/
// @version      0.9
// @description  çªç ´æ€§iframeå†…å®¹æå–ï¼šå¤šé‡æå–ç­–ç•¥ï¼ˆç›´æ¥è®¿é—®ã€æ¶ˆæ¯é€šä¿¡ã€URLè·å–ï¼‰ã€æ™ºèƒ½å†…å®¹æ£€æµ‹ã€ç”¨æˆ·æŒ‡å¯¼ç³»ç»Ÿã€‚å½»åº•è§£å†³è·¨åŸŸiframeå†…å®¹æå–éš¾é¢˜ï¼Œé€šè¿‡DOMåˆ†æå’ŒpostMessageå®ç°è·¨iframeçš„å†…å®¹æå–ã€Markdownè½¬æ¢å’ŒDOMç»“æ„é¢„è§ˆã€‚
// @author       Agom Liou vxï¼šUncleliou
// @match        *://*/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    const SCRIPT_VERSION = '0.9';
    const isTopWindow = window.self === window.top;
    let selectionContext = { source: 'top', selector: null, iframeId: null };

    // æ”¶æ¬¾ç base64æ•°æ®
    const PAYMENT_QR_BASE64 = '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2Ldv33k5q67rtGrViujoaPbu3UtNTY33C5BlunXrhtvtZteuXefcLyEhgfT0dE6ePElBQcE563bt2hWLxcLWrVsxmUx07drVeI6ysjIOHz5MQkICaWlpaJqGKIocPXqUkpISOnToQHBwMLt27cLhcPxuidDwWRru108gf0DVSpIknnjiCb799tt/6rMPPfQQb775Jh6PB1EUkWXZQARN0xg8eDBFRUUUFRURGRmJJEns37+fvn37XnDNRYsWcdtttzFu3Dh2795tEEhZWRlFRUX06dPnnM/cc889vPPOO7zyyivMnTv3nNePHz9OkyZNuPzyy4mKiqKkpMR4bdOmTQwbNoz77ruPv//97yiKgtls5umnn+arr75i48aN9O7dm5tuuons7Ox/6nzmz5/PmDFjUFXVYBB+AvmDgtVqRRRFFixYQLt27QgODsZkatzdz+l0UldXx5o1a3jssccICPCOWzObvR0IH374YZYsWcK3335Lx44dMZvN2Gw2YmJicDgc9O7dm8rKSgAGDBjAwoULqaysxO1287e//Y158+YZa37++ec4nU7DDggJCcHj8SDLskHUiqKg6zoWiwVZlpk9ezYvvPACjzzyCF9//TVLliyha9euREdHI4oi+/fvJz8/nyZNvCMTdF2nd+/e7Nmzh7Aw79Sm9957j48//pgHHniAZ555hvT0dAACAgKwWCysWrWKiIgIQkNDz5EKdrsdl8vF22+/zUcffYTFYvGrWJeSqqVpGm3atKFdu3YsXLiQ6upqQ/fWNI24uDhuvPFGTp8+jaZphtH7448/smvXLgIDA7n55puJi4tDFEUkScLlcvHiiy9SXV1NZmYmkZGRTJ48mYCAAD777DO6detG7969iY6ORlVVw4Bv0aJFo/3Nnj2b7Oxsw1j2eDw0a9aMESNGIIoi06ZNw2q1EhgYyMmTJ1EUhQ0bNlBYWMjNN99MeHg4bdu2JS0tjZtvvtlYp0uXLnTo0MG4T05ODnv27CEmJoaOHTueY7T36NEDURT54IMPDFVUFEVUVaV9+/b07t2bmJiY33RE+AnkDwx1dXVomsYDDzxAVVVVo9dat27NsGHDqKurM5AGYO3atbz99tssXLiQwYMHU1FRQU5ODpIkIQgC06dPN7xEbdu25fXXX2fVqlUMHTqUsWPHkpiYiMfjITExEZvNO8PPp7YVFBRQ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fDmZmZl06tQJ8FbgJScnU1FRYWS1KorCihUruPPOO4013njjDdauXcuwYcN47LHHWLduHd27d2f06NFGPlKTJk04ffr0Off2IY6vpv2JJ55g+fLlRmeUxMRE8vPzjWE+DdUhH9x///2sX7+eRx55hP79+zNv3jxGjRrF6NGj2bdvH6IoEh0dTVFREdHR0axdu5ZDhw5x2WWXYTabqaur44MPPjDmEfrmDgI899xzF1RNfdJPFEXcbjfDhw/nrbfe4vHHH2fYsGF8+umnjBw5ElVVL+mCqT+Fm9enfviIw4coZ86cobKykpqaGjZs2IAsy4wbNw673U5RURG5ubmcOnUKm83GmjVrMJlMREdHY7Va2bt3LwcOHGik2/u8Qd988w1BQUE8/fTThuSQZdnQ2X37stls2Gw2tmzZYswqr6ioICcnh48++ghJkrBarXg8Hl566SXsdjsjR440pKLdbqeyspKsrCxiYmIMgzkjI4MDBw5w3XXXkZGRwd///nckSWLKlCkcO3aMa665BkVRWLZsGTk5OVRVVWG328nNzWXjxo0IgoCiKEZSp6IofPTRR6SkpBhqoL9pwyWkYi1fvtzQod1udyMiafhet9uN1WolICCAXr16ceWVV3L99dcTFhbGkiVLOHr0KC+88AIpKSk899xztGnThtdffx2n08nTTz9NkyZNmDBhAq1ateLpp5+me3dvwO/rr79m06ZNtGvXjg4dOvDpp5+yYMECiouLkSTJGF3w4osvkpSUxP33309sbKxhB5hMJjZs2MCWLVsYOXIkzZo148svv+TMmTPGczzyyCM4HA5ee+01UlJSuOeeezh48KBRp6KqKpGRkaSkpBASEmJ4rJKSkpgxYwaVlZVMmzbNsDuSk5N59NFH2bt3L5988gl1dXXY7Xauu+46+vfvb9S8+71Yl4CK9cEHH7By5UrCw8MbqRg++8Jng8iybLiA77vvPvr378+gQYMYNGgQiqLw7bffsnXrVjZt2sTEiRMJCgpi8uTJRtFVhw4dmDBhgkEoZrN3+tOePXv45JNPWLx4Mf3792fo0KFs2bIFu91OUFAQTqeTiooKPvjgAzp27Mg999xjdE8vLCzk2LFjvPfeeyxZsgSTycSNN97ISy+9xIkTJ4xnnThxIlVVVbzyyiukpKTQp08fjh07ZriBHQ6HUWLrc0j4nBOff/45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';

    // æ¯æ—¥æç¤ºåŠŸèƒ½
    const LAST_SHOW_DATE_KEY = 'agom_md_extractor_last_show_date';

    // è°ƒè¯•æ¨¡å¼
    const DEBUG_MODE = true;
    function debugLog(...args) {
        if (DEBUG_MODE) {
            console.log(`[Agom MDæå–å™¨ DEBUG]`, ...args);
        }
    }

    // å…¨å±€å·¥å…·æ ç®¡ç†å™¨
    const ToolbarManager = {
        created: false,
        creating: false,
        instance: null,

        shouldCreateToolbar() {
            // åªæœ‰é¡¶çº§çª—å£æˆ–è€…ç¡®å®šçš„ç‹¬ç«‹iframeæ‰èƒ½åˆ›å»ºå·¥å…·æ 
            if (isTopWindow) return true;

            // å¦‚æœä¸æ˜¯é¡¶çº§çª—å£ï¼Œæ£€æŸ¥æ˜¯å¦èƒ½ä¸çˆ¶çª—å£é€šä¿¡
            try {
                window.parent.postMessage({ type: 'toolbar-check' }, '*');
                return false; // èƒ½é€šä¿¡å°±ä¸åˆ›å»ºç‹¬ç«‹å·¥å…·æ 
            } catch (e) {
                return true; // ä¸èƒ½é€šä¿¡æ‰åˆ›å»ºç‹¬ç«‹å·¥å…·æ 
            }
        },

        createToolbar() {
            debugLog('ToolbarManager.createToolbar è¢«è°ƒç”¨ï¼Œå½“å‰çŠ¶æ€:', {
                created: this.created,
                creating: this.creating,
                isTopWindow,
                url: window.location.href
            });

            if (this.created || this.creating) {
                debugLog('å·¥å…·æ å·²å­˜åœ¨æˆ–æ­£åœ¨åˆ›å»ºï¼Œè·³è¿‡');
                return false;
            }

            if (!this.shouldCreateToolbar()) {
                debugLog('ä¸åº”è¯¥åœ¨æ­¤ç¯å¢ƒåˆ›å»ºå·¥å…·æ ');
                return false;
            }

            this.creating = true;
            debugLog('å¼€å§‹åˆ›å»ºå·¥å…·æ ');

            // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„æ—§å·¥å…·æ 
            this.removeAllToolbars();

            try {
                const result = this._doCreateToolbar();
                if (result) {
                    this.created = true;
                    this.instance = document.getElementById(CONFIG.TOOLBAR_ID);
                    debugLog('å·¥å…·æ åˆ›å»ºæˆåŠŸ');
                } else {
                    debugLog('å·¥å…·æ åˆ›å»ºå¤±è´¥');
                }
                return result;
            } finally {
                this.creating = false;
            }
        },

        removeAllToolbars() {
            const selectors = [
                `#${CONFIG.TOOLBAR_ID}`,
                '[id*="md-extractor-toolbar"]',
                '[id*="markdown-extractor"]',
                '.md-extractor-toolbar'
            ];

            selectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    console.log('[ToolbarManager] ç§»é™¤å·¥å…·æ :', el.id || el.className);
                    el.remove();
                });
            });

            this.created = false;
            this.instance = null;
        },

        _doCreateToolbar() {
            // å®é™…çš„å·¥å…·æ åˆ›å»ºé€»è¾‘
            return createFloatingToolbar();
        }
    };

    // æ›´å…¨é¢çš„åµŒå¥—ç¯å¢ƒæ£€æµ‹
    function detectNestingEnvironment() {
        const info = {
            isTopWindow: window.self === window.top,
            isInFrame: window.frameElement !== null,
            isInIframe: window.frameElement && window.frameElement.tagName === 'IFRAME',
            isInEmbed: window.frameElement && window.frameElement.tagName === 'EMBED',
            isInObject: window.frameElement && window.frameElement.tagName === 'OBJECT',
            hasParentWindow: window.parent !== window,
            canCommunicateWithParent: false,
            isInShadowDOM: false,
            shadowHost: null
        };

        try {
            // æµ‹è¯•æ˜¯å¦å¯ä»¥ä¸çˆ¶çª—å£é€šä¿¡
            if (info.hasParentWindow) {
                window.parent.location.href;
                info.canCommunicateWithParent = true;
            }
        } catch (e) {
            info.canCommunicateWithParent = false;
        }

        // æ£€æµ‹Shadow DOM
        try {
            let currentNode = document.documentElement;
            while (currentNode) {
                if (currentNode.host && currentNode.host.shadowRoot) {
                    info.isInShadowDOM = true;
                    info.shadowHost = currentNode.host;
                    break;
                }
                currentNode = currentNode.parentNode;
            }
        } catch (e) {
            // Shadow DOMæ£€æµ‹å¤±è´¥ï¼Œå¿½ç•¥
        }

        return info;
    }

    const nestingInfo = detectNestingEnvironment();

    // =================================================================================
    // --- é…ç½®ä¸­å¿ƒ (Configuration Center) ---
    // =================================================================================
    const CONFIG = {
        POLL_INTERVAL: 1000,
        POLL_TIMEOUT: 20000,
        HIGHLIGHT_CLASS: 'md-extractor-highlighted',
        HOVER_HIGHLIGHT_CLASS: 'md-extractor-hover-highlight',
        TOOLBAR_ID: 'md-extractor-toolbar',
        JUNK_SELECTORS: [
            '.h-date-picker', '.h-year-picker', '.h-month-picker', '.h-calendar',
            '.h-select-dropdown', '.h-cascader-menus', 'div.h-dropdown-menu',
            'button:not(.selector-btn)', 'a.h-btn', '.h-page',
            '.h-poptip', '.h-tooltip', '[class*="tooltip"]',
            '.h-loading', 'div[class*="loading"]',
            '.h-modal-mask', '.h-modal-wrap',
            '[class*="icon"]:not([class*="form"])', 'i[class^="h-icon"]', 'svg',
            '.h-form-item-extra', '.h-form-item-help',
            '[style*="display: none"]', '[style*="display:none"]',
            'script', 'style', 'link', 'meta', 'title'
        ],
        // éœ€è¦ç‰¹æ®Šå¤„ç†çš„onclickå…ƒç´ 
        ONCLICK_JUNK_PATTERNS: [
            /å±•å¼€/i, /æ”¶èµ·/i, /æ›´å¤š/i, /\.{3}/,
            /ç½®é¡¶/i, /åˆ é™¤/i, /ç¼–è¾‘/i, /è®¾ç½®/i,
            /ä¸Šä¸€é¡µ/i, /ä¸‹ä¸€é¡µ/i, /ç¬¬\s*\d+\s*é¡µ/i,
            /å…³é—­/i, /å–æ¶ˆ/i, /ç¡®å®š/i, /è¿”å›/i
        ],
        IGNORE_TAGS: ['script', 'style', 'link', 'iframe', 'button', 'svg', 'canvas', 'video', 'audio', 'meta', 'title'],
        CLEANUP_KEYWORDS: [/æ‰¹æ³¨/g, /å±•å¼€$/g, /æ”¶èµ·$/g, /æ›´å¤š$/g, /\s*â€¦\s*å±•å¼€$/g, /\s*â€¦$/g, /^\s*$/, /\n\s*\n\s*\n/g],
    };

    // =================================================================================
    // --- çŠ¶æ€ç®¡ç† (State Management) ---
    // =================================================================================
    let isInitialized = false;
    let isPickingMode = false;
    let lastHoveredElement = null;
    let statusTimeout = null;

    // =================================================================================
    // --- åˆå§‹åŒ– (Initialization) ---
    // =================================================================================
    function waitForDOM() {
        return new Promise((resolve) => {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', resolve);
            } else {
                resolve();
            }
        });
    }

    async function init() {
        try {
            await waitForDOM();

            // ç­‰å¾…bodyå…ƒç´ å‡†å¤‡å¥½
            let attempts = 0;
            const maxAttempts = 20;

            while (!document.body && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, CONFIG.POLL_INTERVAL));
                attempts++;
            }

            if (!document.body) {
                console.error('MDæå–å™¨: åˆå§‹åŒ–å¤±è´¥ï¼Œæœªæ‰¾åˆ°bodyå…ƒç´ ');
                return;
            }

            if (!isInitialized) {
                initMarkdownExtractor();
            }
        } catch (error) {
            console.error('MDæå–å™¨: åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºé”™:', error);
            // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œç­‰å¾…ä¸€ä¸‹é‡è¯•
            setTimeout(() => {
                if (!isInitialized) {
                    console.log('MDæå–å™¨: å°è¯•é‡æ–°åˆå§‹åŒ–...');
                    init();
                }
            }, 2000);
        }
    }

    function initMarkdownExtractor() {
        if (isInitialized) return;

        try {
            isInitialized = true;

            console.log(`ğŸš€ Agom Markdownæå–å™¨ v${SCRIPT_VERSION} åµŒå¥—ç¯å¢ƒæ£€æµ‹:`, nestingInfo);

            if (nestingInfo.isTopWindow) {
                console.log(`ğŸš€ Agom Markdownæå–å™¨ v${SCRIPT_VERSION} å·²å¯åŠ¨ï¼[Master]`);

                // ä½¿ç”¨å·¥å…·æ ç®¡ç†å™¨åˆ›å»ºå·¥å…·æ 
                ToolbarManager.createToolbar();
                addCustomStyles();
                window.addEventListener('message', handleFrameMessage, false);
            } else {
                // åœ¨åµŒå¥—ç¯å¢ƒä¸­çš„å¤„ç†
                const nestingType = nestingInfo.isInShadowDOM ? 'shadow-dom' :
                                   nestingInfo.isInIframe ? 'iframe' :
                                   nestingInfo.isInEmbed ? 'embed' :
                                   nestingInfo.isInObject ? 'object' :
                                   nestingInfo.isInFrame ? 'frame' : 'unknown';

                console.log(`ğŸš€ Markdownæå–å™¨ v${SCRIPT_VERSION} (è¯Šæ–­ç‰ˆ) å·²å¯åŠ¨ï¼[Nested-${nestingType}]`);

                // æ ¹æ®åµŒå¥—ç±»å‹å’Œé€šä¿¡èƒ½åŠ›å†³å®šç­–ç•¥
                if (nestingInfo.canCommunicateWithParent) {
                    console.log('[MD Extractor] å¯ä»¥ä¸çˆ¶çª—å£é€šä¿¡ï¼Œå°è¯•ååŒå·¥ä½œ');
                    // å°è¯•ä¸çˆ¶çª—å£é€šä¿¡ï¼Œå¦‚æœå¤±è´¥åˆ™åˆ›å»ºç‹¬ç«‹å·¥å…·æ 
                    let hasParentCommunication = false;

                    // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
                    window.addEventListener('message', (event) => {
                        if (event.data.type === 'pong') {
                            hasParentCommunication = true;
                            console.log('[MD Extractor] çˆ¶çª—å£å“åº”æ­£å¸¸');
                        }
                        handleMasterMessage(event);
                    }, false);

                    // ç¡®ä¿iframeèƒ½æ¥æ”¶é€‰æ‹©æ¨¡å¼æ¶ˆæ¯
                    debugLog('iframeå·²ç»‘å®šæ¶ˆæ¯ç›‘å¬å™¨ï¼Œå‡†å¤‡æ¥æ”¶é€‰æ‹©æ¨¡å¼æŒ‡ä»¤');

                    setTimeout(() => {
                        try {
                            window.parent.postMessage({ type: 'ping' }, '*');
                            console.log('[MD Extractor] å‘é€pingç»™çˆ¶çª—å£');
                        } catch (e) {
                            console.log('[MD Extractor] æ— æ³•å‘é€pingç»™çˆ¶çª—å£');
                        }
                    }, 100);

                    // ç­‰å¾…çˆ¶çª—å£å“åº”ï¼Œå¦‚æœæ²¡æœ‰å“åº”åˆ™åˆ›å»ºç‹¬ç«‹å·¥å…·æ 
                    setTimeout(() => {
                        if (!hasParentCommunication) {
                            console.log('[MD Extractor] çˆ¶çª—å£æ— å“åº”ï¼Œå°è¯•åˆ›å»ºç‹¬ç«‹å·¥å…·æ ');
                            if (ToolbarManager.createToolbar()) {
                                addCustomStyles();
                            }
                        } else {
                            console.log('[MD Extractor] çˆ¶çª—å£å“åº”æ­£å¸¸ï¼Œä¸åˆ›å»ºç‹¬ç«‹å·¥å…·æ ');
                        }
                    }, 1000);
                } else {
                    console.log('[MD Extractor] æ— æ³•ä¸çˆ¶çª—å£é€šä¿¡ï¼Œå°è¯•åˆ›å»ºç‹¬ç«‹å·¥å…·æ ');

                    // å³ä½¿æ— æ³•é€šä¿¡ï¼Œä¹Ÿè¦ç»‘å®šæ¶ˆæ¯ç›‘å¬å™¨ï¼Œä»¥é˜²åç»­èƒ½å¤Ÿæ¥æ”¶æ¶ˆæ¯
                    window.addEventListener('message', handleMasterMessage, false);
                    debugLog('æ— çˆ¶é€šä¿¡iframeå·²ç»‘å®šæ¶ˆæ¯ç›‘å¬å™¨');

                    if (ToolbarManager.createToolbar()) {
                        addCustomStyles();
                    }
                }
            }

                // ä¸º iframe åˆ†é…å”¯ä¸€ IDï¼ˆé’ˆå¯¹OAç³»ç»Ÿä¼˜åŒ–ï¼‰
                function assignIframeIds(container, prefix = '') {
                    const iframes = container.querySelectorAll('iframe');
                    iframes.forEach((iframe, index) => {
                        if (!iframe.id) {
                            // å°è¯•ä»srcæˆ–å…¶ä»–å±æ€§ç”Ÿæˆæ›´ç¨³å®šçš„ID
                            let stableId = '';
                            if (iframe.src) {
                                const urlParts = iframe.src.split('/');
                                const fileName = urlParts[urlParts.length - 1];
                                if (fileName && fileName.length > 3) {
                                    stableId = fileName.replace(/[^a-zA-Z0-9]/g, '').substring(0, 15);
                                }
                            }

                            // æ£€æŸ¥çˆ¶å®¹å™¨çš„ç±»åä»¥ç¡®å®šiframeç”¨é€”
                            const parentClass = iframe.parentElement?.className || '';
                            if (parentClass.includes('right-content')) {
                                stableId = 'main-content';
                            } else if (parentClass.includes('pending')) {
                                stableId = 'pending-frame';
                            } else if (parentClass.includes('collaboration')) {
                                stableId = 'collab-frame';
                            }

                            iframe.id = stableId ?
                                `mde-${stableId}-${index}` :
                                `mde-iframe-${prefix}${index}-${Date.now()}`;

                            console.log(`ä¸ºiframeåˆ†é…ID: ${iframe.id} (æ¥æº: ${stableId || 'default'})`);
                        }
                    });
                }

                assignIframeIds(document);

                // ç›‘å¬æ–°iframeçš„åŠ è½½ï¼Œä¸ºåŠ¨æ€åˆ›å»ºçš„iframeåˆ†é…ID
                const observer = new MutationObserver(mutations => {
                    mutations.forEach(mutation => {
                        mutation.addedNodes.forEach(node => {
                            if (node.tagName === 'IFRAME') {
                                if (!node.id) {
                                    node.id = `mde-iframe-dynamic-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                                }
                            } else if (node.querySelectorAll) {
                                assignIframeIds(node, 'nested-');
                            }
                        });
                    });
                });

                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });


            console.log('âœ… MDæå–å™¨åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('MDæå–å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            isInitialized = false;

            // é‡è¯•æœºåˆ¶
            setTimeout(() => {
                console.log('MDæå–å™¨: å°è¯•é‡æ–°åˆå§‹åŒ–...');
                initMarkdownExtractor();
            }, 1000);
        }
    }

    // =================================================================================
    // --- è°ƒè¯•å’ŒçŠ¶æ€æ£€æŸ¥ (Debug and Status Check) ---
    // =================================================================================
    function checkStatus() {
        console.log('=== MDæå–å™¨çŠ¶æ€æ£€æŸ¥ ===');
        console.log('åˆå§‹åŒ–çŠ¶æ€:', isInitialized);
        console.log('document.readyState:', document.readyState);
        console.log('document.body å­˜åœ¨:', !!document.body);

        const toolbar = document.getElementById(CONFIG.TOOLBAR_ID);
        console.log('å·¥å…·æ å­˜åœ¨:', !!toolbar);

        if (toolbar) {
            console.log('å·¥å…·æ å¯è§:', toolbar.offsetParent !== null);
            console.log('å·¥å…·æ æ ·å¼:', toolbar.style.cssText);
        }

        const styles = document.getElementById('md-extractor-styles');
        console.log('æ ·å¼è¡¨å­˜åœ¨:', !!styles);

        console.log('========================');
    }

    // æš´éœ²è°ƒè¯•å‡½æ•°åˆ°å…¨å±€
    window.MDExtractorDebug = {
        checkStatus,
        reinit: () => {
            isInitialized = false;
            init();
        },
        forceShow: () => {
            const toolbar = document.getElementById(CONFIG.TOOLBAR_ID);
            if (toolbar) {
                toolbar.style.display = 'block';
                toolbar.style.visibility = 'visible';
                toolbar.style.opacity = '1';
            }
        }
    };

    // å¯åŠ¨åˆå§‹åŒ– - ä½¿ç”¨å¤šç§æ–¹å¼ç¡®ä¿èƒ½å¤Ÿå¯åŠ¨
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // å¤‡ç”¨å¯åŠ¨æ–¹å¼
    setTimeout(() => {
        if (!isInitialized) {
            console.log('MDæå–å™¨: å¤‡ç”¨å¯åŠ¨æ–¹å¼...');
            init();
        }
    }, 1000);

    // æœ€åçš„ä¿é™©æªæ–½
    window.addEventListener('load', () => {
        if (!isInitialized) {
            console.log('MDæå–å™¨: window.load è§¦å‘å¯åŠ¨...');
            init();
        }
    });

    // å»¶è¿ŸçŠ¶æ€æ£€æŸ¥
    setTimeout(() => {
        checkStatus();
        if (!isInitialized) {
            console.warn('âš ï¸  MDæå–å™¨æœªèƒ½æ­£å¸¸åˆå§‹åŒ–ï¼Œè¯·åœ¨æ§åˆ¶å°è¿è¡Œ MDExtractorDebug.reinit() æ‰‹åŠ¨é‡æ–°åˆå§‹åŒ–');
        }
    }, 3000);

    // =================================================================================
    // --- UI åˆ›å»ºä¸æ ·å¼ (UI Creation & Styling) ---
    // =================================================================================
    function createFloatingToolbar() {
        try {
            console.log('å¼€å§‹åˆ›å»ºå·¥å…·æ HTMLç»“æ„');

            const toolbar = document.createElement('div');
            toolbar.id = CONFIG.TOOLBAR_ID;
            toolbar.innerHTML = `
                <div class="toolbar-header">
                    <span>ğŸ“ MDæå–å™¨ v${SCRIPT_VERSION}</span>
                    <button id="toggle-btn" title="æŠ˜å /å±•å¼€">ï¼</button>
                </div>
                <div class="toolbar-content">
                    <div class="main-controls">
                        <button id="element-picker-btn" class="btn-picker" title="ç‚¹å‡»åå¯åœ¨é¡µé¢ä¸Šé€‰å–è¦æå–çš„åŒºåŸŸ">ğŸ–±ï¸ é€‰æ‹©å…ƒç´ </button>
                        <button id="auto-detect-btn" class="btn-secondary" title="è‡ªåŠ¨å¯»æ‰¾é¡µé¢ä¸Šçš„ä¸»è¦å†…å®¹åŒºåŸŸ">ğŸ¯ æ™ºèƒ½æ£€æµ‹</button>
                    </div>
                    <div class="selector-group">
                        <label for="selector-input">CSS é€‰æ‹©å™¨:</label>
                        <input type="text" id="selector-input" placeholder="ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©æˆ–æ‰‹åŠ¨è¾“å…¥">
                    </div>
                    <div class="options-group">
                        <label><input type="checkbox" id="auto-expand" checked> è‡ªåŠ¨å±•å¼€</label>
                        <label><input type="checkbox" id="structured-mode" checked> ç»“æ„åŒ–</label>
                    </div>
                    <div class="action-buttons">
                         <button id="preview-btn">ğŸ‘€ é¢„è§ˆ</button>
                         <button id="extract-btn" class="btn-primary">ğŸ“‹ æå–å¤åˆ¶</button>
                    </div>
                    <div class="manual-actions">
                         <button id="export-html-btn" class="btn-secondary">ğŸ“„ å¯¼å‡ºHTML</button>
                         <button id="manual-copy-btn" class="btn-secondary">ğŸ“„ æ‰‹åŠ¨å¤åˆ¶</button>
                         <button id="iframe-analysis-btn" class="btn-secondary">ğŸ” iframeåˆ†æ</button>
                         <button id="batch-iframe-extract-btn" class="btn-secondary">ğŸ“¥ æ‰¹é‡æå–iframe</button>
                         <button id="direct-iframe-select-btn" class="btn-secondary">ğŸ¯ ç›´é€‰iframe</button>
                         <button id="ant-table-extract-btn" class="btn-secondary">ğŸœ Antè¡¨æ ¼</button>
                         <button id="about-btn" class="btn-secondary">â„¹ï¸ About</button>
                    </div>
                    <div id="status" class="status"></div>
                </div>
            `;

            console.log('åˆ›å»ºå·¥å…·æ HTMLç»“æ„å®Œæˆ');

            // ç¡®ä¿bodyå­˜åœ¨
            if (!document.body) {
                console.error('document.body ä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ å·¥å…·æ ');
                return;
            }

            document.body.appendChild(toolbar);
            console.log('å·¥å…·æ å·²æ·»åŠ åˆ°é¡µé¢');

            // éªŒè¯å·¥å…·æ æ˜¯å¦æˆåŠŸæ·»åŠ 
            const addedToolbar = document.getElementById(CONFIG.TOOLBAR_ID);
            if (addedToolbar) {
                console.log('âœ… å·¥å…·æ æ·»åŠ æˆåŠŸ');
                bindEvents();
                return true;
            } else {
                console.error('âŒ å·¥å…·æ æ·»åŠ å¤±è´¥');
                return false;
            }
        } catch (error) {
            console.error('åˆ›å»ºæ‚¬æµ®å·¥å…·æ æ—¶å‡ºé”™:', error);
            return false;
        }
    }

    function addCustomStyles() {
        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ ·å¼
        const existingStyle = document.getElementById('md-extractor-styles');
        if (existingStyle) {
            existingStyle.remove();
        }

        const style = document.createElement('style');
        style.id = 'md-extractor-styles';
        style.textContent = `
            #${CONFIG.TOOLBAR_ID} {
                position: fixed !important;
                top: 20px;
                right: 20px;
                width: 240px !important;
                background: #fff !important;
                border: 1px solid #e0e0e0 !important;
                border-radius: 6px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
                z-index: 999999 !important;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
                font-size: 12px !important;
                color: #333 !important;
            }
            #${CONFIG.TOOLBAR_ID} .toolbar-header {
                background: #f9f9f9 !important;
                border-bottom: 1px solid #e5e5e5 !important;
                color: #333 !important;
                padding: 8px 12px !important;
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                border-radius: 6px 6px 0 0 !important;
                cursor: move !important;
                font-weight: 500 !important;
                font-size: 11px !important;
            }
            #${CONFIG.TOOLBAR_ID} #toggle-btn {
                background: none !important;
                border: none !important;
                font-size: 14px !important;
                cursor: pointer !important;
                color: #888 !important;
                padding: 0 !important;
                width: 20px !important;
                height: 20px !important;
                line-height: 20px !important;
            }
            #${CONFIG.TOOLBAR_ID} .toolbar-content {
                padding: 10px !important;
            }
            #${CONFIG.TOOLBAR_ID} .toolbar-content.collapsed {
                display: none !important;
            }
            #${CONFIG.TOOLBAR_ID} .main-controls,
            #${CONFIG.TOOLBAR_ID} .action-buttons {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 6px !important;
                margin-bottom: 8px !important;
            }
            #${CONFIG.TOOLBAR_ID} .manual-actions {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 6px !important;
                margin-bottom: 8px !important;
            }
            #${CONFIG.TOOLBAR_ID} button {
                background-color: #fff !important;
                border: 1px solid #e0e0e0 !important;
                padding: 6px 8px !important;
                border-radius: 3px !important;
                cursor: pointer !important;
                font-weight: 400 !important;
                transition: all 0.15s !important;
                white-space: nowrap !important;
                color: #333 !important;
                font-size: 11px !important;
            }
            #${CONFIG.TOOLBAR_ID} button:hover {
                background-color: #f5f5f5 !important;
                border-color: #d0d0d0 !important;
            }
            #${CONFIG.TOOLBAR_ID} .btn-primary {
                background-color: #007bff !important;
                color: white !important;
                border-color: #007bff !important;
            }
            #${CONFIG.TOOLBAR_ID} .btn-primary:hover {
                background-color: #0069d9 !important;
                border-color: #0062cc !important;
            }
            #${CONFIG.TOOLBAR_ID} .btn-picker.picking {
                background-color: #dc3545 !important;
                color: white !important;
                border-color: #dc3545 !important;
            }
            #${CONFIG.TOOLBAR_ID} .btn-secondary {
                background-color: #6c757d !important;
                color: white !important;
                border-color: #6c757d !important;
            }
            #${CONFIG.TOOLBAR_ID} .btn-secondary:hover {
                background-color: #5a6268 !important;
                border-color: #545b62 !important;
            }
            #${CONFIG.TOOLBAR_ID} .selector-group {
                margin-bottom: 10px !important;
            }
            #${CONFIG.TOOLBAR_ID} label {
                font-size: 12px !important;
                color: #555 !important;
                margin-bottom: 5px !important;
                display: block !important;
            }
            #${CONFIG.TOOLBAR_ID} .options-group label {
                display: inline-flex !important;
                align-items: center !important;
                margin-right: 15px !important;
                font-weight: normal !important;
            }
            #${CONFIG.TOOLBAR_ID} input[type="text"] {
                width: 100% !important;
                padding: 6px !important;
                border: 1px solid #e0e0e0 !important;
                border-radius: 3px !important;
                box-sizing: border-box !important;
                font-family: 'SF Mono', 'Courier New', monospace !important;
                font-size: 11px !important;
                color: #333 !important;
            }
            #${CONFIG.TOOLBAR_ID} input[type="checkbox"] {
                margin-right: 5px !important;
            }
            #${CONFIG.TOOLBAR_ID} .status {
                padding: 6px !important;
                border-radius: 3px !important;
                font-size: 10px !important;
                text-align: center !important;
                min-height: 16px !important;
                margin-top: 6px !important;
            }
            #${CONFIG.TOOLBAR_ID} .status:empty {
                display: none !important;
            }
            #${CONFIG.TOOLBAR_ID} .status.success {
                background: #d4edda !important;
                color: #155724 !important;
            }
            #${CONFIG.TOOLBAR_ID} .status.error {
                background: #f8d7da !important;
                color: #721c24 !important;
            }
            #${CONFIG.TOOLBAR_ID} .status.info {
                background: #d1ecf1 !important;
                color: #0c5460 !important;
            }
            .${CONFIG.HIGHLIGHT_CLASS} {
                outline: 2px solid #dc3545 !important;
                background-color: rgba(220, 53, 69, 0.1) !important;
                transition: all 0.2s !important;
            }
            .${CONFIG.HOVER_HIGHLIGHT_CLASS} {
                outline: 2px dashed #007bff !important;
                background-color: rgba(0, 123, 255, 0.1) !important;
                cursor: crosshair !important;
            }
        `;
        document.head.appendChild(style);
    }

    // å¤„ç†æ¥è‡ªçˆ¶çª—å£çš„å†…å®¹è¯·æ±‚
    function handleContentRequest(event) {
        debugLog('å¤„ç†å†…å®¹è¯·æ±‚ï¼Œiframe ID:', event.data.iframeId);

        try {
            // æå–å½“å‰iframeçš„å†…å®¹
            const content = extractContentFromDocument(document);

            // å‘é€å†…å®¹å›çˆ¶çª—å£
            window.parent.postMessage({
                type: 'iframeContent',
                iframeId: event.data.iframeId,
                content: content,
                success: !!content
            }, '*');

            debugLog('å·²å‘é€å†…å®¹åˆ°çˆ¶çª—å£ï¼Œå†…å®¹é•¿åº¦:', content ? content.length : 0);

        } catch (error) {
            debugLog('å¤„ç†å†…å®¹è¯·æ±‚å¤±è´¥:', error.message);

            // å‘é€é”™è¯¯ä¿¡æ¯åˆ°çˆ¶çª—å£
            window.parent.postMessage({
                type: 'iframeContent',
                iframeId: event.data.iframeId,
                content: null,
                success: false,
                error: error.message
            }, '*');
        }
    }

    // This is the single, consolidated bindEvents function
    function bindEvents() {
        const toggleBtn = document.getElementById('toggle-btn');
        const elementPickerBtn = document.getElementById('element-picker-btn');
        const autoDetectBtn = document.getElementById('auto-detect-btn');
        const extractBtn = document.getElementById('extract-btn');
        const previewBtn = document.getElementById('preview-btn');
        const manualCopyBtn = document.getElementById('manual-copy-btn');
        const exportHtmlBtn = document.getElementById('export-html-btn');
        const iframeAnalysisBtn = document.getElementById('iframe-analysis-btn');
        const batchIframeExtractBtn = document.getElementById('batch-iframe-extract-btn');
        const directIframeSelectBtn = document.getElementById('direct-iframe-select-btn');
        const antTableExtractBtn = document.getElementById('ant-table-extract-btn');
        const aboutBtn = document.getElementById('about-btn');
        const selectorInput = document.getElementById('selector-input');

        if (toggleBtn) {
            toggleBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const content = document.querySelector(`#${CONFIG.TOOLBAR_ID} .toolbar-content`);
                if (content) {
                    content.classList.toggle('collapsed');
                    e.target.textContent = content.classList.contains('collapsed') ? 'ï¼‹' : 'ï¼';
                }
            });
        }

        if (elementPickerBtn) {
            console.log('[Element Picker] ç»‘å®šé€‰æ‹©å™¨æŒ‰é’®äº‹ä»¶');
            elementPickerBtn.addEventListener('click', (e) => {
                console.log('[Element Picker] é€‰æ‹©å™¨æŒ‰é’®è¢«ç‚¹å‡»');
                e.preventDefault();
                e.stopPropagation();
                togglePickingMode();
            });
        } else {
            console.warn('[Element Picker] æœªæ‰¾åˆ°é€‰æ‹©å™¨æŒ‰é’®');
        }

        if (autoDetectBtn) {
            autoDetectBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                autoDetectContent();
            });
        }

        if (extractBtn) {
            extractBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                extractAndCopy();
            });
        }

        if (previewBtn) {
            previewBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                previewContent();
            });
        }

        if (manualCopyBtn) {
            manualCopyBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                manualExtractAndCopy();
            });
        }

        if (exportHtmlBtn) {
            exportHtmlBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleExportHtml();
            });
        }

        if (iframeAnalysisBtn) {
            iframeAnalysisBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                performIframeAnalysis();
            });
        }

        if (batchIframeExtractBtn) {
            batchIframeExtractBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                performBatchIframeExtraction();
            });
        }

        if (directIframeSelectBtn) {
            directIframeSelectBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                directSelectIframe();
            });
        }

        if (antTableExtractBtn) {
            antTableExtractBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                extractAntTableDirectly();
            });
        }

        if (aboutBtn) {
            aboutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showAboutDialog();
            });
        }

        if (selectorInput) {
            // é˜²æŠ–çš„è¾“å…¥å¤„ç†
            let inputTimeout;
            selectorInput.addEventListener('input', (e) => {
                clearTimeout(inputTimeout);
                inputTimeout = setTimeout(() => {
                    const selector = e.target.value.trim();
                    if (selector) {
                        highlightElement(selector);
                    } else {
                        // æ¸…é™¤é«˜äº®
                        document.querySelectorAll(`.${CONFIG.HIGHLIGHT_CLASS}`).forEach(el => {
                            el.classList.remove(CONFIG.HIGHLIGHT_CLASS);
                        });
                    }
                }, 500); // 500msé˜²æŠ–
            });

            // å›è½¦é”®ç›´æ¥æå–
            selectorInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    extractAndCopy();
                }
            });
        }

        makeDraggable();
    }


    // =================================================================================
    // --- å¯è§†åŒ–é€‰æ‹©æ ¸å¿ƒ (Visual Picker Core) ---
    // =================================================================================
    function togglePickingMode() {
        console.log('[Element Picker] togglePickingMode è¢«è°ƒç”¨ï¼Œå½“å‰æ¨¡å¼:', isPickingMode);
        if (isPickingMode) {
            exitPickingMode();
        } else {
            enterPickingMode();
        }
    }

    function enterPickingMode() {
        console.log('[Element Picker] è¿›å…¥é€‰æ‹©æ¨¡å¼');
        isPickingMode = true;

        if (isTopWindow) {
            document.body.addEventListener('mouseover', handleMouseOver, true);
            document.body.addEventListener('click', handleMouseClick, true);
            document.addEventListener('keydown', handleKeyDown, true);

            // é€šçŸ¥æ‰€æœ‰ iframe è¿›å…¥é€‰æ‹©æ¨¡å¼ï¼ˆçº§è”ä¼ é€’ï¼‰
            const iframes = document.querySelectorAll('iframe');
            debugLog(`å‘ç°${iframes.length}ä¸ªiframeï¼Œå¼€å§‹å‘é€enterPickingModeæ¶ˆæ¯`);

            iframes.forEach((iframe, index) => {
                const iframeId = iframe.id || `iframe-${index}`;
                const iframeSrc = iframe.src || 'about:blank';

                // æ£€æŸ¥æ˜¯å¦æ˜¯åŒæºiframe
                let isSameOrigin = false;
                try {
                    const iframeDoc = iframe.contentDocument;
                    isSameOrigin = !!iframeDoc;
                } catch (e) {
                    isSameOrigin = false;
                }

                debugLog(`å¤„ç†iframe: ${iframeId}, åŒæº: ${isSameOrigin}, src: ${iframeSrc}`);

                try {
                    // å°è¯•å‘é€æ¶ˆæ¯
                    iframe.contentWindow.postMessage({ type: 'enterPickingMode' }, '*');
                    debugLog(`âœ… å·²é€šçŸ¥iframe ${iframeId} è¿›å…¥é€‰æ‹©æ¨¡å¼`);

                    // ä¸ºiframeæ·»åŠ å¯è§†åŒ–è¾¹æ¡†
                    iframe.style.border = '2px dashed #007bff';
                    iframe.style.boxShadow = '0 0 10px rgba(0, 123, 255, 0.3)';
                    iframe.classList.add('md-extractor-iframe-active');

                    // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ç‰¹å®šçš„iframeï¼ˆå¦‚mainIframeï¼‰ï¼Œæ·»åŠ é¢å¤–æ ‡è®°
                    if (iframeId === 'mainIframe' || iframeId.includes('main')) {
                        iframe.setAttribute('data-md-main-iframe', 'true');
                        debugLog(`æ ‡è®°ä¸»iframe: ${iframeId}`);
                    }

                } catch (e) {
                    debugLog(`âŒ æ— æ³•å‘iframe ${iframeId} å‘é€æ¶ˆæ¯:`, e.message);

                    // è·¨åŸŸiframeçš„å¤‡ç”¨å¤„ç†
                    iframe.style.border = '2px dashed #ffc107';
                    iframe.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.3)';
                    iframe.classList.add('md-extractor-iframe-cross-origin');

                    // å¦‚æœæ˜¯è·¨åŸŸiframeï¼Œå°è¯•é€šè¿‡å…¶ä»–æ–¹å¼æ¿€æ´»é€‰æ‹©åŠŸèƒ½
                    handleCrossOriginIframe(iframe, iframeId);
                }
            });

            const pickerBtn = document.getElementById('element-picker-btn');
            if (pickerBtn) {
                pickerBtn.classList.add('picking');
                pickerBtn.textContent = 'âŒ å–æ¶ˆé€‰æ‹©';
            }
            const iframeCount = iframes.length;
            if (iframeCount > 0) {
                showStatus(`è¿›å…¥é€‰æ‹©æ¨¡å¼ï¼šå·²æ¿€æ´»${iframeCount}ä¸ªiframeçš„é€‰æ‹©åŠŸèƒ½ã€‚è¯·ç‚¹å‡»ä»»æ„åŒºåŸŸé€‰æ‹©å…ƒç´ ã€‚æŒ‰ ESC å–æ¶ˆã€‚`, 'info');
            } else {
                showStatus('è¿›å…¥é€‰æ‹©æ¨¡å¼ï¼šè¯·ç‚¹å‡»æ‚¨æƒ³æå–çš„åŒºåŸŸã€‚æŒ‰ ESC å–æ¶ˆã€‚', 'info');
            }
        } else {
            // åœ¨ iframe ä¸­
            document.body.addEventListener('mouseover', handleMouseOver, true);
            document.body.addEventListener('click', handleMouseClick, true);
            document.addEventListener('keydown', handleKeyDown, true);
        }
    }

    // å¤„ç†è·¨åŸŸiframeçš„å¤‡ç”¨æ–¹æ¡ˆ
    function handleCrossOriginIframe(iframe, iframeId) {
        debugLog(`å¤„ç†è·¨åŸŸiframe: ${iframeId}`);

        // æ–¹æ¡ˆ1: å°è¯•å»¶è¿Ÿé‡è¯•å‘é€æ¶ˆæ¯
        setTimeout(() => {
            try {
                iframe.contentWindow.postMessage({ type: 'enterPickingMode' }, '*');
                debugLog(`å»¶è¿Ÿé‡è¯•æˆåŠŸ: ${iframeId}`);

                // æ›´æ–°è¾¹æ¡†é¢œè‰²è¡¨ç¤ºæˆåŠŸ
                iframe.style.border = '2px dashed #28a745';
                iframe.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.3)';
                iframe.classList.remove('md-extractor-iframe-cross-origin');
                iframe.classList.add('md-extractor-iframe-active');

            } catch (e) {
                debugLog(`å»¶è¿Ÿé‡è¯•å¤±è´¥: ${iframeId}`, e.message);

                // æ–¹æ¡ˆ2: æ·»åŠ ç‚¹å‡»ç›‘å¬å™¨åˆ°iframeæœ¬èº«
                addIframeClickListener(iframe, iframeId);
            }
        }, 500);
    }

    // ä¸ºæ— æ³•é€šä¿¡çš„iframeæ·»åŠ ç‚¹å‡»ç›‘å¬å™¨
    function addIframeClickListener(iframe, iframeId) {
        debugLog(`ä¸ºiframeæ·»åŠ ç‚¹å‡»ç›‘å¬å™¨: ${iframeId}`);

        // åœ¨iframeä¸Šè¦†ç›–ä¸€ä¸ªé€æ˜å±‚ï¼Œç”¨äºæ•è·ç‚¹å‡»äº‹ä»¶
        const overlay = document.createElement('div');
        overlay.id = `md-iframe-overlay-${iframeId}`;
        overlay.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 123, 255, 0.1);
            z-index: 10000;
            cursor: crosshair;
            pointer-events: all;
        `;

        overlay.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            debugLog(`æ£€æµ‹åˆ°iframeç‚¹å‡»: ${iframeId}`);

            // ç§»é™¤overlayå¹¶é€€å‡ºé€‰æ‹©æ¨¡å¼
            overlay.remove();
            exitPickingMode();

            // å°è¯•æå–iframeå†…å®¹
            extractIframeContent(iframe, iframeId);
        });

        // è®¾ç½®iframeå®¹å™¨çš„ç›¸å¯¹å®šä½
        const iframeContainer = iframe.parentElement;
        if (iframeContainer && getComputedStyle(iframeContainer).position === 'static') {
            iframeContainer.style.position = 'relative';
        }

        // å°†overlayæ·»åŠ åˆ°iframeçš„çˆ¶å…ƒç´ ä¸­
        if (iframe.parentElement) {
            iframe.parentElement.appendChild(overlay);
            debugLog(`å·²ä¸ºiframe ${iframeId} æ·»åŠ ç‚¹å‡»è¦†ç›–å±‚`);
        }
    }

    // æå–iframeå†…å®¹çš„æ ¸å¿ƒå‡½æ•°
    async function extractIframeContent(iframe, iframeId) {
        debugLog(`å¼€å§‹æå–iframeå†…å®¹: ${iframeId}`);
        showStatus('æ­£åœ¨å°è¯•æå–iframeå†…å®¹...', 'info');

        try {
            // æ–¹æ³•1: å°è¯•ç›´æ¥è®¿é—®iframeå†…å®¹ï¼ˆåŒæºï¼‰
            if (await tryDirectAccess(iframe, iframeId)) {
                return;
            }

            // æ–¹æ³•2: å°è¯•é€šè¿‡æ¶ˆæ¯é€šä¿¡è·å–å†…å®¹
            if (await tryMessageCommunication(iframe, iframeId)) {
                return;
            }

            // æ–¹æ³•3: å°è¯•ä»iframeæºURLè·å–å†…å®¹
            if (await tryUrlFetch(iframe, iframeId)) {
                return;
            }

            // æ–¹æ³•4: å¤‡ç”¨æ–¹æ¡ˆ - æä¾›æ‰‹åŠ¨æŒ‡å¯¼
            provideFallbackGuidance(iframe, iframeId);

        } catch (error) {
            debugLog('iframeå†…å®¹æå–å¤±è´¥:', error);
            showStatus('iframeå†…å®¹æå–å¤±è´¥ï¼Œè¯·å°è¯•ç›´æ¥åœ¨iframeå†…ä½¿ç”¨è„šæœ¬', 'error');
        }
    }

    // æ–¹æ³•1: ç›´æ¥è®¿é—®ï¼ˆåŒæºiframeï¼‰
    async function tryDirectAccess(iframe, iframeId) {
        try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (iframeDoc) {
                debugLog('æˆåŠŸç›´æ¥è®¿é—®iframeæ–‡æ¡£');

                // ç›´æ¥åœ¨iframeæ–‡æ¡£ä¸­æŸ¥æ‰¾å†…å®¹
                const content = extractContentFromDocument(iframeDoc);
                if (content) {
                    await copyToClipboard(content);
                    showStatus(`âœ… å·²ä»iframe "${iframeId}" æå–å†…å®¹åˆ°å‰ªè´´æ¿`, 'success');
                    return true;
                }
            }
        } catch (e) {
            debugLog('ç›´æ¥è®¿é—®å¤±è´¥:', e.message);
        }
        return false;
    }

    // æ–¹æ³•2: æ¶ˆæ¯é€šä¿¡
    async function tryMessageCommunication(iframe, iframeId) {
        return new Promise((resolve) => {
            debugLog('å°è¯•é€šè¿‡æ¶ˆæ¯é€šä¿¡è·å–å†…å®¹');

            const timeout = setTimeout(() => {
                debugLog('æ¶ˆæ¯é€šä¿¡è¶…æ—¶');
                resolve(false);
            }, 3000);

            // ç›‘å¬iframeå“åº”
            const messageHandler = (event) => {
                if (event.data.type === 'iframeContent' && event.data.iframeId === iframeId) {
                    clearTimeout(timeout);
                    window.removeEventListener('message', messageHandler);

                    if (event.data.content) {
                        copyToClipboard(event.data.content);
                        showStatus(`âœ… å·²é€šè¿‡é€šä¿¡ä»iframe "${iframeId}" è·å–å†…å®¹`, 'success');
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                }
            };

            window.addEventListener('message', messageHandler);

            // è¯·æ±‚iframeå‘é€å†…å®¹
            try {
                iframe.contentWindow.postMessage({
                    type: 'requestContent',
                    iframeId: iframeId
                }, '*');
            } catch (e) {
                clearTimeout(timeout);
                window.removeEventListener('message', messageHandler);
                resolve(false);
            }
        });
    }

    // æ–¹æ³•3: URLè·å–
    async function tryUrlFetch(iframe, iframeId) {
        try {
            const iframeSrc = iframe.src;
            if (!iframeSrc || iframeSrc === 'about:blank') {
                return false;
            }

            debugLog('å°è¯•ä»URLè·å–å†…å®¹:', iframeSrc);

            // æ£€æŸ¥æ˜¯å¦åŒæº
            const currentOrigin = window.location.origin;
            const iframeUrl = new URL(iframeSrc, window.location.href);

            if (iframeUrl.origin === currentOrigin) {
                const response = await fetch(iframeSrc);
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    const content = extractContentFromDocument(doc);
                    if (content) {
                        await copyToClipboard(content);
                        showStatus(`âœ… å·²ä»URLè·å–iframe "${iframeId}" å†…å®¹`, 'success');
                        return true;
                    }
                }
            }
        } catch (e) {
            debugLog('URLè·å–å¤±è´¥:', e.message);
        }
        return false;
    }

    // æ–¹æ³•4: å¤‡ç”¨æŒ‡å¯¼
    function provideFallbackGuidance(iframe, iframeId) {
        debugLog('æä¾›æ™ºèƒ½å¤‡ç”¨æŒ‡å¯¼æ–¹æ¡ˆ');

        // åˆ†æiframeç‰¹å¾ï¼Œæä¾›é’ˆå¯¹æ€§å»ºè®®
        const analysis = analyzeIframeForGuidance(iframe, iframeId);

        // åˆ›å»ºå¢å¼ºçš„æŒ‡å¯¼å¼¹çª—
        const modal = createEnhancedGuidanceModal(analysis, iframe);
        document.body.appendChild(modal);

        showStatus(`iframe "${iframeId}" éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼Œå·²æ˜¾ç¤ºæ™ºèƒ½æ“ä½œæŒ‡å—`, 'info');
    }

    // åˆ†æiframeç‰¹å¾ï¼Œç”Ÿæˆé’ˆå¯¹æ€§æŒ‡å¯¼
    function analyzeIframeForGuidance(iframe, iframeId) {
        const analysis = {
            id: iframeId,
            src: iframe.src || 'about:blank',
            dimensions: {
                width: iframe.offsetWidth,
                height: iframe.offsetHeight,
                visible: iframe.offsetParent !== null
            },
            srcAnalysis: null,
            recommendations: [],
            urgency: 'medium'
        };

        // åˆ†æsrc URL
        if (iframe.src) {
            try {
                const url = new URL(iframe.src, window.location.href);
                analysis.srcAnalysis = {
                    origin: url.origin,
                    isSameOrigin: url.origin === window.location.origin,
                    protocol: url.protocol,
                    hostname: url.hostname,
                    pathname: url.pathname,
                    isDataUrl: url.protocol === 'data:',
                    isBlobUrl: url.protocol === 'blob:'
                };

                // åŸºäºURLç‰¹å¾ç”Ÿæˆå»ºè®®
                if (analysis.srcAnalysis.isSameOrigin) {
                    analysis.recommendations.push('ğŸ”„ åŒæºiframeï¼Œå»ºè®®è”ç³»æŠ€æœ¯äººå‘˜æ£€æŸ¥iframeåŠ è½½çŠ¶æ€');
                    analysis.urgency = 'high';
                } else {
                    analysis.recommendations.push('ğŸŒ è·¨åŸŸiframeï¼Œè¿™æ˜¯æœ€å¸¸è§çš„æƒ…å†µ');
                    analysis.recommendations.push('ğŸ“‚ å»ºè®®åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€URLè¿›è¡Œå†…å®¹æå–');
                }

                if (analysis.srcAnalysis.isDataUrl) {
                    analysis.recommendations.push('ğŸ“„ æ•°æ®URL iframeï¼Œå†…å®¹å·²åµŒå…¥åœ¨URLä¸­');
                    analysis.urgency = 'low';
                } else if (analysis.srcAnalysis.isBlobUrl) {
                    analysis.recommendations.push('ğŸ’¾ Blob URL iframeï¼Œå†…å®¹å¯èƒ½æ˜¯åŠ¨æ€ç”Ÿæˆçš„');
                }

                // æ£€æŸ¥å¸¸è§çš„ç³»ç»Ÿç±»å‹
                if (url.hostname.includes('sharepoint') || url.hostname.includes('office365')) {
                    analysis.recommendations.push('ğŸ¢ æ£€æµ‹åˆ°SharePoint/Office365ï¼Œå»ºè®®ä½¿ç”¨å®˜æ–¹å¯¼å‡ºåŠŸèƒ½');
                } else if (url.hostname.includes('google') && url.pathname.includes('docs')) {
                    analysis.recommendations.push('ğŸ“ æ£€æµ‹åˆ°Google Docsï¼Œå»ºè®®ä½¿ç”¨"æ–‡ä»¶â†’ä¸‹è½½"åŠŸèƒ½');
                }

            } catch (e) {
                analysis.recommendations.push('â“ URLè§£æå¤±è´¥ï¼Œå¯èƒ½æ˜¯ç›¸å¯¹è·¯å¾„æˆ–ç‰¹æ®Šæ ¼å¼');
            }
        } else {
            analysis.recommendations.push('ğŸš« iframeæ²¡æœ‰srcå±æ€§ï¼Œå¯èƒ½æ˜¯åŠ¨æ€åŠ è½½æˆ–ç©ºiframe');
            analysis.urgency = 'low';
        }

        // åŸºäºå°ºå¯¸åˆ†æ
        if (!analysis.dimensions.visible) {
            analysis.recommendations.push('ğŸ‘ï¸ iframeä¸å¯è§ï¼Œå¯èƒ½æ˜¯éšè—å…ƒç´ ');
        } else if (analysis.dimensions.width < 100 || analysis.dimensions.height < 100) {
            analysis.recommendations.push('ğŸ“ iframeå°ºå¯¸å¾ˆå°ï¼Œå¯èƒ½ä¸åŒ…å«ä¸»è¦å†…å®¹');
        }

        return analysis;
    }

    // åˆ›å»ºæŒ‡å¯¼å¼¹çª—
    function createGuidanceModal(guidance, iframe) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            z-index: 10001;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        `;

        modal.innerHTML = `
            <h3>ğŸ“‹ iframeå†…å®¹æå–æŒ‡å—</h3>
            <pre style="white-space: pre-wrap; font-size: 12px; background: #f5f5f5; padding: 10px; border-radius: 4px;">${guidance}</pre>
            <div style="margin-top: 15px; text-align: right;">
                <button id="open-iframe-btn" style="margin-right: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">åœ¨æ–°é¡µé¢æ‰“å¼€</button>
                <button id="close-guidance-btn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">å…³é—­</button>
            </div>
        `;

        // ç»‘å®šäº‹ä»¶
        modal.querySelector('#close-guidance-btn').onclick = () => modal.remove();
        modal.querySelector('#open-iframe-btn').onclick = () => {
            if (iframe.src) {
                window.open(iframe.src, '_blank');
            }
            modal.remove();
        };

        return modal;
    }

    // åˆ›å»ºå¢å¼ºçš„æŒ‡å¯¼å¼¹çª—
    function createEnhancedGuidanceModal(analysis, iframe) {
        const modal = document.createElement('div');
        modal.setAttribute('data-md-extractor-ui', 'true');
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid ${analysis.urgency === 'high' ? '#dc3545' : analysis.urgency === 'low' ? '#28a745' : '#007bff'};
            border-radius: 12px;
            padding: 0;
            z-index: 10001;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        `;

        const urgencyColor = analysis.urgency === 'high' ? '#dc3545' :
                           analysis.urgency === 'low' ? '#28a745' : '#007bff';
        const urgencyText = analysis.urgency === 'high' ? 'é«˜ä¼˜å…ˆçº§' :
                           analysis.urgency === 'low' ? 'ä½ä¼˜å…ˆçº§' : 'ä¸­ç­‰ä¼˜å…ˆçº§';

        modal.innerHTML = `
            <div style="background: ${urgencyColor}; color: white; padding: 16px 20px; border-radius: 10px 10px 0 0;">
                <h3 style="margin: 0; font-size: 18px; display: flex; align-items: center;">
                    ğŸ” iframeæ™ºèƒ½åˆ†ææŠ¥å‘Š
                    <span style="margin-left: auto; font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px;">${urgencyText}</span>
                </h3>
            </div>

            <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; color: #333;">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h4>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 13px;">
                        <div><strong>ID:</strong> ${analysis.id}</div>
                        <div><strong>URL:</strong> <span style="word-break: break-all;">${analysis.src}</span></div>
                        <div><strong>å°ºå¯¸:</strong> ${analysis.dimensions.width}Ã—${analysis.dimensions.height}px ${analysis.dimensions.visible ? '(å¯è§)' : '(éšè—)'}</div>
                        ${analysis.srcAnalysis ? `
                        <div><strong>æ¥æº:</strong> ${analysis.srcAnalysis.hostname}</div>
                        <div><strong>ç±»å‹:</strong> ${analysis.srcAnalysis.isSameOrigin ? 'åŒæº' : 'è·¨åŸŸ'}</div>
                        ` : ''}
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; color: #333;">ğŸ’¡ æ™ºèƒ½å»ºè®®</h4>
                    <div style="background: #e8f5e8; padding: 12px; border-radius: 6px;">
                        ${analysis.recommendations.map(rec => `<div style="margin-bottom: 6px; font-size: 13px;">â€¢ ${rec}</div>`).join('')}
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; color: #333;">ğŸ› ï¸ æ¨èæ“ä½œ</h4>
                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; font-size: 13px;">
                        ${generateActionSteps(analysis)}
                    </div>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 16px 20px; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 12px; color: #6c757d;">
                    ${analysis.srcAnalysis && analysis.srcAnalysis.isSameOrigin ? 'âš ï¸ åŒæºiframeå»ºè®®æŠ€æœ¯æ£€æŸ¥' : 'ğŸŒ è·¨åŸŸiframeéœ€è¦æ–°æ ‡ç­¾é¡µå¤„ç†'}
                </div>
                <div>
                    ${iframe.src ? '<button id="open-iframe-btn" style="margin-right: 8px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">ğŸ”— æ–°æ ‡ç­¾é¡µæ‰“å¼€</button>' : ''}
                    <button id="copy-url-btn" style="margin-right: 8px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">ğŸ“‹ å¤åˆ¶URL</button>
                    <button id="close-guidance-btn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">å…³é—­</button>
                </div>
            </div>
        `;

        // ç»‘å®šäº‹ä»¶
        modal.querySelector('#close-guidance-btn').onclick = () => modal.remove();

        const openBtn = modal.querySelector('#open-iframe-btn');
        if (openBtn) {
            openBtn.onclick = () => {
                if (iframe.src) {
                    window.open(iframe.src, '_blank');
                    showStatus('å·²åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€iframe', 'success');
                }
                modal.remove();
            };
        }

        const copyBtn = modal.querySelector('#copy-url-btn');
        if (copyBtn) {
            copyBtn.onclick = () => {
                if (iframe.src) {
                    navigator.clipboard.writeText(iframe.src).then(() => {
                        showStatus('URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                        copyBtn.textContent = 'âœ… å·²å¤åˆ¶';
                        setTimeout(() => {
                            copyBtn.textContent = 'ğŸ“‹ å¤åˆ¶URL';
                        }, 2000);
                    }).catch(() => {
                        showStatus('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                    });
                }
            };
        }

        return modal;
    }

    // ç”Ÿæˆæ“ä½œæ­¥éª¤
    function generateActionSteps(analysis) {
        let steps = [];

        if (analysis.srcAnalysis && !analysis.srcAnalysis.isSameOrigin) {
            steps.push('1. å³é”®ç‚¹å‡»iframeï¼Œé€‰æ‹©"åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€"');
            steps.push('2. åœ¨æ–°é¡µé¢ä¸­å®‰è£…å¹¶ä½¿ç”¨æ­¤Markdownæå–è„šæœ¬');
            steps.push('3. ä½¿ç”¨è„šæœ¬çš„"é€‰æ‹©å…ƒç´ "åŠŸèƒ½æå–éœ€è¦çš„å†…å®¹');
        } else if (analysis.srcAnalysis && analysis.srcAnalysis.isSameOrigin) {
            steps.push('1. æ£€æŸ¥iframeæ˜¯å¦å®Œå…¨åŠ è½½');
            steps.push('2. å°è¯•åˆ·æ–°é¡µé¢åé‡æ–°æå–');
            steps.push('3. è”ç³»æŠ€æœ¯äººå‘˜æ£€æŸ¥iframeé…ç½®');
        } else {
            steps.push('1. æ£€æŸ¥iframeæ˜¯å¦åŒ…å«æœ‰æ•ˆå†…å®¹');
            steps.push('2. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯');
            steps.push('3. å°è¯•åˆ·æ–°é¡µé¢');
        }

        // æ·»åŠ é€šç”¨å»ºè®®
        if (analysis.srcAnalysis && analysis.srcAnalysis.hostname) {
            if (analysis.srcAnalysis.hostname.includes('sharepoint')) {
                steps.push('4. æˆ–ä½¿ç”¨SharePointçš„"å¯¼å‡ºåˆ°Excel"åŠŸèƒ½');
            } else if (analysis.srcAnalysis.hostname.includes('google')) {
                steps.push('4. æˆ–ä½¿ç”¨Google Docsçš„"ä¸‹è½½"åŠŸèƒ½');
            }
        }

        return steps.map(step => `<div style="margin-bottom: 4px;">${step}</div>`).join('');
    }

    // ç›´æ¥é€‰æ‹©iframeåŠŸèƒ½
    async function directSelectIframe() {
        const iframes = document.querySelectorAll('iframe');

        if (iframes.length === 0) {
            showStatus('é¡µé¢ä¸­æ²¡æœ‰å‘ç°iframe', 'error');
            return;
        }

        if (iframes.length === 1) {
            // åªæœ‰ä¸€ä¸ªiframeï¼Œç›´æ¥é€‰æ‹©
            const iframe = iframes[0];
            const iframeId = iframe.id || 'iframe-0';
            showStatus(`å‘ç°1ä¸ªiframeï¼Œæ­£åœ¨å°è¯•æå–å†…å®¹...`, 'info');

            // è®¾ç½®é€‰æ‹©å™¨ä¸ºiframe
            const selectorInput = document.getElementById('selector-input');
            if (selectorInput) {
                selectorInput.value = `iframe${iframe.id ? '#' + iframe.id : ''}`;
            }

            // è®¾ç½®é€‰æ‹©ä¸Šä¸‹æ–‡
            selectionContext = {
                source: 'top',
                selector: `iframe${iframe.id ? '#' + iframe.id : ''}`,
                iframeId: null
            };

            // é«˜äº®æ˜¾ç¤ºiframe
            highlightIframe(iframe);

            // å°è¯•æå–å†…å®¹
            await extractIframeContent(iframe, iframeId);

        } else {
            // å¤šä¸ªiframeï¼Œæ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
            showIframeSelectionDialog(iframes);
        }
    }

    // æ˜¾ç¤ºiframeé€‰æ‹©å¯¹è¯æ¡†
    function showIframeSelectionDialog(iframes) {
        const modal = document.createElement('div');
        modal.setAttribute('data-md-extractor-ui', 'true');
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #007bff;
            border-radius: 12px;
            padding: 0;
            z-index: 10001;
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        `;

        let iframeListHtml = '';
        iframes.forEach((iframe, index) => {
            const id = iframe.id || `iframe-${index}`;
            const src = iframe.src || 'about:blank';
            const width = iframe.offsetWidth;
            const height = iframe.offsetHeight;
            const visible = iframe.offsetParent !== null;

            iframeListHtml += `
                <div style="border: 1px solid #dee2e6; border-radius: 6px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;"
                     data-iframe-index="${index}" class="iframe-option"
                     onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                    <div style="font-weight: bold; color: #007bff; margin-bottom: 4px;">ğŸ“± ${id}</div>
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 4px; word-break: break-all;">
                        ğŸŒ ${src.length > 60 ? src.substring(0, 60) + '...' : src}
                    </div>
                    <div style="font-size: 12px; color: #6c757d;">
                        ğŸ“ ${width}Ã—${height}px ${visible ? 'âœ… å¯è§' : 'âŒ éšè—'}
                    </div>
                </div>
            `;
        });

        modal.innerHTML = `
            <div style="background: #007bff; color: white; padding: 16px 20px; border-radius: 10px 10px 0 0;">
                <h3 style="margin: 0; font-size: 18px;">ğŸ¯ é€‰æ‹©è¦æå–çš„iframe</h3>
            </div>

            <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                <div style="margin-bottom: 16px; color: #666; font-size: 14px;">
                    æ£€æµ‹åˆ°${iframes.length}ä¸ªiframeï¼Œè¯·é€‰æ‹©è¦æå–å†…å®¹çš„iframeï¼š
                </div>
                ${iframeListHtml}
            </div>

            <div style="background: #f8f9fa; padding: 16px 20px; border-top: 1px solid #dee2e6; text-align: right;">
                <button id="cancel-iframe-select" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">å–æ¶ˆ</button>
            </div>
        `;

        // ç»‘å®šäº‹ä»¶
        modal.querySelector('#cancel-iframe-select').onclick = () => modal.remove();

        // ä¸ºæ¯ä¸ªiframeé€‰é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶
        modal.querySelectorAll('.iframe-option').forEach(option => {
            option.onclick = () => {
                const index = parseInt(option.dataset.iframeIndex);
                const iframe = iframes[index];

                modal.remove();

                // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€iframe
                if (iframe.src) {
                    window.open(iframe.src, '_blank');
                } else {
                    showStatus('iframeæ²¡æœ‰æœ‰æ•ˆçš„srcåœ°å€', 'error');
                }
            };
        });

        document.body.appendChild(modal);
    }

    // é«˜äº®æ˜¾ç¤ºiframe
    function highlightIframe(iframe) {
        // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
        document.querySelectorAll('.md-extractor-iframe-selected').forEach(el => {
            el.classList.remove('md-extractor-iframe-selected');
            el.style.border = '';
            el.style.boxShadow = '';
        });

        // é«˜äº®å½“å‰iframe
        iframe.classList.add('md-extractor-iframe-selected');
        iframe.style.border = '3px solid #28a745';
        iframe.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.5)';

        // 3ç§’åæ¸…é™¤é«˜äº®
        setTimeout(() => {
            iframe.style.border = '';
            iframe.style.boxShadow = '';
            iframe.classList.remove('md-extractor-iframe-selected');
        }, 3000);
    }

    // ç›´æ¥æå–Ant Designè¡¨æ ¼
    async function extractAntTableDirectly(selectedElement = null) {
        showStatus('æ­£åœ¨æœç´¢Ant Designè¡¨æ ¼...', 'info');

        try {
            // ä¼˜å…ˆåœ¨ç”¨æˆ·é€‰æ‹©çš„å®¹å™¨å†…æœç´¢ï¼Œé¿å…é‡å¤è¯†åˆ«
            let tables = [];
            let sourceContext = '';

            if (selectedElement) {
                debugLog(`ç”¨æˆ·é€‰æ‹©äº†å®¹å™¨: ${selectedElement.tagName}.${selectedElement.className}`);
                tables = findAntTables(document, selectedElement);
                sourceContext = `é€‰æ‹©çš„å®¹å™¨(${selectedElement.tagName}.${selectedElement.className})`;
            } else {
                // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·å½“å‰é€‰æ‹©çš„å…ƒç´ 
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const commonAncestor = range.commonAncestorContainer;
                    const selectedContainer = commonAncestor.nodeType === Node.ELEMENT_NODE ?
                                            commonAncestor : commonAncestor.parentElement;

                    if (selectedContainer && selectedContainer !== document.body) {
                        debugLog(`æ£€æµ‹åˆ°ç”¨æˆ·é€‰æ‹©: ${selectedContainer.tagName}.${selectedContainer.className}`);
                        tables = findAntTables(document, selectedContainer);
                        sourceContext = `é€‰æ‹©çš„åŒºåŸŸ(${selectedContainer.tagName}.${selectedContainer.className})`;
                    }
                }

                // å¦‚æœæ²¡æœ‰é€‰æ‹©æˆ–é€‰æ‹©çš„å®¹å™¨å†…æ²¡æœ‰è¡¨æ ¼ï¼Œåˆ™æœç´¢æ•´ä¸ªé¡µé¢
                if (tables.length === 0) {
                    tables = findAntTables(document);
                    sourceContext = 'å½“å‰é¡µé¢';
                }
            }

            // å¦‚æœå½“å‰é¡µé¢æ²¡æ‰¾åˆ°ï¼Œæœç´¢iframe
            if (tables.length === 0) {
                const iframes = document.querySelectorAll('iframe');
                for (let iframe of iframes) {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc) {
                            const iframeTables = findAntTables(iframeDoc);
                            if (iframeTables.length > 0) {
                                tables = iframeTables;
                                sourceContext = `iframe: ${iframe.id || 'unnamed'}`;
                                break;
                            }
                        }
                    } catch (e) {
                        debugLog(`æ— æ³•è®¿é—®iframe: ${iframe.id}`, e.message);
                    }
                }
            }

            if (tables.length === 0) {
                showStatus('æœªå‘ç°Ant Designè¡¨æ ¼ç»“æ„', 'error');

                // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                showAntTableDebugInfo();
                return;
            }

            showStatus(`åœ¨${sourceContext}å‘ç°${tables.length}ä¸ªAntè¡¨æ ¼ï¼Œå¼€å§‹æå–...`, 'info');

            if (tables.length === 1) {
                // ç›´æ¥æå–å•ä¸ªè¡¨æ ¼
                const result = await extractSingleAntTable(tables[0], sourceContext);
                if (result) {
                    openPreviewWindow(result, `Antè¡¨æ ¼å†…å®¹ - ${sourceContext}`);
                    showStatus('Antè¡¨æ ¼æå–å®Œæˆï¼', 'success');
                }
            } else {
                // å¤šä¸ªè¡¨æ ¼ï¼Œè®©ç”¨æˆ·é€‰æ‹©
                showAntTableSelectionDialog(tables, sourceContext);
            }

        } catch (error) {
            showStatus(`Antè¡¨æ ¼æå–å¤±è´¥: ${error.message}`, 'error');
            console.error('Antè¡¨æ ¼æå–é”™è¯¯:', error);
        }
    }

    // æŸ¥æ‰¾æ‰€æœ‰ç±»å‹çš„è¡¨æ ¼ï¼ˆä¼˜å…ˆå¤„ç†HUIï¼Œé¿å…é‡å¤ï¼‰
    function findAntTables(doc, containerElement = null) {
        const tables = [];
        const processedElements = new Set(); // è·Ÿè¸ªæ‰€æœ‰å·²å¤„ç†çš„å…ƒç´ 

        const searchScope = containerElement || doc;
        const scopeDesc = containerElement ? `å®¹å™¨(${containerElement.tagName}.${containerElement.className})` : 'document';
        debugLog(`=== å¼€å§‹è¡¨æ ¼æŸ¥æ‰¾ (èŒƒå›´: ${scopeDesc}) ===`);

        // ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨æ›´ç²¾ç¡®çš„ç­–ç•¥æŸ¥æ‰¾HUIè¡¨æ ¼
        // åœ¨æŒ‡å®šèŒƒå›´å†…æŸ¥æ‰¾è¡¨å¤´-è¡¨ä½“é…å¯¹ï¼Œé¿å…å®¹å™¨å±‚çº§é—®é¢˜
        const headerDivs = searchScope.querySelectorAll('.h-table-header, .hui-table-header');
        debugLog(`åœ¨${scopeDesc}ä¸­æ‰¾åˆ°${headerDivs.length}ä¸ªHUIè¡¨å¤´`);

        headerDivs.forEach((headerDiv, headerIndex) => {
            // å¦‚æœæŒ‡å®šäº†å®¹å™¨ï¼Œç¡®ä¿è¡¨å¤´åœ¨å®¹å™¨å†…
            if (containerElement && !containerElement.contains(headerDiv)) {
                debugLog(`âœ— è·³è¿‡å®¹å™¨å¤–çš„è¡¨å¤´ ${headerIndex + 1}`);
                return;
            }

            // æŸ¥æ‰¾å¯¹åº”çš„è¡¨ä½“ï¼ˆåŒçº§æˆ–é™„è¿‘ï¼‰
            const parentContainer = headerDiv.parentElement;
            if (!parentContainer) return;

            const bodyDiv = parentContainer.querySelector('.h-table-body, .hui-table-body');
            if (!bodyDiv) return;

            // å¦‚æœæŒ‡å®šäº†å®¹å™¨ï¼Œç¡®ä¿è¡¨ä½“ä¹Ÿåœ¨å®¹å™¨å†…
            if (containerElement && !containerElement.contains(bodyDiv)) {
                debugLog(`âœ— è·³è¿‡å®¹å™¨å¤–çš„è¡¨ä½“ ${headerIndex + 1}`);
                return;
            }

            const headerTable = headerDiv.querySelector('table');
            const bodyTable = bodyDiv.querySelector('table');

            if (headerTable && bodyTable) {
                // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡è¿™ä¸ªé…å¯¹
                const uniqueKey = `${headerTable.outerHTML.substring(0, 100)}_${bodyTable.outerHTML.substring(0, 100)}`;
                if (processedElements.has(uniqueKey)) {
                    debugLog(`âœ— è·³è¿‡é‡å¤çš„HUIè¡¨æ ¼é…å¯¹ ${headerIndex + 1}`);
                    return;
                }

                // æ ‡è®°ä¸ºå·²å¤„ç†
                processedElements.add(uniqueKey);
                processedElements.add(headerDiv);
                processedElements.add(bodyDiv);
                processedElements.add(headerTable);
                processedElements.add(bodyTable);
                processedElements.add(parentContainer);

                // åˆ›å»ºå®Œæ•´çš„HUIè¡¨æ ¼
                bodyTable._hTableHeader = headerTable;
                bodyTable._isHTableComplete = true;
                bodyTable._isHUITable = true;
                bodyTable._containerClass = parentContainer.className;
                bodyTable._uniqueKey = uniqueKey;

                tables.push(bodyTable);
                debugLog(`âœ“ è¯†åˆ«HUIå®Œæ•´è¡¨æ ¼ ${headerIndex + 1} (å®¹å™¨: ${parentContainer.className})`);
            }
        });

        // ç¬¬äºŒæ­¥ï¼šå¤„ç†Ant Designè¡¨æ ¼ï¼ˆä¸¥æ ¼é¿å…HUIè¡¨æ ¼ï¼‰
        debugLog('=== å¼€å§‹æŸ¥æ‰¾Ant Designè¡¨æ ¼ ===');
        const antSelectors = [
            '.ant-table-body table',
            '.ant-table-fixed',
            '.ant-table-tbody',
            '.ant-table table',
            '[class*="ant-table"] table',
            'table[class*="ant-table"]',
            '.ant-table-container table'
        ];

        for (const selector of antSelectors) {
            const elements = searchScope.querySelectorAll(selector);
            elements.forEach((el, elIndex) => {
                // å¦‚æœæŒ‡å®šäº†å®¹å™¨ï¼Œç¡®ä¿å…ƒç´ åœ¨å®¹å™¨å†…
                if (containerElement && !containerElement.contains(el)) {
                    debugLog(`âœ— è·³è¿‡å®¹å™¨å¤–çš„å…ƒç´ : ${selector}[${elIndex}]`);
                    return;
                }
                // æ£€æŸ¥1ï¼šè·³è¿‡ä»»ä½•å·²å¤„ç†çš„å…ƒç´ 
                if (processedElements.has(el)) {
                    debugLog(`âœ— è·³è¿‡å·²å¤„ç†å…ƒç´ : ${selector}[${elIndex}]`);
                    return;
                }

                // æ£€æŸ¥2ï¼šè·³è¿‡HUIè¡¨æ ¼ä¸­çš„tableå…ƒç´ 
                const huiContainer = el.closest('.h-table-header, .h-table-body, .hui-table-header, .hui-table-body');
                if (huiContainer) {
                    debugLog(`âœ— è·³è¿‡HUIè¡¨æ ¼å†…çš„table: ${selector}[${elIndex}]`);
                    processedElements.add(el); // æ ‡è®°ä¸ºå·²å¤„ç†ï¼Œé¿å…åç»­é‡å¤æ£€æŸ¥
                    return;
                }

                // æ£€æŸ¥3ï¼šè·³è¿‡HUIå®¹å™¨å†…çš„ä»»ä½•å…ƒç´ 
                if (el.closest('[class*="h-table"]')) {
                    debugLog(`âœ— è·³è¿‡HUIå®¹å™¨å†…å…ƒç´ : ${selector}[${elIndex}]`);
                    processedElements.add(el);
                    return;
                }

                // æ£€æŸ¥4ï¼šé¿å…é‡å¤æ·»åŠ ç›¸åŒçš„è¡¨æ ¼
                if (tables.includes(el)) {
                    debugLog(`âœ— è·³è¿‡é‡å¤è¡¨æ ¼: ${selector}[${elIndex}]`);
                    return;
                }

                tables.push(el);
                processedElements.add(el);
                debugLog(`âœ“ å‘ç°Antè¡¨æ ¼: ${selector}[${elIndex}] (class: ${el.className})`);
            });
        }

        debugLog(`è¡¨æ ¼æŸ¥æ‰¾å®Œæˆ: æ‰¾åˆ°${tables.length}ä¸ªè¡¨æ ¼`);

        // è¯¦ç»†è¾“å‡ºæ‰¾åˆ°çš„è¡¨æ ¼ä¿¡æ¯å’Œé¡µé¢ç»“æ„
        debugLog('=== æœ€ç»ˆè¡¨æ ¼è¯†åˆ«ç»“æœ ===');
        tables.forEach((table, index) => {
            const isHUI = table._isHUITable;
            const isComplete = table._isHTableComplete;
            const className = table.className;
            const containerClass = table._containerClass;
            const uniqueKey = table._uniqueKey ? table._uniqueKey.substring(0, 50) + '...' : 'N/A';

            debugLog(`è¡¨æ ¼${index + 1}:`);
            debugLog(`  - HUIè¡¨æ ¼: ${isHUI}`);
            debugLog(`  - å®Œæ•´ç»“æ„: ${isComplete}`);
            debugLog(`  - è¡¨æ ¼class: "${className}"`);
            debugLog(`  - å®¹å™¨class: "${containerClass}"`);
            debugLog(`  - å”¯ä¸€æ ‡è¯†: ${uniqueKey}`);
        });

        // è¾“å‡ºé¡µé¢HUIç»“æ„æ¦‚è§ˆ
        debugLog('=== é¡µé¢HUIç»“æ„æ¦‚è§ˆ ===');
        const allHuiElements = doc.querySelectorAll('[class*="h-table"]');
        debugLog(`æ€»å…±æ‰¾åˆ° ${allHuiElements.length} ä¸ªHUIç›¸å…³å…ƒç´ :`);
        allHuiElements.forEach((el, i) => {
            debugLog(`  ${i + 1}. ${el.tagName}.${el.className} (å­å…ƒç´ : ${el.children.length})`);
        });

        return tables;
    }

    // æå–å•ä¸ªAntè¡¨æ ¼
    async function extractSingleAntTable(table, sourceContext) {
        try {
            debugLog('å¼€å§‹åˆ†æè¡¨æ ¼ç»“æ„...');

            // æ£€æŸ¥æ˜¯å¦ä¸ºh-tableç»“æ„
            if (table._isHTableComplete && table._hTableHeader) {
                return await extractHTableContent(table, sourceContext);
            }

            // åˆ†æè¡¨æ ¼ç»“æ„
            const analysis = analyzeAntTableStructure(table);
            debugLog('è¡¨æ ¼åˆ†æç»“æœ:', analysis);

            let markdown = `# Ant Designè¡¨æ ¼ - ${sourceContext}\n\n`;

            // æ„å»ºè¡¨å¤´
            if (analysis.headers.length > 0) {
                markdown += '| ' + analysis.headers.join(' | ') + ' |\n';
                markdown += '| ' + analysis.headers.map(() => '---').join(' | ') + ' |\n';
            }

            // æå–è¡¨æ ¼æ•°æ®
            const rows = table.querySelectorAll('tbody tr, tr');
            let dataRowCount = 0;

            rows.forEach((row, index) => {
                // è·³è¿‡è¡¨å¤´è¡Œ
                if (row.querySelector('th')) return;

                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;

                const rowData = [];

                cells.forEach((cell, cellIndex) => {
                    const cellContent = extractCellContent(cell, cellIndex, analysis);
                    rowData.push(cellContent);
                });

                if (rowData.some(content => content.trim().length > 0)) {
                    markdown += '| ' + rowData.join(' | ') + ' |\n';
                    dataRowCount++;
                }
            });

            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            if (dataRowCount > 0) {
                markdown += `\n**ç»Ÿè®¡ä¿¡æ¯**:\n`;
                markdown += `- æ•°æ®è¡Œæ•°: ${dataRowCount}\n`;
                markdown += `- åˆ—æ•°: ${analysis.headers.length || 'æœªçŸ¥'}\n`;
                markdown += `- æå–æ—¶é—´: ${new Date().toLocaleString()}\n`;

                // åˆ†æå†…å®¹ç±»å‹
                const contentTypes = analyzeTableContentTypes(table);
                if (contentTypes.length > 0) {
                    markdown += `- æ£€æµ‹åˆ°çš„å†…å®¹ç±»å‹: ${contentTypes.join(', ')}\n`;
                }
            }

            return markdown;

        } catch (error) {
            debugLog('å•è¡¨æ ¼æå–é”™è¯¯:', error);
            return `æå–å¤±è´¥: ${error.message}`;
        }
    }

    // æå–HUI/HUNDSUN h-tableåˆ†ç¦»å¼è¡¨æ ¼å†…å®¹
    async function extractHTableContent(bodyTable, sourceContext) {
        try {
            debugLog('å¼€å§‹æå–HUI/HUNDSUN h-tableåˆ†ç¦»å¼è¡¨æ ¼...');

            const headerTable = bodyTable._hTableHeader;
            const isHUITable = bodyTable._isHUITable;
            const containerClass = bodyTable._containerClass || '';

            let markdown = `# HUIè¡¨æ ¼ - ${sourceContext}\n\n`;
            if (containerClass) {
                markdown += `**è¡¨æ ¼ç±»å‹**: ${containerClass}\n\n`;
            }

            // ä»è¡¨å¤´æå–åˆ—æ ‡é¢˜ - æ”¯æŒå¤šç§HUIè¡¨å¤´ç»“æ„
            const headers = [];
            const headerRows = headerTable.querySelectorAll('thead tr, tr');

            headerRows.forEach(row => {
                const headerCells = row.querySelectorAll('th');
                if (headerCells.length > 0) {
                    headerCells.forEach(cell => {
                        // HUIè¡¨æ ¼è¡¨å¤´æå–ä¼˜åŒ– - æ”¯æŒå¤šç§é€‰æ‹©å™¨
                        const titleSelectors = [
                            '.span-cell',
                            '.h-table-head-title span',
                            '.h-table-head-title',
                            '.hui-table-head-title span',
                            '.hui-table-head-title',
                            '.h-table-cell-title'
                        ];

                        let headerText = '';
                        for (const selector of titleSelectors) {
                            const titleEl = cell.querySelector(selector);
                            if (titleEl) {
                                headerText = titleEl.textContent.trim();
                                break;
                            }
                        }

                        // å¦‚æœæ²¡æ‰¾åˆ°ç‰¹å®šé€‰æ‹©å™¨ï¼Œä½¿ç”¨cellå†…å®¹
                        if (!headerText) {
                            headerText = cell.textContent.trim();
                        }

                        // è¿‡æ»¤éšè—åˆ—ï¼ˆä¸æ•°æ®åˆ—è¿‡æ»¤ä¿æŒä¸€è‡´ï¼Œä¿ç•™åºå·åˆ—ï¼‰
                        const hiddenClasses = ['h-table-hidden', 'hui-table-hidden', 'h-ui-t_base_selection_0'];
                        const isHidden = hiddenClasses.some(cls => cell.classList.contains(cls));

                        // è¿‡æ»¤è§„åˆ™ä¸æ•°æ®æå–ä¿æŒå®Œå…¨ä¸€è‡´
                        if (!isHidden && headerText && headerText !== 'é€‰æ‹©') {
                            headers.push(headerText);
                            debugLog(`æå–è¡¨å¤´: "${headerText}" (class: ${cell.className})`);
                        } else {
                            debugLog(`è·³è¿‡è¡¨å¤´åˆ—: "${headerText}" (éšè—:${isHidden}, class: ${cell.className})`);
                        }
                    });
                }
            });

            // å¦‚æœæ²¡æœ‰ä»è¡¨å¤´è·å–åˆ°æ ‡é¢˜ï¼Œä½¿ç”¨é»˜è®¤æ ‡é¢˜
            if (headers.length === 0) {
                const bodyRows = bodyTable.querySelectorAll('tbody tr, tr');
                if (bodyRows.length > 0) {
                    const firstRow = bodyRows[0];
                    const cells = firstRow.querySelectorAll('td');
                    for (let i = 0; i < cells.length; i++) {
                        if (!cells[i].classList.contains('h-table-hidden')) {
                            headers.push(`åˆ—${i + 1}`);
                        }
                    }
                }
            }

            debugLog(`h-tableè¡¨å¤´: ${headers.join(', ')}`);

            // æ„å»ºmarkdownè¡¨å¤´
            if (headers.length > 0) {
                markdown += '| ' + headers.join(' | ') + ' |\n';
                markdown += '| ' + headers.map(() => '---').join(' | ') + ' |\n';
            }

            // æå–è¡¨ä½“æ•°æ® - ä¼˜åŒ–HUIè¡¨æ ¼æ•°æ®æå–
            const bodyRows = bodyTable.querySelectorAll('tbody tr, tr');
            let dataRowCount = 0;

            bodyRows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;

                const rowData = [];

                cells.forEach((cell, cellIndex) => {
                    // è·³è¿‡HUIéšè—åˆ—ï¼ˆä¿ç•™åºå·åˆ—ï¼‰
                    const hiddenClasses = ['h-table-hidden', 'hui-table-hidden', 'h-ui-t_base_selection_0'];
                    const isHidden = hiddenClasses.some(cls => cell.classList.contains(cls));
                    if (isHidden) {
                        debugLog(`è·³è¿‡æ•°æ®åˆ—: ${cellIndex} (${cell.className})`);
                        return;
                    }

                    let cellContent = '';

                    // HUIè¡¨æ ¼ç‰¹æœ‰çš„å†…å®¹æå–ä¼˜åŒ–
                    // 1. å¤„ç†ä¸šåŠ¡é“¾æ¥å†…å®¹ï¼ˆå¸¸è§äºé‡‘èä¸šåŠ¡ç³»ç»Ÿï¼‰
                    const businessLink = cell.querySelector('a, .h-link, .hui-link');
                    if (businessLink) {
                        cellContent = businessLink.textContent.trim();
                    }
                    // 2. å¤„ç†HUIè¡¨æ ¼æ¸²æŸ“å™¨å†…å®¹
                    else if (cell.querySelector('[columntype="huitablerender"]')) {
                        const renderDiv = cell.querySelector('[columntype="huitablerender"] div');
                        if (renderDiv) {
                            const linkInRender = renderDiv.querySelector('a');
                            cellContent = linkInRender ? linkInRender.textContent.trim() : renderDiv.textContent.trim();
                        }
                    }
                    // 3. å¤„ç†è¡¨æ ¼å•å…ƒæ ¼å†…çš„spanå†…å®¹
                    else {
                        const contentSelectors = [
                            '.h-table-cell span',
                            '.hui-table-cell span',
                            '.span-cell',
                            'span',
                            '.h-table-cell',
                            '.hui-table-cell'
                        ];

                        for (const selector of contentSelectors) {
                            const contentEl = cell.querySelector(selector);
                            if (contentEl && contentEl.textContent.trim()) {
                                cellContent = contentEl.textContent.trim();
                                break;
                            }
                        }

                        // å¦‚æœè¿˜æ²¡æ‰¾åˆ°å†…å®¹ï¼Œä½¿ç”¨cellçš„ç›´æ¥æ–‡æœ¬
                        if (!cellContent) {
                            cellContent = cell.textContent.trim();
                        }
                    }

                    // æ¸…ç†å†…å®¹ - ç§»é™¤å¤šä½™ç©ºç™½å’Œæ¢è¡Œ
                    cellContent = cellContent.replace(/\s+/g, ' ').trim();

                    // å¤„ç†é‡‘èä¸šåŠ¡å¸¸è§çš„ç‰¹æ®Šå­—ç¬¦
                    cellContent = cellContent.replace(/[\u200B-\u200D\uFEFF]/g, ''); // ç§»é™¤é›¶å®½å­—ç¬¦

                    rowData.push(cellContent);
                });

                if (rowData.some(content => content.length > 0)) {
                    markdown += '| ' + rowData.join(' | ') + ' |\n';
                    dataRowCount++;
                }
            });

            // æ·»åŠ HUIè¡¨æ ¼ç»Ÿè®¡ä¿¡æ¯
            if (dataRowCount > 0) {
                markdown += `\n**HUIè¡¨æ ¼ç»Ÿè®¡ä¿¡æ¯**:\n`;
                markdown += `- æ•°æ®è¡Œæ•°: ${dataRowCount}\n`;
                markdown += `- åˆ—æ•°: ${headers.length}\n`;
                markdown += `- è¡¨æ ¼ç±»å‹: HUI/HUNDSUNåˆ†ç¦»å¼ç»“æ„\n`;
                markdown += `- å®¹å™¨ç±»å: ${containerClass}\n`;

                // åˆ†æé‡‘èä¸šåŠ¡è¡¨æ ¼ç‰¹å¾
                const businessFeatures = analyzeHUIBusinessFeatures(bodyTable, headerTable);
                if (businessFeatures.length > 0) {
                    markdown += `- ä¸šåŠ¡ç‰¹å¾: ${businessFeatures.join(', ')}\n`;
                }

                markdown += `- æå–æ—¶é—´: ${new Date().toLocaleString()}\n`;
            }

            return markdown;

        } catch (error) {
            debugLog('HUIè¡¨æ ¼æå–é”™è¯¯:', error);
            return `HUIè¡¨æ ¼æå–å¤±è´¥: ${error.message}`;
        }
    }

    // åˆ†æHUIè¡¨æ ¼ä¸šåŠ¡ç‰¹å¾
    function analyzeHUIBusinessFeatures(bodyTable, headerTable) {
        const features = [];

        try {
            // æ£€æŸ¥è¡¨å¤´ç‰¹å¾
            if (headerTable) {
                const headerText = headerTable.textContent.toLowerCase();

                // é‡‘èä¸šåŠ¡å…³é”®è¯æ£€æµ‹
                if (headerText.includes('ä»»åŠ¡') || headerText.includes('æµç¨‹')) {
                    features.push('å·¥ä½œæµç¨‹è¡¨');
                }
                if (headerText.includes('å®¡æ‰¹') || headerText.includes('å®¡æ ¸')) {
                    features.push('å®¡æ‰¹æµè¡¨');
                }
                if (headerText.includes('æŠ•èµ„') || headerText.includes('å€ºæƒ') || headerText.includes('ä¿¡æ‰˜')) {
                    features.push('æŠ•èµ„ä¸šåŠ¡è¡¨');
                }
                if (headerText.includes('å¤„ç†äºº') || headerText.includes('å½“å‰èŠ‚ç‚¹')) {
                    features.push('èŠ‚ç‚¹å¤„ç†è¡¨');
                }
            }

            // æ£€æŸ¥è¡¨ä½“ç‰¹å¾
            if (bodyTable) {
                const bodyText = bodyTable.textContent.toLowerCase();

                // æ£€æŸ¥æ˜¯å¦åŒ…å«é‡‘èäº§å“åç§°æ¨¡å¼
                if (/èµ„ç®¡|ä¿¡æ‰˜/.test(bodyText)) {
                    features.push('é‡‘èäº§å“åˆ—è¡¨');
                }

                // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»»åŠ¡IDæ¨¡å¼
                if (/\d{8,}/.test(bodyText)) {
                    features.push('åŒ…å«ä¸šåŠ¡ç¼–å·');
                }

                // æ£€æŸ¥ç‰¹æ®Šç»„ä»¶
                if (bodyTable.querySelector('.h-checkbox, .hui-checkbox')) {
                    features.push('æ”¯æŒå¤šé€‰');
                }

                if (bodyTable.querySelector('[columntype="huitablerender"]')) {
                    features.push('è‡ªå®šä¹‰æ¸²æŸ“å™¨');
                }

                if (bodyTable.querySelector('.h-table-sort, .hui-table-sort')) {
                    features.push('æ”¯æŒæ’åº');
                }

                // æ£€æŸ¥åˆ†é¡µä¿¡æ¯
                const container = bodyTable.closest('[class*="h-table"], [class*="hui-table"]');
                if (container && container.querySelector('.h-pagination, .hui-pagination')) {
                    features.push('æ”¯æŒåˆ†é¡µ');
                }
            }

        } catch (error) {
            debugLog('HUIä¸šåŠ¡ç‰¹å¾åˆ†æé”™è¯¯:', error);
        }

        return features;
    }

    // åˆ†æAntè¡¨æ ¼ç»“æ„
    function analyzeAntTableStructure(table) {
        const analysis = {
            headers: [],
            columnCount: 0,
            hasCheckbox: false,
            hasActions: false,
            specialColumns: []
        };

        try {
            // å°è¯•ä»colgroupè·å–åˆ—ä¿¡æ¯
            const colgroup = table.querySelector('colgroup');
            if (colgroup) {
                const cols = colgroup.querySelectorAll('col');
                analysis.columnCount = cols.length;

                // åˆ†æåˆ—ç‰¹å¾
                cols.forEach((col, index) => {
                    const className = col.className;
                    if (className.includes('selection')) {
                        analysis.hasCheckbox = true;
                        analysis.specialColumns.push({ index, type: 'checkbox' });
                    }
                });
            }

            // å°è¯•ä»ç¬¬ä¸€è¡Œæ•°æ®æ¨æ–­åˆ—æ ‡é¢˜
            const firstDataRow = table.querySelector('tbody tr:first-child, tr:first-child');
            if (firstDataRow) {
                const cells = firstDataRow.querySelectorAll('td');

                cells.forEach((cell, index) => {
                    let header = '';

                    if (cell.classList.contains('ant-table-selection-column')) {
                        header = 'é€‰æ‹©';
                        analysis.hasCheckbox = true;
                    } else if (cell.querySelector('.subject-render, .subject-render-title')) {
                        header = 'æ ‡é¢˜';
                    } else if (cell.querySelector('.current-nodes-column')) {
                        header = 'å½“å‰å¤„ç†äºº';
                    } else if (cell.querySelector('.category-label, .ant-tag')) {
                        header = 'çŠ¶æ€';
                    } else if (cell.textContent.trim().includes('åˆ˜ç…œæ´²')) {
                        header = 'å‘èµ·äºº';
                    } else {
                        header = `åˆ—${index + 1}`;
                    }

                    analysis.headers.push(header);
                });
            }

            // å¦‚æœæ²¡æœ‰æ¨æ–­å‡ºæ ‡é¢˜ï¼Œä½¿ç”¨é»˜è®¤æ ‡é¢˜
            if (analysis.headers.length === 0 && analysis.columnCount > 0) {
                for (let i = 0; i < analysis.columnCount; i++) {
                    analysis.headers.push(`åˆ—${i + 1}`);
                }
            }

        } catch (error) {
            debugLog('è¡¨æ ¼ç»“æ„åˆ†æé”™è¯¯:', error);
        }

        return analysis;
    }

    // æå–å•å…ƒæ ¼å†…å®¹
    function extractCellContent(cell, cellIndex, analysis) {
        try {
            // é€‰æ‹©æ¡†åˆ—
            if (cell.classList.contains('ant-table-selection-column') ||
                cell.querySelector('input[type="checkbox"]')) {
                const checkbox = cell.querySelector('input[type="checkbox"]');
                return checkbox && checkbox.checked ? 'â˜‘ å·²é€‰æ‹©' : 'â˜ æœªé€‰æ‹©';
            }

            // æ ‡é¢˜åˆ— - ç‰¹æ®Šå¤„ç†
            const subjectTitle = cell.querySelector('.subject-render-title');
            if (subjectTitle) {
                let title = subjectTitle.textContent.trim();

                // æ£€æŸ¥é‡è¦æ ‡è®°
                if (cell.querySelector('.xicon-important1, [class*="important"]')) {
                    title = 'â­ ' + title;
                }

                // æ£€æŸ¥é™„ä»¶
                if (cell.querySelector('.attachment-color, [class*="attachment"]')) {
                    title += ' ğŸ“';
                }

                return title;
            }

            // å½“å‰å¤„ç†äººåˆ—
            const currentNode = cell.querySelector('.current-nodes-column');
            if (currentNode) {
                return currentNode.textContent.trim();
            }

            // çŠ¶æ€æ ‡ç­¾åˆ—
            const statusTag = cell.querySelector('.category-label .ant-tag, .ant-tag');
            if (statusTag) {
                return statusTag.textContent.trim();
            }

            // ä¸€èˆ¬åˆ— - æ¸…ç†æ–‡æœ¬
            let text = cell.textContent.trim();
            text = text.replace(/\s+/g, ' '); // åˆå¹¶ç©ºç™½å­—ç¬¦
            text = text.replace(/\n/g, ' '); // æ›¿æ¢æ¢è¡Œ

            return text || '-';

        } catch (error) {
            debugLog('å•å…ƒæ ¼å†…å®¹æå–é”™è¯¯:', error);
            return cell.textContent.trim() || '-';
        }
    }

    // åˆ†æè¡¨æ ¼å†…å®¹ç±»å‹ - å¢å¼ºHUI/HUNDSUNç»„ä»¶æ”¯æŒ
    function analyzeTableContentTypes(table) {
        const types = [];

        // åŸæœ‰Ant Designç»„ä»¶æ£€æµ‹
        if (table.querySelector('.subject-render, .subject-render-title')) {
            types.push('æ ‡é¢˜å†…å®¹');
        }
        if (table.querySelector('.current-nodes-column')) {
            types.push('å¤„ç†äººä¿¡æ¯');
        }
        if (table.querySelector('.category-label, .ant-tag')) {
            types.push('çŠ¶æ€æ ‡ç­¾');
        }

        // HUI/HUNDSUNç»„ä»¶æ£€æµ‹
        if (table.querySelector('.h-checkbox, .hui-checkbox, input[type="checkbox"]')) {
            types.push('é€‰æ‹©æ¡†');
        }
        if (table.querySelector('.h-table-sort, .hui-table-sort')) {
            types.push('æ’åºåŠŸèƒ½');
        }
        if (table.querySelector('[columntype="huitablerender"]')) {
            types.push('HUIè‡ªå®šä¹‰æ¸²æŸ“');
        }
        if (table.querySelector('.h-link, .hui-link')) {
            types.push('ä¸šåŠ¡é“¾æ¥');
        }
        if (table.querySelector('.h-table-cell-ellipsis, .hui-table-cell-ellipsis')) {
            types.push('æ–‡æœ¬çœç•¥');
        }

        // é‡‘èä¸šåŠ¡ç‰¹æœ‰æ ‡è®°
        if (table.querySelector('[class*="important"]')) {
            types.push('é‡è¦æ ‡è®°');
        }
        if (table.querySelector('[class*="attachment"]')) {
            types.push('é™„ä»¶æ ‡è®°');
        }
        if (table.querySelector('[class*="urgent"]')) {
            types.push('ç´§æ€¥æ ‡è®°');
        }

        // ä¸šåŠ¡æµç¨‹ç›¸å…³
        if (table.querySelector('[class*="node"], [class*="workflow"]')) {
            types.push('æµç¨‹èŠ‚ç‚¹');
        }
        if (table.querySelector('[class*="approval"], [class*="audit"]')) {
            types.push('å®¡æ‰¹çŠ¶æ€');
        }

        // é€šè¿‡å†…å®¹æ–‡æœ¬åˆ¤æ–­ä¸šåŠ¡ç±»å‹
        const tableText = table.textContent.toLowerCase();
        if (/èµ„ç®¡|ä¿¡æ‰˜|æŠ•èµ„è®¡åˆ’/.test(tableText)) {
            types.push('é‡‘èäº§å“');
        }
        if (/å®¡æ‰¹|å®¡æ ¸|å¾…åŠ|å¤„ç†/.test(tableText)) {
            types.push('å®¡æ‰¹ä¸šåŠ¡');
        }
        if (/\d{8,}/.test(tableText)) {
            types.push('ä¸šåŠ¡ç¼–å·');
        }

        return types;
    }

    // æ˜¾ç¤ºAntè¡¨æ ¼é€‰æ‹©å¯¹è¯æ¡†
    function showAntTableSelectionDialog(tables, sourceContext) {
        const modal = document.createElement('div');
        modal.setAttribute('data-md-extractor-ui', 'true');
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #1890ff;
            border-radius: 12px;
            padding: 0;
            z-index: 10001;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        `;

        let tableListHtml = '';
        tables.forEach((table, index) => {
            const rowCount = table.querySelectorAll('tbody tr, tr').length;
            const colCount = table.querySelectorAll('tbody tr:first-child td, tr:first-child td').length;
            const hasCheckbox = !!table.querySelector('.ant-table-selection-column');
            const hasStatus = !!table.querySelector('.category-label, .ant-tag');

            tableListHtml += `
                <div style="border: 1px solid #d9d9d9; border-radius: 6px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;"
                     data-table-index="${index}" class="table-option"
                     onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
                    <div style="font-weight: bold; color: #1890ff; margin-bottom: 8px; display: flex; align-items: center;">
                        ğŸœ è¡¨æ ¼ ${index + 1}
                        ${hasCheckbox ? '<span style="margin-left: 8px; background: #e6f7ff; color: #1890ff; padding: 2px 6px; border-radius: 4px; font-size: 12px;">é€‰æ‹©æ¡†</span>' : ''}
                        ${hasStatus ? '<span style="margin-left: 8px; background: #f6ffed; color: #52c41a; padding: 2px 6px; border-radius: 4px; font-size: 12px;">çŠ¶æ€æ ‡ç­¾</span>' : ''}
                    </div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                        ğŸ“Š ${rowCount} è¡Œ Ã— ${colCount} åˆ—
                    </div>
                    <div style="font-size: 12px; color: #999;">
                        ${table.className || 'æ— ç‰¹æ®Šæ ·å¼ç±»'}
                    </div>
                </div>
            `;
        });

        modal.innerHTML = `
            <div style="background: #1890ff; color: white; padding: 16px 20px; border-radius: 10px 10px 0 0;">
                <h3 style="margin: 0; font-size: 18px; display: flex; align-items: center;">
                    ğŸœ é€‰æ‹©Ant Designè¡¨æ ¼
                    <span style="margin-left: auto; font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px;">${sourceContext}</span>
                </h3>
            </div>

            <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                <div style="margin-bottom: 16px; color: #666; font-size: 14px;">
                    åœ¨${sourceContext}å‘ç°${tables.length}ä¸ªè¡¨æ ¼ï¼Œè¯·é€‰æ‹©è¦æå–çš„è¡¨æ ¼ï¼š
                </div>
                ${tableListHtml}
            </div>

            <div style="background: #fafafa; padding: 16px 20px; border-top: 1px solid #d9d9d9; text-align: right;">
                <button id="cancel-table-select" style="padding: 8px 16px; background: #d9d9d9; color: #666; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">å–æ¶ˆ</button>
            </div>
        `;

        // ç»‘å®šäº‹ä»¶
        modal.querySelector('#cancel-table-select').onclick = () => modal.remove();

        // ä¸ºæ¯ä¸ªè¡¨æ ¼é€‰é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶
        modal.querySelectorAll('.table-option').forEach(option => {
            option.onclick = async () => {
                const index = parseInt(option.dataset.tableIndex);
                const table = tables[index];

                modal.remove();
                showStatus(`æ­£åœ¨æå–è¡¨æ ¼ ${index + 1}...`, 'info');

                const result = await extractSingleAntTable(table, `${sourceContext} - è¡¨æ ¼${index + 1}`);
                if (result) {
                    openPreviewWindow(result, `Antè¡¨æ ¼${index + 1} - ${sourceContext}`);
                    showStatus('è¡¨æ ¼æå–å®Œæˆï¼', 'success');
                }
            };
        });

        document.body.appendChild(modal);
    }

    // æ˜¾ç¤ºAntè¡¨æ ¼è°ƒè¯•ä¿¡æ¯
    function showAntTableDebugInfo() {
        const debugInfo = `
=== Ant Designè¡¨æ ¼è°ƒè¯•ä¿¡æ¯ ===

æ­£åœ¨æœç´¢çš„é€‰æ‹©å™¨:
- .ant-table-body table
- .ant-table-fixed
- .ant-table-tbody
- .ant-table table
- [class*="ant-table"] table
- table[class*="ant-table"]
- .ant-table-container table

å½“å‰é¡µé¢å‘ç°çš„è¡¨æ ¼:
${Array.from(document.querySelectorAll('table')).map((table, i) =>
    `- è¡¨æ ¼${i + 1}: ${table.className || 'æ— class'} (${table.tagName})`
).join('\n')}

å½“å‰é¡µé¢å‘ç°çš„Antç›¸å…³å…ƒç´ :
${Array.from(document.querySelectorAll('[class*="ant-table"]')).map((el, i) =>
    `- å…ƒç´ ${i + 1}: ${el.tagName} - ${el.className}`
).join('\n') || 'æ— '}

å»ºè®®:
1. å°è¯•ä½¿ç”¨"ğŸ¯ ç›´é€‰iframe"åŠŸèƒ½
2. ä½¿ç”¨"ğŸ” iframeåˆ†æ"æŸ¥çœ‹iframeç»“æ„
3. æˆ–æ‰‹åŠ¨è¾“å…¥é€‰æ‹©å™¨: .ant-table-body
        `;

        openPreviewWindow(debugInfo, 'Antè¡¨æ ¼è°ƒè¯•ä¿¡æ¯');
    }

    // ä»æ–‡æ¡£ä¸­æå–å†…å®¹
    function extractContentFromDocument(doc) {
        try {
            // é¦–å…ˆå°è¯•ä¸“é—¨çš„è¡¨æ ¼å†…å®¹æå–
            const tableContent = extractTableContent(doc);
            if (tableContent && tableContent.trim().length > 100) {
                debugLog(`æˆåŠŸæå–è¡¨æ ¼å†…å®¹ï¼Œé•¿åº¦: ${tableContent.length}`);
                return tableContent;
            }

            // å°è¯•æ‰¾åˆ°ä¸»è¦å†…å®¹åŒºåŸŸ
            const selectors = [
                '.ant-table-body', // Ant Designè¡¨æ ¼
                '.pending-list-main',
                '.main-content',
                '.content',
                'main',
                'article',
                '#main',
                'body'
            ];

            let content = '';
            for (const selector of selectors) {
                const element = doc.querySelector(selector);
                if (element) {
                    content = element.innerText || element.textContent;
                    if (content && content.trim().length > 50) {
                        debugLog(`æˆåŠŸä»é€‰æ‹©å™¨ "${selector}" æå–å†…å®¹ï¼Œé•¿åº¦: ${content.length}`);
                        return content;
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šåŒºåŸŸï¼Œæå–æ•´ä¸ªbody
            const body = doc.body;
            if (body) {
                content = body.innerText || body.textContent;
                debugLog(`ä»bodyæå–å†…å®¹ï¼Œé•¿åº¦: ${content.length}`);
                return content;
            }

        } catch (e) {
            debugLog('å†…å®¹æå–å‡ºé”™:', e.message);
        }
        return null;
    }

    // ä¸“é—¨çš„è¡¨æ ¼å†…å®¹æå–å‡½æ•°
    function extractTableContent(doc) {
        try {
            // æŸ¥æ‰¾Ant Designè¡¨æ ¼
            const antTable = doc.querySelector('.ant-table-body table.ant-table-fixed');
            if (antTable) {
                return extractAntTableContent(antTable, doc);
            }

            // æŸ¥æ‰¾æ™®é€šè¡¨æ ¼
            const tables = doc.querySelectorAll('table');
            if (tables.length > 0) {
                return extractRegularTableContent(tables[0]);
            }

            return '';
        } catch (error) {
            debugLog('è¡¨æ ¼å†…å®¹æå–å‡ºé”™:', error);
            return '';
        }
    }

    // æå–Ant Designè¡¨æ ¼å†…å®¹
    function extractAntTableContent(table, doc) {
        let markdown = '';

        try {
            // è·å–è¡¨å¤´ä¿¡æ¯ï¼ˆä»colgroupæ¨æ–­ï¼‰
            const colgroup = table.querySelector('colgroup');
            const cols = colgroup ? colgroup.querySelectorAll('col') : [];
            const columnCount = cols.length;

            // æ¨æ–­åˆ—æ ‡é¢˜
            const headers = ['é€‰æ‹©', 'æ ‡é¢˜', 'å½“å‰å¤„ç†äºº', 'å‘èµ·äºº', 'çŠ¶æ€'];

            // ç”Ÿæˆè¡¨å¤´
            markdown += '| ' + headers.slice(0, columnCount).join(' | ') + ' |\n';
            markdown += '| ' + headers.slice(0, columnCount).map(() => '---').join(' | ') + ' |\n';

            // æå–è¡¨æ ¼è¡Œæ•°æ®
            const rows = table.querySelectorAll('tbody tr.ant-table-row');
            debugLog(`æ‰¾åˆ°${rows.length}è¡Œæ•°æ®`);

            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                const rowData = [];

                cells.forEach((cell, cellIndex) => {
                    let cellText = '';

                    if (cellIndex === 0) {
                        // é€‰æ‹©æ¡†åˆ—
                        cellText = 'â˜';
                    } else if (cell.querySelector('.subject-render-title')) {
                        // æ ‡é¢˜åˆ—
                        const titleElement = cell.querySelector('.subject-render-title');
                        cellText = titleElement ? titleElement.textContent.trim() : '';

                        // æ£€æŸ¥æ˜¯å¦æœ‰é‡è¦æ ‡è®°
                        if (cell.querySelector('.xicon-important1')) {
                            cellText = 'â­ ' + cellText;
                        }

                        // æ£€æŸ¥æ˜¯å¦æœ‰é™„ä»¶
                        if (cell.querySelector('.attachment-color')) {
                            cellText += ' ğŸ“';
                        }
                    } else if (cell.querySelector('.current-nodes-column')) {
                        // å½“å‰å¤„ç†äººåˆ—
                        const nodeElement = cell.querySelector('.current-nodes-column');
                        cellText = nodeElement ? nodeElement.textContent.trim() : '';
                    } else if (cell.querySelector('.category-label .ant-tag')) {
                        // çŠ¶æ€æ ‡ç­¾åˆ—
                        const tagElement = cell.querySelector('.category-label .ant-tag');
                        cellText = tagElement ? tagElement.textContent.trim() : '';
                    } else {
                        // å…¶ä»–åˆ—
                        cellText = cell.textContent.trim();
                    }

                    // æ¸…ç†æ–‡æœ¬
                    cellText = cellText.replace(/\s+/g, ' ').trim();
                    rowData.push(cellText || '-');
                });

                // åªæ·»åŠ æœ‰å†…å®¹çš„è¡Œ
                if (rowData.some(cell => cell !== '-' && cell !== 'â˜')) {
                    markdown += '| ' + rowData.join(' | ') + ' |\n';
                }
            });

            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            if (rows.length > 0) {
                markdown += `\n**ç»Ÿè®¡**: å…± ${rows.length} æ¡å¾…åŠäº‹é¡¹\n`;

                // åˆ†æçŠ¶æ€åˆ†å¸ƒ
                const statusMap = {};
                rows.forEach(row => {
                    const statusCell = row.querySelector('.category-label .ant-tag');
                    if (statusCell) {
                        const status = statusCell.textContent.trim();
                        statusMap[status] = (statusMap[status] || 0) + 1;
                    }
                });

                if (Object.keys(statusMap).length > 0) {
                    markdown += '\n**çŠ¶æ€åˆ†å¸ƒ**:\n';
                    Object.entries(statusMap).forEach(([status, count]) => {
                        markdown += `- ${status}: ${count}æ¡\n`;
                    });
                }
            }

            return markdown;

        } catch (error) {
            debugLog('Antè¡¨æ ¼æå–å‡ºé”™:', error);
            // é™çº§ä¸ºæ™®é€šæ–‡æœ¬æå–
            return table.textContent || '';
        }
    }

    // æå–æ™®é€šè¡¨æ ¼å†…å®¹
    function extractRegularTableContent(table) {
        let markdown = '';

        try {
            const rows = table.querySelectorAll('tr');

            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('th, td');
                const cellTexts = Array.from(cells).map(cell => {
                    return cell.textContent.trim().replace(/\s+/g, ' ');
                });

                if (cellTexts.some(text => text.length > 0)) {
                    markdown += '| ' + cellTexts.join(' | ') + ' |\n';

                    // å¦‚æœæ˜¯ç¬¬ä¸€è¡Œï¼Œæ·»åŠ åˆ†éš”ç¬¦
                    if (index === 0) {
                        markdown += '| ' + cellTexts.map(() => '---').join(' | ') + ' |\n';
                    }
                }
            });

            return markdown;

        } catch (error) {
            debugLog('æ™®é€šè¡¨æ ¼æå–å‡ºé”™:', error);
            return table.textContent || '';
        }
    }

    function exitPickingMode() {
        isPickingMode = false;

        if (isTopWindow) {
            document.body.removeEventListener('mouseover', handleMouseOver, true);
            document.body.removeEventListener('click', handleMouseClick, true);
            document.removeEventListener('keydown', handleKeyDown, true);

             // é€šçŸ¥æ‰€æœ‰ iframe é€€å‡ºé€‰æ‹©æ¨¡å¼ï¼Œå¹¶æ¸…é™¤è§†è§‰æ•ˆæœ
            document.querySelectorAll('iframe').forEach(iframe => {
                try {
                    iframe.contentWindow.postMessage({ type: 'exitPickingMode' }, '*');
                } catch (e) {
                    debugLog('é€šçŸ¥iframeé€€å‡ºé€‰æ‹©æ¨¡å¼å¤±è´¥:', e.message);
                }

                // æ¸…é™¤iframeçš„è§†è§‰è¾¹æ¡†å’Œè¦†ç›–å±‚
                iframe.style.border = '';
                iframe.style.boxShadow = '';
                iframe.classList.remove('md-extractor-iframe-active', 'md-extractor-iframe-cross-origin');

                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„è¦†ç›–å±‚
                const iframeId = iframe.id || 'unknown';
                const overlay = document.getElementById(`md-iframe-overlay-${iframeId}`);
                if (overlay) {
                    overlay.remove();
                    debugLog(`å·²ç§»é™¤iframeè¦†ç›–å±‚: ${iframeId}`);
                }
            });

            if (lastHoveredElement) {
                lastHoveredElement.classList.remove(CONFIG.HOVER_HIGHLIGHT_CLASS);
                lastHoveredElement = null;
            }

            const pickerBtn = document.getElementById('element-picker-btn');
            if (pickerBtn) {
                pickerBtn.classList.remove('picking');
                pickerBtn.textContent = 'ğŸ–±ï¸ é€‰æ‹©å…ƒç´ ';
            }
            showStatus('å·²é€€å‡ºé€‰æ‹©æ¨¡å¼ã€‚', 'info');

        } else {
            // åœ¨ iframe ä¸­
            document.body.removeEventListener('mouseover', handleMouseOver, true);
            document.body.removeEventListener('click', handleMouseClick, true);
            document.removeEventListener('keydown', handleKeyDown, true);

            if (lastHoveredElement) {
                lastHoveredElement.classList.remove(CONFIG.HOVER_HIGHLIGHT_CLASS);
                lastHoveredElement = null;
            }
        }
    }

    function handleMouseOver(event) {
        if (!isPickingMode) return;

        let target = event.target;

        // è·³è¿‡å·¥å…·æ å’Œè„šæœ¬ç”Ÿæˆçš„å…ƒç´ 
        if (target.closest(`#${CONFIG.TOOLBAR_ID}`) ||
            target.closest('[data-md-extractor-ui]') ||
            target.id?.includes('md-iframe-overlay')) {
            return;
        }

        // å¦‚æœç›®æ ‡å…ƒç´ å¤ªå°æˆ–ä¸å¯è§ï¼Œå°è¯•æ‰¾åˆ°æ›´åˆé€‚çš„çˆ¶å…ƒç´ 
        const rect = target.getBoundingClientRect();
        if (rect.width < 10 || rect.height < 10) {
            let parent = target.parentElement;
            while (parent && parent !== document.body) {
                const parentRect = parent.getBoundingClientRect();
                if (parentRect.width >= 20 && parentRect.height >= 20) {
                    target = parent;
                    break;
                }
                parent = parent.parentElement;
            }
        }

        if (target === lastHoveredElement) return;

        if (lastHoveredElement) {
            lastHoveredElement.classList.remove(CONFIG.HOVER_HIGHLIGHT_CLASS);
        }

        target.classList.add(CONFIG.HOVER_HIGHLIGHT_CLASS);
        lastHoveredElement = target;

        debugLog('æ‚¬åœå…ƒç´ :', {
            tagName: target.tagName,
            className: target.className,
            id: target.id,
            size: `${rect.width}x${rect.height}`
        });
    }

    function handleMouseClick(event) {
        if (!isPickingMode) return;

        // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å·¥å…·æ æˆ–è„šæœ¬UI
        if (event.target.closest(`#${CONFIG.TOOLBAR_ID}`) ||
            event.target.closest('[data-md-extractor-ui]') ||
            event.target.id?.includes('md-iframe-overlay')) {
            return;
        }

        event.preventDefault();
        event.stopPropagation();

        try {
            let targetElement = event.target;

            debugLog('åŸå§‹ç‚¹å‡»ç›®æ ‡:', {
                tagName: targetElement.tagName,
                className: targetElement.className,
                id: targetElement.id
            });

            // å¦‚æœç‚¹å‡»çš„æ˜¯å¾ˆå°çš„å…ƒç´ æˆ–ä¼ªå…ƒç´ ï¼Œå°è¯•æ‰¾åˆ°æ›´åˆé€‚çš„çˆ¶å…ƒç´ 
            const rect = targetElement.getBoundingClientRect();
            if (rect.width < 5 || rect.height < 5 ||
                targetElement.tagName === 'I' ||
                targetElement.tagName === 'SPAN' && rect.width < 20) {

                let parent = targetElement.parentElement;
                while (parent && parent !== document.body) {
                    const parentRect = parent.getBoundingClientRect();
                    if (parentRect.width >= 30 && parentRect.height >= 20) {
                        debugLog('è°ƒæ•´ç›®æ ‡å…ƒç´ ä»', targetElement.tagName, 'åˆ°', parent.tagName);
                        targetElement = parent;
                        break;
                    }
                    parent = parent.parentElement;
                }
            }
            const selectors = generateAllSelectors(targetElement);
            let workingSelector = null;
            let bestScore = -1;

            // æµ‹è¯•æ‰€æœ‰é€‰æ‹©å™¨å¹¶é€‰æ‹©æœ€ä½³çš„
            const validSelectors = [];
            for (const selector of selectors) {
                if (testSelector(selector, targetElement)) {
                    const score = selector.score || 0;
                    validSelectors.push({ selector, score });
                    if (score > bestScore) {
                        bestScore = score;
                        workingSelector = selector;
                    }
                }
            }

            console.log(`æ‰¾åˆ°${validSelectors.length}ä¸ªæœ‰æ•ˆé€‰æ‹©å™¨ï¼Œæœ€ä½³åˆ†æ•°:${bestScore}`);

            // å¦‚æœæ‰¾åˆ°å¤šä¸ªé€‰æ‹©å™¨ï¼Œä¼˜å…ˆé€‰æ‹©OAç³»ç»Ÿç‰¹å¾çš„é€‰æ‹©å™¨
            if (validSelectors.length > 1) {
                const oaOptimizedSelector = optimizeForOASystem(validSelectors, targetElement);
                if (oaOptimizedSelector) {
                    workingSelector = oaOptimizedSelector;
                    console.log(`åº”ç”¨OAç³»ç»Ÿä¼˜åŒ–ï¼Œé€‰æ‹©å™¨: ${workingSelector}`);
                }
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é€‰æ‹©å™¨ï¼Œå°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ªèƒ½åŒ¹é…åˆ°ç›®æ ‡å…ƒç´ çš„é€‰æ‹©å™¨
            if (!workingSelector) {
                for (const selector of selectors) {
                    try {
                        const found = document.querySelector(selector);
                        if (found === targetElement) {
                            workingSelector = selector;
                            break;
                        }
                    } catch (e) {
                        // å¿½ç•¥æ— æ•ˆé€‰æ‹©å™¨
                    }
                }
            }

            // å¤‡ç”¨æ–¹æ¡ˆ: å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆé€‰æ‹©å™¨ï¼Œä½¿ç”¨å¤‡ç”¨ç”Ÿæˆå™¨
            if (!workingSelector) {
                debugLog('å¸¸è§„é€‰æ‹©å™¨ç”Ÿæˆå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ');
                workingSelector = generateFallbackSelector(targetElement);
                if (workingSelector) {
                    debugLog('å¤‡ç”¨é€‰æ‹©å™¨ç”ŸæˆæˆåŠŸ:', workingSelector);
                    if (isTopWindow) {
                        showStatus('ä½¿ç”¨å¤‡ç”¨é€‰æ‹©å™¨æˆåŠŸé€‰æ‹©å…ƒç´ ', 'warning');
                    }
                    // éªŒè¯å¤‡ç”¨é€‰æ‹©å™¨
                    try {
                        const found = document.querySelector(workingSelector);
                        if (found !== targetElement) {
                            debugLog('å¤‡ç”¨é€‰æ‹©å™¨éªŒè¯å¤±è´¥ï¼ŒåŒ¹é…åˆ°é”™è¯¯å…ƒç´ ');
                            workingSelector = null;
                        }
                    } catch (e) {
                        debugLog('å¤‡ç”¨é€‰æ‹©å™¨éªŒè¯å‡ºé”™:', e);
                        workingSelector = null;
                    }
                }
            }

            if (!workingSelector) {
                 if (isTopWindow) {
                    showStatus('æ— æ³•ç”Ÿæˆæœ‰æ•ˆçš„é€‰æ‹©å™¨ï¼Œè¯·å°è¯•å…¶ä»–å…ƒç´ ', 'error');
                } else {
                    window.top.postMessage({ type: 'selectorError', message: 'æ— æ³•ç”Ÿæˆæœ‰æ•ˆçš„é€‰æ‹©å™¨' }, '*');
                }
                return;
            }

            if (isTopWindow) {
                selectionContext = { source: 'top', selector: workingSelector, iframeId: null };
                const selectorInput = document.getElementById('selector-input');
                if (selectorInput) {
                    selectorInput.value = workingSelector;
                }
                highlightElement(workingSelector);
                console.log('[MD Extractor] é¡¶å±‚çª—å£é€‰æ‹©å…ƒç´ :', workingSelector);
                showStatus('å·²é€‰æ‹©å…ƒç´ ï¼', 'success');
            } else {
                // åœ¨ iframe ä¸­ï¼Œå°†é€‰æ‹©å™¨å‘é€åˆ°é¡¶å±‚çª—å£
                const myId = window.frameElement ? window.frameElement.id : null;
                const frameUrl = window.location.href;
                const isNestedFrame = window.parent !== window.top;

                console.log('[MD Extractor] iframeé€‰æ‹©å…ƒç´ :', {
                    selector: workingSelector,
                    iframeId: myId,
                    url: frameUrl,
                    isNested: isNestedFrame,
                    frameElement: window.frameElement
                });

                if (!myId) {
                    window.top.postMessage({ type: 'selectorError', message: 'iframeç¼ºå°‘IDï¼Œæ— æ³•é€‰æ‹©' }, '*');
                    console.error('MD Extractor: iframe has no ID, cannot report selection.');
                    exitPickingMode();
                    return;
                }
                window.top.postMessage({ type: 'elementSelected', selector: workingSelector, iframeId: myId }, '*');
            }

            // æ¸…ç†ä¸´æ—¶å±æ€§
            cleanupTemporaryAttributes(targetElement);

            exitPickingMode();

        } catch (error) {
             if (isTopWindow) {
                showStatus('é€‰æ‹©å…ƒç´ å¤±è´¥ï¼š' + error.message, 'error');
            } else {
                window.top.postMessage({ type: 'selectorError', message: 'é€‰æ‹©å…ƒç´ å¤±è´¥ï¼š' + error.message }, '*');
            }
            console.error('é€‰æ‹©å…ƒç´ å¤±è´¥:', error);
        }
    }

    // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„é€‰æ‹©å™¨ï¼ˆåŸºäºv5.9é€»è¾‘ï¼‰
    // å¢å¼ºé€‰æ‹©å™¨ç”Ÿæˆ - ç‰¹åˆ«ä¼˜åŒ–divå…ƒç´ 
    function generateAllSelectors(el) {
        const selectors = [];

        try {
            debugLog('ä¸ºå…ƒç´ ç”Ÿæˆé€‰æ‹©å™¨:', el.tagName, el.className, el.id);

            // 1. IDé€‰æ‹©å™¨ï¼ˆæœ€å¯é ï¼‰
            if (el.id && !el.id.includes('toolbar') && !el.id.includes('md-extractor')) {
                selectors.push(`#${CSS.escape(el.id)}`);
                debugLog('æ·»åŠ IDé€‰æ‹©å™¨:', `#${el.id}`);
            }

            // 2. æ™ºèƒ½ç±»åé€‰æ‹©å™¨ï¼ˆç‰¹åˆ«é’ˆå¯¹divï¼‰
            if (el.className) {
                const classList = Array.from(el.classList).filter(cls =>
                    cls.length > 1 &&
                    !cls.includes('hover') &&
                    !cls.includes('active') &&
                    !cls.includes('md-extractor') &&
                    !cls.includes('highlight')
                );

                // ä¼˜å…ˆå¤„ç†æœ‰æ„ä¹‰çš„ç±»å
                const meaningfulClasses = classList.filter(cls =>
                    cls.includes('content') ||
                    cls.includes('item') ||
                    cls.includes('row') ||
                    cls.includes('cell') ||
                    cls.includes('container') ||
                    cls.includes('wrapper') ||
                    cls.includes('main') ||
                    cls.includes('list') ||
                    cls.includes('table') ||
                    cls.includes('card') ||
                    cls.includes('panel')
                );

                // å…ˆå°è¯•æœ‰æ„ä¹‰çš„ç±»å
                for (const cls of meaningfulClasses.slice(0, 2)) {
                    selectors.push(`.${CSS.escape(cls)}`);
                    debugLog('æ·»åŠ æœ‰æ„ä¹‰ç±»åé€‰æ‹©å™¨:', `.${cls}`);
                }

                // å†å°è¯•å…¶ä»–ç±»å
                for (const cls of classList.slice(0, 3)) {
                    if (!meaningfulClasses.includes(cls)) {
                        selectors.push(`.${CSS.escape(cls)}`);
                        debugLog('æ·»åŠ æ™®é€šç±»åé€‰æ‹©å™¨:', `.${cls}`);
                    }
                }

                // ç»„åˆç±»åï¼ˆæœ€å¤š2ä¸ªæœ‰æ„ä¹‰çš„ï¼‰
                if (meaningfulClasses.length >= 2) {
                    const combo = meaningfulClasses.slice(0, 2).map(cls => `.${CSS.escape(cls)}`).join('');
                    selectors.push(combo);
                    debugLog('æ·»åŠ ç»„åˆç±»åé€‰æ‹©å™¨:', combo);
                } else if (classList.length >= 2) {
                    const combo = classList.slice(0, 2).map(cls => `.${CSS.escape(cls)}`).join('');
                    selectors.push(combo);
                    debugLog('æ·»åŠ ç»„åˆç±»åé€‰æ‹©å™¨:', combo);
                }
            }

            // 3. æ‰©å±•å±æ€§é€‰æ‹©å™¨
            const attrs = ['data-key', 'data-row-key', 'data-id', 'data-index', 'title', 'role', 'aria-label'];
            for (const attr of attrs) {
                const value = el.getAttribute(attr);
                if (value && value.length < 50 && value.trim()) {
                    selectors.push(`[${attr}="${CSS.escape(value)}"]`);
                    debugLog('æ·»åŠ å±æ€§é€‰æ‹©å™¨:', `[${attr}="${value}"]`);
                }
            }

            // 4. å¢å¼ºä½ç½®é€‰æ‹©å™¨
            const parent = el.parentElement;
            if (parent) {
                const siblings = Array.from(parent.children);
                const index = siblings.indexOf(el);

                if (index >= 0) {
                    // åŸºæœ¬nth-child
                    selectors.push(`${el.tagName.toLowerCase()}:nth-child(${index + 1})`);

                    // å¦‚æœçˆ¶å…ƒç´ æœ‰ç±»åï¼Œæ·»åŠ æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨
                    if (parent.className) {
                        const parentClass = Array.from(parent.classList)[0];
                        if (parentClass && !parentClass.includes('md-extractor')) {
                            selectors.push(`.${CSS.escape(parentClass)} > ${el.tagName.toLowerCase()}:nth-child(${index + 1})`);
                            debugLog('æ·»åŠ çˆ¶ç±»+ä½ç½®é€‰æ‹©å™¨:', `.${parentClass} > ${el.tagName.toLowerCase()}:nth-child(${index + 1})`);
                        }
                    }
                }
            }

            // 5. å†…å®¹ç›¸å…³é€‰æ‹©å™¨ï¼ˆé’ˆå¯¹divï¼‰
            if (el.tagName === 'DIV') {
                const text = el.textContent?.trim();
                if (text && text.length > 0 && text.length < 50) {
                    // é¿å…ç‰¹æ®Šå­—ç¬¦
                    const cleanText = text.replace(/[^\w\s\u4e00-\u9fff]/g, '').trim();
                    if (cleanText.length > 0 && cleanText.length < 30) {
                        selectors.push(`div:contains("${cleanText}")`);
                        debugLog('æ·»åŠ å†…å®¹é€‰æ‹©å™¨:', `div:contains("${cleanText}")`);
                    }
                }
            }

            // 6. æœ€åŸºæœ¬çš„æ ‡ç­¾é€‰æ‹©å™¨
            selectors.push(el.tagName.toLowerCase());

        } catch (e) {
            debugLog('é€‰æ‹©å™¨ç”Ÿæˆå¤±è´¥:', e);
            selectors.push(el.tagName.toLowerCase());
        }

        const uniqueSelectors = [...new Set(selectors)];
        debugLog('ç”Ÿæˆçš„é€‰æ‹©å™¨åˆ—è¡¨:', uniqueSelectors);
        return uniqueSelectors;
    }

    // æ¸…ç†ä¸´æ—¶å±æ€§
    function cleanupTemporaryAttributes(el) {
        if (!el) return;

        try {
            // æ¸…ç†å¯èƒ½è¢«æ·»åŠ çš„ä¸´æ—¶å±æ€§
            const tempAttrs = ['data-text', 'data-temp-id', 'data-emergency'];
            tempAttrs.forEach(attr => {
                if (el.hasAttribute(attr)) {
                    el.removeAttribute(attr);
                    debugLog('æ¸…ç†ä¸´æ—¶å±æ€§:', attr);
                }
            });
        } catch (e) {
            debugLog('æ¸…ç†ä¸´æ—¶å±æ€§å¤±è´¥:', e);
        }
    }

    // å¤‡ç”¨é€‰æ‹©å™¨ç”Ÿæˆå™¨ - æœ€ç®€å•ä½†å¯é çš„æ–¹æ¡ˆ
    function generateFallbackSelector(el) {
        debugLog('ç”Ÿæˆå¤‡ç”¨é€‰æ‹©å™¨ for:', el.tagName, el.className);

        try {
            // æ–¹æ¡ˆ1: å°è¯•ä½¿ç”¨æœ€åŸºæœ¬çš„è·¯å¾„
            const path = [];
            let current = el;
            let depth = 0;

            while (current && current !== document.body && depth < 10) {
                const tagName = current.tagName.toLowerCase();
                const parent = current.parentElement;

                if (parent) {
                    const siblings = Array.from(parent.children).filter(child =>
                        child.tagName.toLowerCase() === tagName
                    );

                    if (siblings.length === 1) {
                        // å¦‚æœæ˜¯å”¯ä¸€çš„è¯¥ç±»å‹æ ‡ç­¾ï¼Œç›´æ¥ä½¿ç”¨æ ‡ç­¾å
                        path.unshift(tagName);
                    } else {
                        // ä½¿ç”¨ä½ç½®ç´¢å¼•
                        const index = siblings.indexOf(current) + 1;
                        path.unshift(`${tagName}:nth-of-type(${index})`);
                    }
                } else {
                    path.unshift(tagName);
                }

                current = parent;
                depth++;
            }

            const pathSelector = path.join(' > ');
            debugLog('ç”Ÿæˆè·¯å¾„é€‰æ‹©å™¨:', pathSelector);

            // éªŒè¯é€‰æ‹©å™¨
            try {
                const found = document.querySelector(pathSelector);
                if (found === el) {
                    debugLog('è·¯å¾„é€‰æ‹©å™¨éªŒè¯æˆåŠŸ');
                    return pathSelector;
                }
            } catch (e) {
                debugLog('è·¯å¾„é€‰æ‹©å™¨éªŒè¯å¤±è´¥:', e);
            }

            // æ–¹æ¡ˆ2: ä½¿ç”¨ä½ç½® + æ–‡æœ¬å†…å®¹
            if (el.textContent && el.textContent.trim()) {
                const text = el.textContent.trim().substring(0, 20);
                const cleanText = text.replace(/[^\w\s\u4e00-\u9fff]/g, '').trim();
                if (cleanText.length > 0) {
                    const contentSelector = `${el.tagName.toLowerCase()}[data-text*="${cleanText}"]`;
                    // ä¸´æ—¶æ·»åŠ å±æ€§ç”¨äºé€‰æ‹©
                    el.setAttribute('data-text', cleanText);
                    debugLog('ç”Ÿæˆå†…å®¹é€‰æ‹©å™¨:', contentSelector);
                    return contentSelector;
                }
            }

            // æ–¹æ¡ˆ3: ä½¿ç”¨ç›¸å¯¹ä½ç½®
            const parent = el.parentElement;
            if (parent) {
                const allSiblings = Array.from(parent.children);
                const index = allSiblings.indexOf(el);
                if (index >= 0) {
                    const positionSelector = `${parent.tagName.toLowerCase()} > *:nth-child(${index + 1})`;
                    debugLog('ç”Ÿæˆä½ç½®é€‰æ‹©å™¨:', positionSelector);
                    return positionSelector;
                }
            }

            // æ–¹æ¡ˆ4: æœ€åçš„å…œåº•æ–¹æ¡ˆ - ä½¿ç”¨å”¯ä¸€çš„ä¸´æ—¶ID
            const fallbackId = 'temp-selector-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            el.setAttribute('data-temp-id', fallbackId);
            const tempSelector = `[data-temp-id="${fallbackId}"]`;
            debugLog('ç”Ÿæˆä¸´æ—¶IDé€‰æ‹©å™¨:', tempSelector);
            return tempSelector;

        } catch (e) {
            debugLog('å¤‡ç”¨é€‰æ‹©å™¨ç”Ÿæˆå¤±è´¥:', e);
            // æœ€ç»ˆå…œåº•
            const emergencyId = 'emergency-' + Date.now();
            el.setAttribute('data-emergency', emergencyId);
            return `[data-emergency="${emergencyId}"]`;
        }
    }

    // æ™ºèƒ½ç±»åé€‰æ‹©å™¨ç”Ÿæˆ - é’ˆå¯¹OAç³»ç»Ÿä¼˜åŒ–
    function generateSmartClassSelector(el) {
        if (!el.className) return null;

        const classes = Array.from(el.classList).filter(cls => {
            // è¿‡æ»¤æ‰ä¸´æ—¶ç±»å’Œé€šç”¨ç±»
            return !cls.includes('hover') &&
                   !cls.includes('highlight') &&
                   !cls.includes('md-extractor') &&
                   !cls.includes('active') &&
                   !cls.includes('focus') &&
                   !cls.includes('selected') &&
                   cls.length > 1;
        });

        if (classes.length === 0) return null;

        // OAç³»ç»Ÿç‰¹æœ‰çš„é«˜ä¼˜å…ˆçº§ç±»å
        const oaPriorityClasses = classes.filter(cls =>
            cls.includes('pending') ||
            cls.includes('list') ||
            cls.includes('table') ||
            cls.includes('content') ||
            cls.includes('main') ||
            cls.includes('body')
        );

        // Ant Designç»„ä»¶ç±»å (ä¸­ç­‰ä¼˜å…ˆçº§)
        const antdClasses = classes.filter(cls => cls.startsWith('ant-'));

        // ä¸šåŠ¡ç›¸å…³ç±»å (é«˜ä¼˜å…ˆçº§)
        const businessClasses = classes.filter(cls =>
            !cls.startsWith('ant-') &&
            !cls.includes('icon') &&
            !cls.includes('btn') &&
            cls.length > 3
        );

        // æŒ‰ä¼˜å…ˆçº§å°è¯•é€‰æ‹©å™¨
        const prioritizedClasses = [
            ...oaPriorityClasses,
            ...businessClasses,
            ...antdClasses.slice(0, 3) // åªå–å‰3ä¸ªantç±»ï¼Œé¿å…è¿‡é•¿
        ];

        // å°è¯•å•ä¸ªç±»å
        for (const cls of prioritizedClasses) {
            const selector = `.${CSS.escape(cls)}`;
            const matches = document.querySelectorAll(selector);
            if (matches.length === 1 && matches[0] === el) {
                return selector;
            }
        }

        // å°è¯•æœ‰æ„ä¹‰çš„ç±»åç»„åˆ
        if (prioritizedClasses.length > 1) {
            // å…ˆå°è¯•ä¸šåŠ¡ç±»+è¡¨ç»“æ„ç±»çš„ç»„åˆ
            const meaningfulCombos = [
                oaPriorityClasses.slice(0, 2),
                businessClasses.slice(0, 2),
                [...oaPriorityClasses.slice(0, 1), ...antdClasses.slice(0, 1)]
            ].filter(combo => combo.length > 0);

            for (const combo of meaningfulCombos) {
                const combinedSelector = combo.map(cls => `.${CSS.escape(cls)}`).join('');
                const matches = document.querySelectorAll(combinedSelector);
                if (matches.length >= 1 && matches.length <= 5 && Array.from(matches).includes(el)) {
                    return combinedSelector;
                }
            }
        }

        return null;
    }

    // OAç³»ç»Ÿé€‰æ‹©å™¨ä¼˜åŒ–å‡½æ•°
    function optimizeForOASystem(validSelectors, targetElement) {
        // æŒ‰OAç³»ç»Ÿé‡è¦æ€§æ’åºé€‰æ‹©å™¨
        const scoredSelectors = validSelectors.map(({ selector, score }) => {
            let oaScore = score;

            // ä¸šåŠ¡ä¼˜å…ˆçº§åŠ åˆ†
            if (selector.includes('pending')) oaScore += 50;
            if (selector.includes('list-main')) oaScore += 40;
            if (selector.includes('table-body')) oaScore += 35;
            if (selector.includes('content')) oaScore += 30;

            // Ant Designç»„ä»¶åŠ åˆ†
            if (selector.includes('ant-table-row')) oaScore += 25;
            if (selector.includes('ant-table-cell')) oaScore += 20;
            if (selector.includes('ant-list-item')) oaScore += 20;

            // å±æ€§é€‰æ‹©å™¨åŠ åˆ†
            if (selector.includes('[fiber-id=')) oaScore += 15;
            if (selector.includes('[data-row-key=')) oaScore += 15;
            if (selector.includes('[data-v-')) oaScore += 10;

            // é¿å…è¿‡é•¿é€‰æ‹©å™¨æ‰£åˆ†
            if (selector.length > 100) oaScore -= 20;
            if (selector.split(' ').length > 5) oaScore -= 10;

            return { selector, oaScore };
        });

        // é€‰æ‹©å¾—åˆ†æœ€é«˜çš„é€‰æ‹©å™¨
        scoredSelectors.sort((a, b) => b.oaScore - a.oaScore);
        return scoredSelectors[0]?.selector;
    }

    // ç”ŸæˆåŸºäºå±æ€§çš„é€‰æ‹©å™¨ - é’ˆå¯¹OAç³»ç»Ÿä¼˜åŒ–
    function generateAttributeBasedSelector(el) {
        const selectors = [];

        // OAç³»ç»Ÿå¸¸è§çš„æœ‰æ„ä¹‰å±æ€§
        const meaningfulAttrs = [
            'data-key', 'data-row-key', 'data-node-key',
            'fiber-id', 'data-v-*', 'title', 'role',
            'aria-label', 'data-testid', 'name'
        ];

        for (const attr of meaningfulAttrs) {
            if (attr.includes('*')) {
                // å¤„ç†é€šé…ç¬¦å±æ€§
                const prefix = attr.replace('*', '');
                for (const actualAttr of el.getAttributeNames()) {
                    if (actualAttr.startsWith(prefix)) {
                        const value = el.getAttribute(actualAttr);
                        if (value && value.length < 50 && !value.includes('toolbar')) {
                            selectors.push(`[${actualAttr}="${CSS.escape(value)}"]`);
                        }
                    }
                }
            } else if (el.hasAttribute(attr)) {
                const value = el.getAttribute(attr);
                if (value && value.length < 50 && !value.includes('toolbar')) {
                    selectors.push(`[${attr}="${CSS.escape(value)}"]`);
                }
            }
        }

        // ç»„åˆé€‰æ‹©å™¨ï¼šç±»å + å±æ€§
        if (el.className) {
            const classes = Array.from(el.classList).filter(cls =>
                cls.includes('table') ||
                cls.includes('list') ||
                cls.includes('pending') ||
                cls.startsWith('ant-table') ||
                cls.startsWith('ant-list')
            );

            for (const cls of classes) {
                for (const attr of meaningfulAttrs) {
                    if (!attr.includes('*') && el.hasAttribute(attr)) {
                        const value = el.getAttribute(attr);
                        if (value && value.length < 30) {
                            selectors.push(`.${CSS.escape(cls)}[${attr}="${CSS.escape(value)}"]`);
                        }
                    }
                }
            }
        }

        // 4. ç±»åé€‰æ‹©å™¨ï¼ˆè¿‡æ»¤æ‰è„šæœ¬æ·»åŠ çš„ç±»ï¼‰
        if (el.className && typeof el.className === 'string') {
            const classes = el.className.split(/\s+/).filter(cls =>
                cls &&
                /^[a-zA-Z_-][\w-]*$/.test(cls) &&
                !cls.startsWith('md-extractor') // è¿‡æ»¤æ‰è„šæœ¬æ·»åŠ çš„ç±»
            );

            if (classes.length > 0) {
                try {
                    // å°è¯•å•ä¸ªç±»
                    for (const cls of classes) {
                        selectors.push(`.${CSS.escape ? CSS.escape(cls) : cls}`);
                    }

                    // å°è¯•ç»„åˆç±»ï¼ˆé™åˆ¶æ•°é‡é¿å…è¿‡äºå¤æ‚ï¼‰
                    if (classes.length > 1) {
                        const combined = classes.slice(0, 3).map(cls =>
                            CSS.escape ? CSS.escape(cls) : cls
                        ).join('.');
                        selectors.push(`.${combined}`);
                    }
                } catch (e) {
                    console.warn('ç±»é€‰æ‹©å™¨ç”Ÿæˆå¤±è´¥:', e);
                }
            }
        }

        return selectors;
    }

    // ç”Ÿæˆç®€åŒ–çš„è·¯å¾„é€‰æ‹©å™¨
    function generateSimplePath(el) {
        const path = [];
        let current = el;
        let depth = 0;
        const maxDepth = 5; // é™åˆ¶è·¯å¾„æ·±åº¦

        while (current && current !== document.body && depth < maxDepth) {
            let selector = current.tagName.toLowerCase();

            // æ·»åŠ é‡è¦çš„å±æ€§ä¿¡æ¯
            if (current.id) {
                try {
                    const escapedId = CSS.escape ? CSS.escape(current.id) : current.id;
                    selector = `${selector}#${escapedId}`;
                } catch (e) {
                    console.warn('è·¯å¾„ä¸­IDå¤„ç†å¤±è´¥:', e);
                }
            } else if (current.className && typeof current.className === 'string') {
                const classes = current.className.split(/\s+/)
                    .filter(cls => cls &&
                        /^[a-zA-Z_-][\w-]*$/.test(cls) &&
                        !cls.startsWith('md-extractor') // è¿‡æ»¤æ‰è„šæœ¬æ·»åŠ çš„ç±»
                    )
                    .slice(0, 2); // åªå–å‰ä¸¤ä¸ªç±»

                if (classes.length > 0) {
                    try {
                        const escapedClasses = classes.map(cls =>
                            CSS.escape ? CSS.escape(cls) : cls
                        ).join('.');
                        selector = `${selector}.${escapedClasses}`;
                    } catch (e) {
                        console.warn('è·¯å¾„ä¸­ç±»å¤„ç†å¤±è´¥:', e);
                    }
                }
            }

            path.unshift(selector);
            current = current.parentElement;
            depth++;
        }

        return path.length > 0 ? path.join(' > ') : '';
    }

    // ç”Ÿæˆç®€å•çš„ä½ç½®é€‰æ‹©å™¨
    function generateSimplePositionSelector(el) {
        if (!el.parentElement) return '';

        const parent = el.parentElement;
        const siblings = Array.from(parent.children);
        const index = siblings.indexOf(el);

        if (index === -1) return '';

        const tagName = el.tagName.toLowerCase();

        // å¦‚æœçˆ¶å…ƒç´ æœ‰IDï¼Œä½¿ç”¨çˆ¶ID + å­å…ƒç´ ä½ç½®
        if (parent.id) {
            try {
                const parentId = CSS.escape ? CSS.escape(parent.id) : parent.id;
                return `#${parentId} > ${tagName}:nth-child(${index + 1})`;
            } catch (e) {
                console.warn('çˆ¶å…ƒç´ IDé€‰æ‹©å™¨ç”Ÿæˆå¤±è´¥:', e);
            }
        }

        // å¦‚æœçˆ¶å…ƒç´ æœ‰å”¯ä¸€ç±»å
        if (parent.className && typeof parent.className === 'string') {
            const classes = parent.className.split(/\s+/).filter(cls =>
                cls &&
                /^[a-zA-Z_-][\w-]*$/.test(cls) &&
                !cls.startsWith('md-extractor') // è¿‡æ»¤æ‰è„šæœ¬æ·»åŠ çš„ç±»
            );

            if (classes.length > 0) {
                try {
                    const parentClass = CSS.escape ? CSS.escape(classes[0]) : classes[0];
                    const parentSelector = `.${parentClass}`;

                    // æµ‹è¯•çˆ¶é€‰æ‹©å™¨æ˜¯å¦å”¯ä¸€
                    const parentElements = document.querySelectorAll(parentSelector);
                    if (parentElements.length === 1) {
                        return `${parentSelector} > ${tagName}:nth-child(${index + 1})`;
                    }
                } catch (e) {
                    console.warn('çˆ¶å…ƒç´ ç±»é€‰æ‹©å™¨ç”Ÿæˆå¤±è´¥:', e);
                }
            }
        }

        // ä½¿ç”¨çˆ¶æ ‡ç­¾å
        return `${parent.tagName.toLowerCase()} > ${tagName}:nth-child(${index + 1})`;
    }

    // æ¸…ç†æ—§çš„å¤‡ç”¨å‡½æ•°ï¼Œæ›¿æ¢ä¸ºæ›´å¯é çš„å®ç°
    function generateUniqueSelector(el) {
        if (!el || !el.tagName) return '';

        const selectors = generateAllSelectors(el);

        // è¿”å›ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„é€‰æ‹©å™¨
        for (const selector of selectors) {
            if (testSelector(selector, el)) {
                return selector;
            }
        }

        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é€‰æ‹©å™¨ï¼Œå°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ªèƒ½åŒ¹é…åˆ°ç›®æ ‡å…ƒç´ çš„é€‰æ‹©å™¨
        for (const selector of selectors) {
            try {
                const found = document.querySelector(selector);
                if (found === el) {
                    return selector;
                }
            } catch (e) {
                // å¿½ç•¥æ— æ•ˆé€‰æ‹©å™¨
            }
        }

        // å¦‚æœæ‰€æœ‰é€‰æ‹©å™¨éƒ½å¤±è´¥ï¼Œè¿”å›æ ‡ç­¾å
        return el.tagName.toLowerCase();
    }

    function handleKeyDown(event) {
        if (isPickingMode && event.key === 'Escape') {
            event.preventDefault();
            exitPickingMode();
        }
    }

    // æµ‹è¯•é€‰æ‹©å™¨æ˜¯å¦æœ‰æ•ˆï¼ˆç®€åŒ–ç‰ˆï¼‰
    function testSelector(selector, expectedElement) {
        if (!selector || !expectedElement) return false;

        try {
            // ä¸´æ—¶ç§»é™¤è„šæœ¬æ·»åŠ çš„ç±»
            const tempRemovedClasses = [];
            [CONFIG.HIGHLIGHT_CLASS, CONFIG.HOVER_HIGHLIGHT_CLASS].forEach(cls => {
                if (expectedElement.classList.contains(cls)) {
                    expectedElement.classList.remove(cls);
                    tempRemovedClasses.push(cls);
                }
            });

            let isValid = false;
            let uniquenessScore = 0;
            try {
                const found = document.querySelector(selector);
                isValid = found === expectedElement;

                if (isValid) {
                    // æ£€æŸ¥é€‰æ‹©å™¨çš„å”¯ä¸€æ€§
                    const allMatches = document.querySelectorAll(selector);
                    uniquenessScore = allMatches.length === 1 ? 100 : Math.max(1, 100 - allMatches.length);

                    if (allMatches.length === 1) {
                        console.log(`âœ…é€‰æ‹©å™¨æµ‹è¯•æˆåŠŸ(å”¯ä¸€): "${selector}"`);
                    } else {
                        console.log(`âš ï¸é€‰æ‹©å™¨æµ‹è¯•æˆåŠŸä½†ä¸å”¯ä¸€: "${selector}" (åŒ¹é…${allMatches.length}ä¸ªå…ƒç´ , åˆ†æ•°:${uniquenessScore})`);
                    }
                } else {
                    console.log(`âŒé€‰æ‹©å™¨æµ‹è¯•å¤±è´¥: "${selector}"`, found);
                }
            } catch (queryError) {
                console.warn(`é€‰æ‹©å™¨ "${selector}" è¯­æ³•é”™è¯¯:`, queryError);
            }

            // ä¸ºé€‰æ‹©å™¨æ·»åŠ è´¨é‡åˆ†æ•°
            if (isValid && selector.score === undefined) {
                selector.score = uniquenessScore;
            }

            // æ¢å¤åŸæ¥çš„ç±»
            tempRemovedClasses.forEach(cls => expectedElement.classList.add(cls));

            return isValid;
        } catch (e) {
            return false;
        }
    }

    // æ¸…ç†äº†å¤æ‚çš„é€‰æ‹©å™¨å‡½æ•°ï¼Œä¿ç•™ç®€å•æœ‰æ•ˆçš„é€»è¾‘

    // ç”Ÿæˆnth-childé€‰æ‹©å™¨
    function generateNthChildSelector(el) {
        const path = [];
        let current = el;
        let depth = 0;
        const maxDepth = 4; // é™åˆ¶æ·±åº¦

        while (current && current.parentElement && depth < maxDepth) {
            const parent = current.parentElement;
            const siblings = Array.from(parent.children);
            const index = siblings.indexOf(current) + 1;

            let selector = current.tagName.toLowerCase();

            // å¦‚æœæœ‰å…„å¼Ÿå…ƒç´ ï¼Œæ·»åŠ nth-child
            if (siblings.length > 1) {
                selector += `:nth-child(${index})`;
            }

            path.unshift(selector);
            current = parent;
            depth++;

            // å¦‚æœåˆ°è¾¾äº†æœ‰IDçš„å…ƒç´ ï¼Œå°±åœæ­¢
            if (current.id) {
                try {
                    const escapedId = CSS.escape ? CSS.escape(current.id) : current.id;
                    path.unshift(`#${escapedId}`);
                } catch (e) {
                    console.warn('nth-childè·¯å¾„ä¸­IDå¤„ç†å¤±è´¥:', e);
                }
                break;
            }
        }

        return path.length > 0 ? path.join(' > ') : '';
    }

    // ç”ŸæˆåŸºäºæ–‡æœ¬å†…å®¹çš„é€‰æ‹©å™¨ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
    function generateTextBasedSelector(el) {
        const text = (el.textContent || '').trim();
        if (!text || text.length > 50) return '';

        // å¯¹äºåŒ…å«ç‰¹å®šæ–‡æœ¬çš„å…ƒç´ ï¼Œç”Ÿæˆä¸€ä¸ªç›¸å¯¹è·¯å¾„
        const tagName = el.tagName.toLowerCase();
        const parent = el.parentElement;

        if (parent) {
            const parentSelector = parent.id ?
                `#${CSS.escape ? CSS.escape(parent.id) : parent.id}` :
                parent.tagName.toLowerCase();

            // æŸ¥æ‰¾åŒçº§ä¸­åŒ…å«æ­¤æ–‡æœ¬çš„å…ƒç´ 
            const siblings = Array.from(parent.children);
            const sameTextSiblings = siblings.filter(sibling =>
                sibling.textContent && sibling.textContent.trim() === text
            );

            if (sameTextSiblings.length === 1) {
                return `${parentSelector} > ${tagName}`;
            }
        }

        return '';
    }

    // =================================================================================
    // --- æ ¸å¿ƒæå–é€»è¾‘ (Core Extraction Logic) ---
    // =================================================================================
    async function extractAndCopy() {
        if (selectionContext.source === 'iframe') {
            let iframeEl = document.getElementById(selectionContext.iframeId);

            // å¦‚æœé€šè¿‡IDæ‰¾ä¸åˆ°ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
            if (!iframeEl && selectionContext.iframeId) {
                console.warn('é€šè¿‡IDæœªæ‰¾åˆ°iframeï¼Œå°è¯•æŸ¥æ‰¾æ‰€æœ‰iframe');
                const iframes = document.querySelectorAll('iframe');
                for (let iframe of iframes) {
                    if (iframe.id === selectionContext.iframeId ||
                        iframe.id.includes('mde-iframe')) {
                        iframeEl = iframe;
                        console.log('æ‰¾åˆ°å¤‡é€‰iframe:', iframe.id);
                        break;
                    }
                }
            }

            if (iframeEl) {
                showStatus('æ­£åœ¨ä»iframeæå–...', 'info');
                console.log('Requesting extraction from iframe:', selectionContext.iframeId, 'with selector:', selectionContext.selector);
                const autoExpand = document.getElementById('auto-expand').checked;
                const structuredMode = document.getElementById('structured-mode').checked;
                iframeEl.contentWindow.postMessage({
                    type: 'doExtract',
                    selector: selectionContext.selector,
                    autoExpand,
                    structuredMode
                }, '*');
            } else {
                showStatus('é”™è¯¯: æ‰¾ä¸åˆ°æºiframeã€‚å°è¯•åœ¨å½“å‰é¡µé¢æå–...', 'warning');
                // é™çº§åˆ°å½“å‰é¡µé¢æå–
                selectionContext.source = 'top';
                const selectorInput = document.getElementById('selector-input');
                if (selectorInput && selectionContext.selector) {
                    selectorInput.value = selectionContext.selector;
                    // é€’å½’è°ƒç”¨ï¼Œç°åœ¨ä½¿ç”¨topæ¨¡å¼
                    await extractAndCopy();
                    return;
                } else {
                    showStatus('æ— æ³•æå–ï¼šé€‰æ‹©å™¨ä¸¢å¤±', 'error');
                }
            }
            return;
        }

        const selectorInput = document.getElementById('selector-input');
        if (!selectorInput) {
            showStatus('UIå…ƒç´ æœªæ‰¾åˆ°', 'error');
            return;
        }

        const selector = selectorInput.value.trim();
        if (!selector) {
            showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…ƒç´ ', 'error');
            return;
        }

        try {
            const element = document.querySelector(selector);
            if (!element) {
                showStatus('æœªæ‰¾åˆ°å…ƒç´ ï¼Œè¯·é‡æ–°é€‰æ‹©', 'error');
                return;
            }

            showStatus('æ­£åœ¨å‡†å¤‡æå–...', 'info');

            const autoExpandCheckbox = document.getElementById('auto-expand');
            if (autoExpandCheckbox && autoExpandCheckbox.checked) {
                await autoExpandContent(element);
            }

            const structuredModeCheckbox = document.getElementById('structured-mode');
            const structuredMode = structuredModeCheckbox ? structuredModeCheckbox.checked : true;

            showStatus('æ­£åœ¨æå–å†…å®¹...', 'info');
            const content = processExtraction(element, structuredMode);

            if (content && content.trim()) {
                console.log('å†…å®¹æå–æˆåŠŸï¼Œé•¿åº¦:', content.length);
                // å…ˆå°è¯•è‡ªåŠ¨å¤åˆ¶
                const copySuccess = await copyToClipboard(content);

                // å¦‚æœè‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œå›é€€åˆ°æ‰‹åŠ¨å¤åˆ¶
                if (!copySuccess) {
                    console.log('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨å¤åˆ¶å¯¹è¯æ¡†');
                    showManualCopyDialog(content);
                    showStatus('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'info');
                }
            } else {
                showStatus('æå–å†…å®¹ä¸ºç©º', 'error');
            }
        } catch (error) {
            showStatus(`æå–å¤±è´¥: ${error.message}`, 'error');
            console.error("æå–é”™è¯¯:", error);
        }
    }

    // æ‰‹åŠ¨å¤åˆ¶å¯¹è¯æ¡†
    function showManualCopyDialog(content) {
        // åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§å¯¹è¯æ¡†
        const existingDialog = document.getElementById('manual-copy-dialog');
        if (existingDialog) {
            existingDialog.remove();
        }

        // åˆ›å»ºé®ç½©å±‚
        const overlay = document.createElement('div');
        overlay.id = 'manual-copy-overlay';
        overlay.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.5) !important;
            z-index: 1000000 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        `;

        // åˆ›å»ºå¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.id = 'manual-copy-dialog';
        dialog.style.cssText = `
            width: 80% !important;
            max-width: 800px !important;
            max-height: 80% !important;
            background: white !important;
            border: 2px solid #007bff !important;
            border-radius: 8px !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
            overflow: hidden !important;
        `;

        dialog.innerHTML = `
            <div style="background: #007bff; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 16px;">ğŸ“‹ æ‰‹åŠ¨å¤åˆ¶å†…å®¹</h3>
                <button id="close-dialog" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; width: 24px; height: 24px; line-height: 1;">Ã—</button>
            </div>
            <div style="padding: 20px;">
                <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">
                    å†…å®¹å·²æå–å®Œæˆï¼Œè¯·é€‰æ‹©ä»¥ä¸‹æ–‡æœ¬å¹¶æ‰‹åŠ¨å¤åˆ¶ (Ctrl+C æˆ– Cmd+C)ï¼š
                </p>
                <textarea id="manual-copy-textarea" readonly style="
                    width: 100%;
                    height: 400px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    padding: 10px;
                    font-family: 'SF Mono', 'Courier New', monospace;
                    font-size: 13px;
                    line-height: 1.4;
                    resize: vertical;
                    box-sizing: border-box;
                ">${content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                <div style="margin-top: 15px; text-align: center;">
                    <button id="select-all-btn" style="
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        margin-right: 10px;
                        font-size: 14px;
                        transition: background 0.2s;
                    ">å…¨é€‰å†…å®¹</button>
                    <button id="close-dialog-btn" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: background 0.2s;
                    ">å…³é—­</button>
                </div>
                <div style="margin-top: 10px; text-align: center; color: #666; font-size: 12px;">
                    æç¤ºï¼šé€‰ä¸­æ–‡æœ¬åä½¿ç”¨ Ctrl+C (Windows) æˆ– Cmd+C (Mac) å¤åˆ¶
                </div>
            </div>
        `;

        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        // è‡ªåŠ¨é€‰æ‹©æ‰€æœ‰æ–‡æœ¬
        const textarea = dialog.querySelector('#manual-copy-textarea');
        setTimeout(() => {
            textarea.focus();
            textarea.select();
        }, 100);

        // ç»‘å®šäº‹ä»¶
        const closeBtn = dialog.querySelector('#close-dialog');
        const closeBtnBottom = dialog.querySelector('#close-dialog-btn');
        const selectAllBtn = dialog.querySelector('#select-all-btn');

        const closeDialog = () => {
            if (document.body.contains(overlay)) {
                document.body.removeChild(overlay);
            }
        };

        closeBtn.addEventListener('click', closeDialog);
        closeBtnBottom.addEventListener('click', closeDialog);

        selectAllBtn.addEventListener('click', () => {
            textarea.focus();
            textarea.select();
        });

        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                closeDialog();
            }
        });

        // ESCé”®å…³é—­
        const handleKeydown = (e) => {
            if (e.key === 'Escape') {
                closeDialog();
                document.removeEventListener('keydown', handleKeydown);
            }
        };
        document.addEventListener('keydown', handleKeydown);

        // æ·»åŠ æŒ‰é’®æ‚¬åœæ•ˆæœ
        const buttons = dialog.querySelectorAll('button');
        buttons.forEach(button => {
            button.addEventListener('mouseenter', () => {
                if (button.style.background === 'rgb(0, 123, 255)') {
                    button.style.background = '#0056b3';
                } else if (button.style.background === 'rgb(108, 117, 125)') {
                    button.style.background = '#5a6268';
                }
            });
            button.addEventListener('mouseleave', () => {
                if (button.id === 'select-all-btn') {
                    button.style.background = '#007bff';
                } else if (button.id === 'close-dialog-btn') {
                    button.style.background = '#6c757d';
                }
            });
        });
    }

    // æ™ºèƒ½æŸ¥æ‰¾æœ€ä½³çš„è¡¨æ ¼å®¹å™¨å…ƒç´ 
    function findOptimalTableContainer(element) {
        if (!element) return element;

        // å¦‚æœå½“å‰å…ƒç´ å°±åŒ…å«è¡¨æ ¼ï¼Œç›´æ¥è¿”å›
        if (element.tagName === 'TABLE' || element.querySelector('table')) {
            console.log(`[MD Extractor] å½“å‰å…ƒç´  ${element.tagName} åŒ…å«è¡¨æ ¼ï¼Œæ— éœ€ä¼˜åŒ–`);
            return element;
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºOAç³»ç»Ÿçš„è¡¨æ ¼å®¹å™¨
        if (element.matches && (element.matches('[class*="multiRowVariableColumn"]') ||
                               element.matches('[class*="h-editgird"]') ||
                               element.matches('[style*="overflow"]'))) {
            console.log(`[MD Extractor] å½“å‰å…ƒç´ æ˜¯OAå®¹å™¨ï¼Œæ— éœ€ä¼˜åŒ–`);
            return element;
        }

        // å‘ä¸ŠæŸ¥æ‰¾åŒ…å«è¡¨æ ¼çš„çˆ¶å…ƒç´ 
        let current = element.parentElement;
        while (current && current !== document.body) {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«è¡¨æ ¼
            if (current.querySelector('table')) {
                console.log(`[MD Extractor] æ‰¾åˆ°åŒ…å«è¡¨æ ¼çš„çˆ¶å…ƒç´ : ${current.tagName}.${current.className}`);
                return current;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºOAç³»ç»Ÿçš„è¡¨æ ¼å®¹å™¨
            if (current.matches && (current.matches('[class*="multiRowVariableColumn"]') ||
                                   current.matches('[class*="h-editgird"]') ||
                                   current.matches('[style*="overflow"]'))) {
                console.log(`[MD Extractor] æ‰¾åˆ°OAå®¹å™¨çˆ¶å…ƒç´ : ${current.tagName}.${current.className}`);
                return current;
            }

            current = current.parentElement;
        }

        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ›´å¥½çš„å®¹å™¨ï¼Œè¿”å›åŸå§‹å…ƒç´ 
        console.log(`[MD Extractor] æœªæ‰¾åˆ°æ›´å¥½çš„å®¹å™¨ï¼Œä½¿ç”¨åŸå§‹å…ƒç´ `);
        return element;
    }

    function processExtraction(element, structuredMode) {
        if (!element) return '';

        console.log(`[MD Extractor] å¼€å§‹å¤„ç†å…ƒç´ : ${element.tagName}.${element.className} (${element.id})`);
        console.log(`[MD Extractor] ç»“æ„åŒ–æ¨¡å¼: ${structuredMode}`);

        // æ™ºèƒ½å…ƒç´ æ£€æµ‹ï¼šå¦‚æœç”¨æˆ·é€‰æ‹©äº†ä¸åŒ…å«è¡¨æ ¼çš„åµŒå¥—å…ƒç´ ï¼Œè‡ªåŠ¨æ‰¾åˆ°åŒ…å«è¡¨æ ¼çš„çˆ¶å…ƒç´ 
        const optimizedElement = findOptimalTableContainer(element);
        if (optimizedElement !== element) {
            console.log(`[MD Extractor] è‡ªåŠ¨ä¼˜åŒ–é€‰æ‹©: ä» ${element.tagName}.${element.className} è°ƒæ•´ä¸º ${optimizedElement.tagName}.${optimizedElement.className}`);
            element = optimizedElement;
        }

        const clone = element.cloneNode(true);

        // æ¸…ç†åƒåœ¾å…ƒç´ ï¼Œä½†ä¿æŠ¤è¡¨æ ¼å†…å®¹
        CONFIG.JUNK_SELECTORS.forEach(selector => {
            try {
                clone.querySelectorAll(selector).forEach(junk => {
                    // å¦‚æœæ˜¯è¡¨æ ¼å†…çš„å†…å®¹ï¼Œè·³è¿‡æ¸…ç†
                    if (junk.closest('table, tbody, tr, td, th, .h-editgird, .h-editgird-wrapper')) {
                        return;
                    }
                    if (junk.parentNode) {
                        junk.parentNode.removeChild(junk);
                    }
                });
            } catch (e) {
                console.warn(`[MD Extractor] Invalid selector: ${selector}`, e);
            }
        });

        // æ™ºèƒ½æ¸…ç†onclickå…ƒç´ 
        const onClickElements = clone.querySelectorAll('[onclick]');
        console.log(`[MD Extractor] æ‰¾åˆ° ${onClickElements.length} ä¸ªonclickå…ƒç´ `);
        onClickElements.forEach(element => {
            const shouldRemove = shouldRemoveOnClickElement(element);
            console.log(`[MD Extractor] onclickå…ƒç´ å†³ç­–: "${element.textContent}" -> ${shouldRemove ? 'åˆ é™¤' : 'ä¿ç•™'}`);
            if (shouldRemove) {
                if (element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            }
        });

        if (structuredMode) {
            return extractStructuredData(clone);
        } else {
            return nodeToMarkdown(clone);
        }
    }

    function extractStructuredData(element) {
        // ä¸è‡ªåŠ¨æ·»åŠ é¡µé¢titleä½œä¸ºä¸€çº§æ ‡é¢˜ï¼Œè®©é€‰å®šåŒºåŸŸå†…çš„h1-h6è‡ªç„¶è½¬æ¢
        let markdown = '';
        console.log(`[MD Extractor] extractStructuredDataå¼€å§‹å¤„ç†: ${element.tagName}.${element.className}`);

        // ç›´æ¥å¤„ç†ç”¨æˆ·é€‰æ‹©çš„å…ƒç´ ï¼Œç¡®ä¿ä¸HTMLç»“æ„ä¿æŒä¸€è‡´
        // ä½¿ç”¨å…±äº«çš„processedElementsæ¥é¿å…é‡å¤å¤„ç†
        const processedElements = new Set();
        const contentMarkdown = nodeToMarkdown(element, processedElements);
        console.log(`[MD Extractor] nodeToMarkdownè¿”å›é•¿åº¦: ${contentMarkdown ? contentMarkdown.length : 0}`);

        if (contentMarkdown && contentMarkdown.trim()) {
            // å¦‚æœå½“å‰markdownä¸ä¸ºç©ºä¸”æ–°å†…å®¹æ˜¯ä»£ç å—ï¼Œç¡®ä¿å‰é¢æœ‰æ¢è¡Œ
            if (markdown.trim() && contentMarkdown.includes('```')) {
                if (!markdown.endsWith('\n')) {
                    markdown += '\n';
                }
            }
            markdown += contentMarkdown;
        }

        // ä¼˜åŒ–æœ€ç»ˆæ ¼å¼ï¼Œåªåœ¨ä»£ç å—å‰æ·»åŠ æ¢è¡Œ
        return markdown
            .replace(/([^\n])```/g, '$1\n```')              // åªåœ¨ä»£ç å—å‰æ·»åŠ ä¸€ä¸ªæ¢è¡Œ
            .replace(/\n +/g, '\n')                         // ç§»é™¤è¡Œé¦–å¤šä½™ç©ºæ ¼
            .replace(/^ +/g, '')                            // ç§»é™¤å¼€å¤´çš„ç©ºæ ¼
            .replace(/^\s+|\s+$/g, '')                      // å»é™¤é¦–å°¾ç©ºç™½
            .trim();
    }

    // æ£€æŸ¥tableå…ƒç´ æ˜¯å¦ä¸ºHUIè¡¨æ ¼çš„ä¸€éƒ¨åˆ†
    function checkIfPartOfHUITable(tableElement) {
        // æ£€æŸ¥tableæ˜¯å¦åœ¨.h-table-headeræˆ–.h-table-bodyå®¹å™¨ä¸­
        let parent = tableElement.parentElement;
        while (parent) {
            const classList = parent.classList;
            if (classList && (classList.contains('h-table-header') || classList.contains('h-table-body'))) {
                console.log(`[MD Extractor] å‘ç°HUIè¡¨æ ¼å®¹å™¨: ${parent.className}`);
                return true;
            }
            parent = parent.parentElement;
        }
        return false;
    }

    // æ£€æŸ¥å¹¶å¤„ç†å®Œæ•´çš„HUIè¡¨æ ¼ç»“æ„ - åªåœ¨å®¹å™¨é€‰æ‹©æ—¶åˆå¹¶
    function processHUITableIfPresent(node, processedElements) {
        const classList = node.classList;
        if (!classList) return null;

        // åªåœ¨é‡åˆ°å®Œæ•´çš„h-tableå®¹å™¨æ—¶æ‰è¿›è¡Œåˆå¹¶å¤„ç†
        // å¦‚æœæ˜¯å•ç‹¬çš„h-table-headeræˆ–h-table-bodyï¼Œè®©å®ƒä»¬æ­£å¸¸å¤„ç†
        if (classList.contains('h-table')) {
            console.log(`[MD Extractor] å‘ç°å®Œæ•´HUIè¡¨æ ¼å®¹å™¨: ${node.className}`);

            // æŸ¥æ‰¾headerå’Œbody
            const headerContainer = node.querySelector('.h-table-header');
            const bodyContainer = node.querySelector('.h-table-body');

            if (headerContainer && bodyContainer) {
                console.log('[MD Extractor] æ‰¾åˆ°å®Œæ•´çš„HUIè¡¨æ ¼ç»“æ„ï¼Œå¼€å§‹åˆå¹¶å¤„ç†');

                // æ ‡è®°è¿™äº›å®¹å™¨ä¸ºå·²å¤„ç†
                processedElements.add(headerContainer);
                processedElements.add(bodyContainer);

                // æå–headerå’Œbodyä¸­çš„table
                const headerTable = headerContainer.querySelector('table');
                const bodyTable = bodyContainer.querySelector('table');

                if (headerTable && bodyTable) {
                    processedElements.add(headerTable);
                    processedElements.add(bodyTable);

                    // åˆå¹¶æå–è¡¨æ ¼æ•°æ®
                    const headerData = extractTableData(headerTable);
                    const bodyData = extractTableData(bodyTable);

                    if (headerData && bodyData) {
                        // åˆå¹¶headerå’Œbodyçš„æ•°æ®
                        const combinedTable = mergeHUITableData(headerData, bodyData);
                        console.log(`[MD Extractor] HUIè¡¨æ ¼åˆå¹¶å®Œæˆï¼Œæ€»é•¿åº¦: ${combinedTable.length}`);
                        return combinedTable;
                    }
                }
            }
        }


        return null;
    }

    // å°è¯•åˆå¹¶å®Œæ•´çš„HUIè¡¨æ ¼ - ç”¨äºé€šç”¨æå–æ™ºèƒ½åˆå¹¶
    function tryMergeCompleteHUITable(currentNode, processedElements) {
        console.log(`[MD Extractor] å°è¯•æ™ºèƒ½åˆå¹¶HUIè¡¨æ ¼: ${currentNode.className}`);

        // æŸ¥æ‰¾çˆ¶çº§çš„h-tableå®¹å™¨
        let hTableContainer = null;
        let parent = currentNode.parentElement;

        while (parent) {
            if (parent.classList && parent.classList.contains('h-table')) {
                hTableContainer = parent;
                break;
            }
            parent = parent.parentElement;
        }

        if (!hTableContainer) {
            console.log('[MD Extractor] æœªæ‰¾åˆ°h-tableå®¹å™¨ï¼Œæ— æ³•æ™ºèƒ½åˆå¹¶');
            return null;
        }

        console.log(`[MD Extractor] æ‰¾åˆ°h-tableå®¹å™¨: ${hTableContainer.className}`);

        // æŸ¥æ‰¾headerå’Œbody
        const headerContainer = hTableContainer.querySelector('.h-table-header');
        const bodyContainer = hTableContainer.querySelector('.h-table-body');

        if (!headerContainer || !bodyContainer) {
            console.log('[MD Extractor] HUIè¡¨æ ¼ç»“æ„ä¸å®Œæ•´ï¼Œæ— æ³•åˆå¹¶');
            return null;
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç»è¢«å¤„ç†è¿‡
        if (processedElements.has(headerContainer) || processedElements.has(bodyContainer) || processedElements.has(hTableContainer)) {
            console.log('[MD Extractor] HUIè¡¨æ ¼å·²è¢«å¤„ç†ï¼Œé¿å…é‡å¤');
            return null;
        }

        console.log('[MD Extractor] å¼€å§‹æ™ºèƒ½åˆå¹¶å®Œæ•´HUIè¡¨æ ¼');

        // æ ‡è®°ç›¸å…³å…ƒç´ ä¸ºå·²å¤„ç†
        processedElements.add(hTableContainer);
        processedElements.add(headerContainer);
        processedElements.add(bodyContainer);

        // æå–headerå’Œbodyä¸­çš„table
        const headerTable = headerContainer.querySelector('table');
        const bodyTable = bodyContainer.querySelector('table');

        if (headerTable && bodyTable) {
            processedElements.add(headerTable);
            processedElements.add(bodyTable);

            // åˆå¹¶æå–è¡¨æ ¼æ•°æ®
            const headerData = extractTableData(headerTable);
            const bodyData = extractTableData(bodyTable);

            if (headerData && bodyData) {
                const combinedTable = mergeHUITableData(headerData, bodyData);
                console.log(`[MD Extractor] æ™ºèƒ½åˆå¹¶HUIè¡¨æ ¼å®Œæˆï¼Œæ€»é•¿åº¦: ${combinedTable.length}`);
                return combinedTable;
            }
        }

        return null;
    }

    // åˆå¹¶HUIè¡¨æ ¼çš„headerå’Œbodyæ•°æ®
    function mergeHUITableData(headerData, bodyData) {
        console.log(`[MD Extractor] åˆå¹¶HUIè¡¨æ ¼æ•°æ® - Headeré•¿åº¦: ${headerData.length}, Bodyé•¿åº¦: ${bodyData.length}`);

        // åˆ†æheaderå’Œbodyçš„ç»“æ„
        const headerLines = headerData.trim().split('\n');
        const bodyLines = bodyData.trim().split('\n');

        // æ‰¾åˆ°headerä¸­çš„è¡¨æ ¼æ•°æ®
        let headerTableLines = [];
        let bodyTableLines = [];

        for (const line of headerLines) {
            if (line.startsWith('|') && line.endsWith('|')) {
                headerTableLines.push(line);
            }
        }

        for (const line of bodyLines) {
            if (line.startsWith('|') && line.endsWith('|') && !line.includes('---')) {
                bodyTableLines.push(line);
            }
        }

        if (headerTableLines.length > 0 && bodyTableLines.length > 0) {
            // æ„å»ºå®Œæ•´è¡¨æ ¼ï¼šheader + åˆ†éš”ç¬¦ + body
            let combined = headerTableLines[0] + '\n'; // è¡¨å¤´

            // æ·»åŠ åˆ†éš”ç¬¦è¡Œ
            const headerCells = headerTableLines[0].split('|').filter(cell => cell.trim());
            const separator = '| ' + headerCells.map(() => '---').join(' | ') + ' |';
            combined += separator + '\n';

            // æ·»åŠ bodyæ•°æ®
            combined += bodyTableLines.join('\n');

            console.log(`[MD Extractor] åˆå¹¶å®Œæˆï¼Œæœ€ç»ˆé•¿åº¦: ${combined.length}`);
            return combined;
        }

        // å¦‚æœæ— æ³•è¯†åˆ«è¡¨æ ¼ç»“æ„ï¼Œç®€å•åˆå¹¶
        return headerData.trim() + '\n' + bodyData.trim();
    }

    function nodeToMarkdown(node, processedElements = new Set()) {
        console.log(`[MD Extractor] nodeToMarkdownè¢«è°ƒç”¨: èŠ‚ç‚¹ç±»å‹=${node ? node.nodeType : 'null'}, æ ‡ç­¾=${node && node.nodeType === 1 ? node.tagName : 'N/A'}`);
        if (!node || processedElements.has(node)) {
            console.log(`[MD Extractor] nodeToMarkdownæ—©æœŸè¿”å›: èŠ‚ç‚¹ä¸ºç©º=${!node}, å·²å¤„ç†=${processedElements.has(node)}`);
            return '';
        }

        // ç§»é™¤äº†å¤æ‚çš„æ ‡è®°æ¸…ç†é€»è¾‘ï¼Œå›å½’v6.3.1çš„ç®€å•æ–¹å¼

        // ç›´æ¥æ·»åŠ åˆ°å¤„ç†é›†åˆï¼Œåƒ6.3.1ç‰ˆæœ¬ä¸€æ ·ç®€å•
        processedElements.add(node);

        const nodeType = node.nodeType;

        if (nodeType === (Node.TEXT_NODE || 3)) {
            const text = node.textContent || '';
            // æ¢å¤v6.3.1çš„æ–‡æœ¬å¤„ç†æ–¹å¼ï¼Œä¿ç•™å¿…è¦çš„ç©ºæ ¼å’Œæ¢è¡Œ
            if (text.trim()) {
                // å¤„ç†ç©ºç™½å­—ç¬¦ï¼Œä¿ç•™å¯è§å­—ç¬¦ä¹‹é—´çš„å•ä¸ªç©ºæ ¼
                const cleanedText = text
                    .replace(/\r\n/g, ' ')        // æ¢è¡Œè½¬ç©ºæ ¼
                    .replace(/\n/g, ' ')          // æ¢è¡Œè½¬ç©ºæ ¼
                    .replace(/\t/g, ' ')          // Tabè½¬ç©ºæ ¼
                    .replace(/\s+/g, ' ')         // å¤šä¸ªç©ºæ ¼åˆå¹¶
                    .trim();
                return cleanedText ? cleanText(cleanedText) : '';
            }
            return '';
        }

        console.log(`[MD Extractor] æ£€æŸ¥å…ƒç´ ç±»å‹: nodeType=${nodeType}, ELEMENT_NODE=${Node.ELEMENT_NODE || 1}`);
        if (nodeType !== (Node.ELEMENT_NODE || 1)) {
            console.log(`[MD Extractor] è·³è¿‡éå…ƒç´ èŠ‚ç‚¹`);
            return '';
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºè¢«å¿½ç•¥çš„æ ‡ç­¾ç±»å‹
        const tagName = node.tagName.toLowerCase();
        console.log(`[MD Extractor] æ£€æŸ¥æ ‡ç­¾: ${tagName}, å¿½ç•¥åˆ—è¡¨:`, CONFIG.IGNORE_TAGS);
        if (CONFIG.IGNORE_TAGS.includes(tagName)) {
            console.log(`[MD Extractor] è·³è¿‡å¿½ç•¥çš„æ ‡ç­¾: ${tagName}`);
            return '';
        }

        // è·³è¿‡éšè—å…ƒç´  (è¡¥å……v5.9çš„å†…è”æ ·å¼æ£€æŸ¥)
        console.log(`[MD Extractor] æ£€æŸ¥å…ƒç´ æ ·å¼: display=${node.style?.display}, visibility=${node.style?.visibility}`);
        if (node.style && (node.style.display === 'none' || node.style.visibility === 'hidden')) {
            console.log(`[MD Extractor] è·³è¿‡éšè—å…ƒç´ `);
            return '';
        }

        // è·³è¿‡æ˜æ˜¾çš„UIæ§ä»¶å…ƒç´ 
        console.log(`[MD Extractor] æ£€æŸ¥ç±»å: ${node.className}`);
        if (node.className && typeof node.className === 'string') {
            const className = node.className.toLowerCase();
            if (className.includes('icon') ||
                className.includes('arrow') ||
                className.includes('dropdown') ||
                className.includes('placeholder') ||
                className.includes('helper')) {
                console.log(`[MD Extractor] è·³è¿‡UIæ§ä»¶å…ƒç´ : ${className}`);
                return '';
            }
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºå®Œæ•´çš„HUIè¡¨æ ¼ç»“æ„
        if (node.classList && node.classList.contains('h-table')) {
            const huiTableResult = processHUITableIfPresent(node, processedElements);
            if (huiTableResult) {
                console.log('[MD Extractor] è¿”å›å®Œæ•´HUIè¡¨æ ¼ç»“æœ');
                return huiTableResult;
            }
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºåŒ…å«HUIè¡¨æ ¼çš„å®¹å™¨ï¼ˆå¦‚ç”¨æˆ·é€‰æ‹©çš„divå®¹å™¨ï¼‰
        const hTableInside = node.querySelector && node.querySelector('.h-table');
        if (hTableInside && !processedElements.has(hTableInside)) {
            console.log(`[MD Extractor] åœ¨å®¹å™¨ä¸­å‘ç°HUIè¡¨æ ¼: ${node.className || node.tagName}`);
            const containerResult = processHUITableIfPresent(hTableInside, processedElements);
            if (containerResult) {
                console.log('[MD Extractor] å®¹å™¨å†…HUIè¡¨æ ¼å¤„ç†å®Œæˆ');
                return containerResult;
            }
        }

        // æ³¨æ„ï¼šèŠ‚ç‚¹å·²åœ¨å¼€å¤´æ·»åŠ åˆ°processedElementsä¸­ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤æ·»åŠ 

        let markdown = '';
        const isBlock = ['p', 'div', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'table', 'blockquote'].includes(tagName);
        console.log(`[MD Extractor] å¤„ç†å…ƒç´ : ${tagName}, ç±»å: ${node.className || 'none'}, æ˜¯å¦å—çº§: ${isBlock}`);

        switch (tagName) {
            case 'h1':
            case 'h2':
            case 'h3':
            case 'h4':
            case 'h5':
            case 'h6':
                const level = parseInt(tagName[1]);
                const headerText = getChildMarkdown(node, processedElements);
                if (headerText.trim()) {
                    markdown = `${'#'.repeat(level)} ${headerText.trim()}`;
                }
                break;

            case 'p':
                markdown = getChildMarkdown(node, processedElements);
                break;

            case 'table':
                console.log('[MD Extractor] æ£€æµ‹åˆ°æ ‡å‡† table å…ƒç´ ');

                // æ£€æŸ¥æ˜¯å¦ä¸ºHUIè¡¨æ ¼çš„ä¸€éƒ¨åˆ†ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡å•ç‹¬å¤„ç†
                const isPartOfHUITable = checkIfPartOfHUITable(node);
                console.log(`[MD Extractor] æ˜¯å¦ä¸ºHUIè¡¨æ ¼éƒ¨åˆ†: ${isPartOfHUITable}`);

                if (!isPartOfHUITable) {
                    const tableData = extractTableData(node);
                    console.log(`[MD Extractor] è¡¨æ ¼æå–ç»“æœé•¿åº¦: ${tableData ? tableData.length : 0}`);
                    if (tableData) {
                        markdown = tableData;
                    }
                } else {
                    console.log('[MD Extractor] è·³è¿‡HUIè¡¨æ ¼éƒ¨åˆ†ï¼Œç­‰å¾…å®Œæ•´å¤„ç†');
                }
                break;

            case 'ul':
            case 'ol':
                const listItems = Array.from(node.children).filter(child =>
                    child.tagName && child.tagName.toLowerCase() === 'li'
                );
                listItems.forEach((li, index) => {
                    const itemText = getChildMarkdown(li, processedElements);
                    if (itemText.trim()) {
                        const prefix = tagName === 'ul' ? '* ' : `${index + 1}. `;
                        markdown += `${prefix}${itemText.trim()}\n`;
                    }
                });
                break;

            case 'br':
                return '  \n'; // æ”¹è¿›ï¼šä½¿ç”¨åŒç©ºæ ¼+æ¢è¡Œç¬¦å®ç°Markdownæ¢è¡Œ

            case 'strong':
            case 'b':
                const strongText = getChildMarkdown(node, processedElements);
                if (strongText.trim()) {
                    markdown = `**${strongText.trim()}**`;
                }
                break;

            case 'em':
            case 'i':
                const emText = getChildMarkdown(node, processedElements);
                if (emText.trim()) {
                    markdown = `*${emText.trim()}*`;
                }
                break;

            case 'a':
                const linkText = getChildMarkdown(node, processedElements);
                const href = node.getAttribute('href');
                if (linkText.trim()) {
                    markdown = href ? `[${linkText.trim()}](${href})` : linkText;
                }
                break;

            case 'input':
                // å¤„ç†è¾“å…¥æ¡†çš„å€¼
                const inputValue = getInputValue(node);
                if (inputValue) {
                    markdown = inputValue;
                }
                break;

            case 'select':
                // å¤„ç†é€‰æ‹©æ¡†çš„å€¼
                const selectValue = getSelectValue(node);
                if (selectValue) {
                    markdown = selectValue;
                }
                break;

            case 'textarea':
                // å¤„ç†æ–‡æœ¬åŒºåŸŸçš„å€¼
                const textareaValue = node.value || node.textContent || '';
                if (textareaValue.trim()) {
                    markdown = cleanText(textareaValue);
                }
                break;

            case 'code':
                // è¡Œå†…ä»£ç 
                const codeText = getChildMarkdown(node, processedElements);
                if (codeText.trim()) {
                    markdown = `\`${codeText.trim()}\``;
                }
                break;

            case 'pre':
                // ä»£ç å—
                const preText = node.textContent || '';
                if (preText.trim()) {
                    markdown = `\`\`\`\n${preText.trim()}\n\`\`\``;
                }
                break;

            case 'blockquote':
                // å¼•ç”¨å—
                const quoteText = getChildMarkdown(node, processedElements);
                if (quoteText.trim()) {
                    const quotedLines = quoteText.trim().split('\n').map(line => `> ${line}`).join('\n');
                    markdown = quotedLines;
                }
                break;

            case 'img':
                // å›¾ç‰‡
                const src = node.getAttribute('src');
                const alt = node.getAttribute('alt') || 'å›¾ç‰‡';
                if (src) {
                    markdown = `![${alt}](${src})`;
                }
                break;

            case 'hr':
                // åˆ†éš”çº¿
                markdown = '---';
                break;

            case 'span':
            case 'article':
            case 'section':
            case 'aside':
            case 'main':
            case 'header':
            case 'footer':
            case 'nav':
                // è¯­ä¹‰åŒ–æ ‡ç­¾ï¼Œç›´æ¥å¤„ç†å­å†…å®¹
                markdown = getChildMarkdown(node, processedElements);
                break;

            case 'label':
                // è¡¨å•æ ‡ç­¾ï¼Œé€šå¸¸æ˜¯å­—æ®µæ ‡ç­¾ï¼Œå¤„ç†åæ·»åŠ æ¢è¡Œ
                const labelContent = getChildMarkdown(node, processedElements);
                if (labelContent.trim()) {
                    markdown = labelContent.trim();
                }
                break;

            default:
                console.log(`[MD Extractor] è¿›å…¥defaultåˆ†æ”¯å¤„ç†: ${tagName}, ç±»å: ${node.className || 'none'}`);

                // æ£€æŸ¥æ˜¯å¦ä¸ºHUIè¡¨æ ¼çš„headeræˆ–bodyå®¹å™¨
                if (node.classList && (node.classList.contains('h-table-header') || node.classList.contains('h-table-body'))) {
                    console.log(`[MD Extractor] æ£€æµ‹åˆ°HUIè¡¨æ ¼ç»„ä»¶: ${node.className}`);

                    // æ£€æŸ¥æ˜¯å¦å·²ç»è¢«å¤„ç†è¿‡ï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰
                    if (processedElements.has(node)) {
                        console.log(`[MD Extractor] HUIè¡¨æ ¼ç»„ä»¶å·²è¢«å¤„ç†ï¼Œè·³è¿‡: ${node.className}`);
                        return '';
                    }

                    // å°è¯•æ‰¾åˆ°å®Œæ•´çš„HUIè¡¨æ ¼å¹¶åˆå¹¶
                    const completeMergedTable = tryMergeCompleteHUITable(node, processedElements);
                    if (completeMergedTable) {
                        console.log(`[MD Extractor] æˆåŠŸåˆå¹¶å®Œæ•´HUIè¡¨æ ¼ï¼Œé•¿åº¦: ${completeMergedTable.length}`);
                        markdown = completeMergedTable;
                    } else {
                        // å¦‚æœæ— æ³•åˆå¹¶ï¼Œç›´æ¥æå–å†…éƒ¨çš„table
                        const internalTable = node.querySelector('table');
                        if (internalTable) {
                            console.log(`[MD Extractor] ç›´æ¥å¤„ç†HUIç»„ä»¶å†…çš„table`);
                            processedElements.add(internalTable);
                            processedElements.add(node); // æ ‡è®°å½“å‰èŠ‚ç‚¹ä¸ºå·²å¤„ç†
                            markdown = extractTableData(internalTable);
                            console.log(`[MD Extractor] HUIç»„ä»¶tableæå–ç»“æœé•¿åº¦: ${markdown ? markdown.length : 0}`);
                        } else {
                            // å¦‚æœæ²¡æœ‰tableï¼Œæ­£å¸¸å¤„ç†å­å†…å®¹
                            processedElements.add(node); // æ ‡è®°å½“å‰èŠ‚ç‚¹ä¸ºå·²å¤„ç†
                            markdown = getChildMarkdown(node, processedElements);
                        }
                    }
                } else {
                    // å®Œå…¨æŒ‰ç…§6.3.1ç‰ˆæœ¬çš„ç®€å•é€»è¾‘ï¼šå¯¹äºå…¶ä»–å…ƒç´ ï¼Œç›´æ¥å¤„ç†å­å†…å®¹
                    markdown = getChildMarkdown(node, processedElements);
                    console.log(`[MD Extractor] getChildMarkdownè¿”å›é•¿åº¦: ${markdown ? markdown.length : 0}`);
                }
                break;
        }

        // å®Œå…¨æŒ‰ç…§6.3.1ç‰ˆæœ¬çš„returné€»è¾‘
        if (isBlock && markdown && markdown.trim()) {
            // ç¡®ä¿å—çº§å…ƒç´ ä¹‹é—´æœ‰é€‚å½“é—´è·
            if (!markdown.endsWith('\n\n')) {
                return markdown.trim() + '\n\n';
            }
            return markdown;
        }
        return markdown || '';
    }

    // æ–°å¢ï¼šè·å–è¾“å…¥æ¡†å€¼çš„å‡½æ•°
    function getInputValue(input) {
        if (!input) return '';

        const type = (input.type || '').toLowerCase();

        switch (type) {
            case 'checkbox':
                if (input.checked) {
                    // å°è¯•è·å–ç›¸å…³è”çš„æ ‡ç­¾æ–‡æœ¬
                    let labelText = '';

                    // æ–¹æ³•1: é€šè¿‡forå±æ€§å…³è”çš„label
                    if (input.id) {
                        const label = document.querySelector(`label[for="${input.id}"]`);
                        if (label) {
                            labelText = label.textContent.trim();
                        }
                    }

                    // æ–¹æ³•2: çˆ¶çº§labelå…ƒç´ 
                    if (!labelText) {
                        const parentLabel = input.closest('label');
                        if (parentLabel) {
                            labelText = parentLabel.textContent.replace(input.outerHTML, '').trim();
                        }
                    }

                    // æ–¹æ³•3: ç´§é‚»çš„æ–‡æœ¬èŠ‚ç‚¹æˆ–å…ƒç´ 
                    if (!labelText) {
                        const nextSibling = input.nextSibling;
                        if (nextSibling) {
                            if (nextSibling.nodeType === 3) { // æ–‡æœ¬èŠ‚ç‚¹
                                labelText = nextSibling.textContent.trim();
                            } else if (nextSibling.nodeType === 1) { // å…ƒç´ èŠ‚ç‚¹
                                labelText = nextSibling.textContent.trim();
                            }
                        }
                    }

                    // ä½¿ç”¨å¤é€‰æ¡†æ ‡è®° + æ–‡æœ¬
                    const displayText = labelText || input.value || 'å·²é€‰ä¸­';
                    return `â˜‘ ${displayText}`;
                }
                return '';

            case 'radio':
                // å°è¯•è·å–ç›¸å…³è”çš„æ ‡ç­¾æ–‡æœ¬
                let labelText = '';

                // æ–¹æ³•1: é€šè¿‡forå±æ€§å…³è”çš„label
                if (input.id) {
                    const label = document.querySelector(`label[for="${input.id}"]`);
                    if (label) {
                        labelText = label.textContent.trim();
                    }
                }

                // æ–¹æ³•2: çˆ¶çº§labelå…ƒç´ 
                if (!labelText) {
                    const parentLabel = input.closest('label');
                    if (parentLabel) {
                        labelText = parentLabel.textContent.replace(input.outerHTML, '').trim();
                    }
                }

                // æ–¹æ³•3: ç´§é‚»çš„æ–‡æœ¬èŠ‚ç‚¹æˆ–å…ƒç´ 
                if (!labelText) {
                    const nextSibling = input.nextSibling;
                    if (nextSibling) {
                        if (nextSibling.nodeType === 3) { // æ–‡æœ¬èŠ‚ç‚¹
                            labelText = nextSibling.textContent.trim();
                        } else if (nextSibling.nodeType === 1) { // å…ƒç´ èŠ‚ç‚¹
                            labelText = nextSibling.textContent.trim();
                        }
                    }
                }

                // æ–¹æ³•4: æŸ¥æ‰¾åŒçº§çš„cap4-radio__leftå…ƒç´ ä¸­çš„æ ‡ç­¾æ–‡æœ¬
                if (!labelText) {
                    const parentElement = input.closest('div, span, li, td');
                    if (parentElement) {
                        const radioLeft = parentElement.querySelector('.cap4-radio__left .label-margin, .cap4-radio__left .cap4-ctrl__label');
                        if (radioLeft) {
                            labelText = radioLeft.textContent.trim();
                        }
                    }
                }

                const displayText = labelText || input.value || input.getAttribute('value') || '';
                if (displayText) {
                    // é€‰ä¸­çš„ç”¨ âŠ™ï¼Œæœªé€‰ä¸­çš„ç”¨ â—‹
                    const symbol = input.checked ? 'âŠ™' : 'â—‹';
                    return `${symbol} ${displayText}`;
                }
                return '';

            case 'hidden':
                return ''; // é€šå¸¸ä¸æ˜¾ç¤ºéšè—å­—æ®µ

            default:
                const value = input.value || input.getAttribute('value') || '';
                if (value && value !== input.placeholder) {
                    return cleanText(value);
                }
                return '';
        }
    }

    // æ–°å¢ï¼šè·å–é€‰æ‹©æ¡†å€¼çš„å‡½æ•°
    function getSelectValue(select) {
        if (!select) return '';

        const selectedOption = select.querySelector('option[selected]') ||
                              select.options[select.selectedIndex];

        if (selectedOption) {
            const text = selectedOption.textContent || selectedOption.value || '';
            if (text && text !== 'è¯·é€‰æ‹©' && text !== 'Please select' && text !== '- è¯·é€‰æ‹© -') {
                // å¯¹äºä¸‹æ‹‰é€‰æ‹©æ¡†ï¼Œä½¿ç”¨ä¸‹æ‹‰ç®­å¤´å›¾æ ‡æ¥è¡¨ç¤º
                return `â–¼ ${cleanText(text)}`;
            }
        }

        // å¦‚æœæ²¡æœ‰é€‰ä¸­é¡¹æˆ–è€…æ˜¯é»˜è®¤çš„"è¯·é€‰æ‹©"ï¼Œæ˜¾ç¤ºä¸ºæœªé€‰æ‹©çŠ¶æ€
        return 'â–¼ (æœªé€‰æ‹©)';
    }

    function getChildMarkdown(parentNode, processedElements) {
        if (!parentNode || !parentNode.childNodes) return '';
        console.log(`[MD Extractor] getChildMarkdownå¤„ç†çˆ¶èŠ‚ç‚¹: ${parentNode.tagName}, å­èŠ‚ç‚¹æ•°é‡: ${parentNode.childNodes.length}`);

        let content = '';
        Array.from(parentNode.childNodes).forEach((child, index) => {
            const childMarkdown = nodeToMarkdown(child, processedElements);
            console.log(`[MD Extractor] å­èŠ‚ç‚¹${index}: ${child.nodeType === 1 ? child.tagName : 'TEXT'}, è¿”å›é•¿åº¦: ${childMarkdown ? childMarkdown.length : 0}`);
            if (childMarkdown) {
                // ç¡®ä¿å­èŠ‚ç‚¹ä¹‹é—´æœ‰é€‚å½“çš„åˆ†éš”
                if (content && !content.endsWith(' ') && !childMarkdown.startsWith(' ')) {
                    content += ' ';
                }
                content += childMarkdown;
            }
        });
        console.log(`[MD Extractor] getChildMarkdownæœ€ç»ˆç»“æœé•¿åº¦: ${content.length}`);
        return content;
    }

    function extractFormItemData(item, processedElements) {
        if (!item) return '';

        const labelEl = item.querySelector('.h-form-item-label, [class*="label"], label, .tbase-form-item-label');
        const contentEl = item.querySelector('.h-form-item-content, [class*="content"], .form-content, .t-base-view-mode');

        if (!labelEl || !contentEl) return '';

        const labelText = cleanText((labelEl.textContent || '').trim().replace(/[:ï¼š\s]*$/, ''));
        if (!labelText) return '';

        processedElements.add(item);

        // å¤„ç†è¡¨æ ¼
        const tables = contentEl.querySelectorAll('table');
        if (tables.length > 0) {
            let tableMarkdown = '';
            tables.forEach(table => {
                // æ£€æŸ¥è¡¨æ ¼æ˜¯å¦å·²ç»è¢«å¤„ç†è¿‡
                if (!processedElements.has(table)) {
                    processedElements.add(table);
                    const tableData = extractTableData(table);
                    if (tableData) {
                        tableMarkdown += tableData + '\n';
                    }
                }
            });
            if (tableMarkdown) {
                return `**${labelText}**:\n\n${tableMarkdown}\n`;
            }
        }

        // è·å–å®é™…å€¼çš„å¤šç§ç­–ç•¥
        let valueText = extractActualValue(contentEl);

        if (!valueText || valueText.trim() === '') {
            valueText = '(å¾…å¡«å†™)';
        }

        // å¦‚æœ valueText åŒ…å«è¡¨æ ¼ï¼ˆä»¥ | å¼€å¤´ï¼‰ï¼Œåˆ™ç›´æ¥è¿”å›è¡¨æ ¼
        if (valueText.includes('|')) {
            return `**${labelText}**:\n\n${valueText}\n\n`;
        } else {
            // ç¡®ä¿æ ‡ç­¾å’Œå€¼ä¹‹é—´æœ‰ç©ºæ ¼
            const cleanedValue = valueText.replace(/\s+/g, ' ').trim();
            return `**${labelText}**: ${cleanedValue}\n\n`;
        }
    }

    // seeyon OA ç¬¬ä¸€åˆ—å†…å®¹æå–å‡½æ•°
    function extractFirstColumnContent(cell) {
        // 1. ä¼˜å…ˆä»é“¾æ¥çš„titleå±æ€§æå–å®Œæ•´æ ‡é¢˜
        const linkWithTitle = cell.querySelector('a[title]');
        if (linkWithTitle && linkWithTitle.getAttribute('title')) {
            return linkWithTitle.getAttribute('title').trim();
        }

        // 2. ä»æ ‡é¢˜æ–‡æœ¬å…ƒç´ æå–
        const titleElements = [
            '.titleText', '.cellContentText', '.title',
            '[class*="title"]', '[class*="subject"]'
        ];

        for (const selector of titleElements) {
            const element = cell.querySelector(selector);
            console.log(`[MD Extractor] å°è¯•é€‰æ‹©å™¨ "${selector}":`, element ? element.textContent : 'null');
            if (element && element.textContent && element.textContent.trim()) {
                // æ¸…ç†æ ‡é¢˜ä¸­çš„å¤šä½™ç©ºç™½å’Œç‰¹æ®Šå­—ç¬¦
                let title = element.textContent.trim();
                // ç§»é™¤è¿ç»­çš„ç©ºç™½å­—ç¬¦
                title = title.replace(/\s+/g, ' ');
                console.log(`[MD Extractor] æ‰¾åˆ°æ ‡é¢˜æ–‡æœ¬: "${title}"`);
                return title;
            }
        }

        // 3. ä»é“¾æ¥æ–‡æœ¬æå–
        const linkElement = cell.querySelector('a');
        if (linkElement && linkElement.textContent && linkElement.textContent.trim()) {
            let title = linkElement.textContent.trim();
            // ç§»é™¤è¿ç»­çš„ç©ºç™½å­—ç¬¦
            title = title.replace(/\s+/g, ' ');
            return title;
        }

        // 4. ä»å•å…ƒæ ¼titleå±æ€§æå–
        const cellTitle = cell.getAttribute('title');
        if (cellTitle && cellTitle.trim()) {
            return cellTitle.trim();
        }

        // 5. æœ€åä»å•å…ƒæ ¼æ–‡æœ¬æå–
        const finalContent = (cell.textContent || '').trim();
        console.log(`[MD Extractor] extractFirstColumnContent æœ€ç»ˆç»“æœ: "${finalContent}"`);
        return finalContent;
    }

    // seeyon OA å¯å˜åˆ—å†…å®¹æå–å‡½æ•°
    function extractVariableColumnContent(cell) {
        // 1. ä¼˜å…ˆä»titleå±æ€§æå–ï¼ˆseeyonç³»ç»Ÿçš„ä¸»è¦æ•°æ®å­˜å‚¨æ–¹å¼ï¼‰
        const titleAttr = cell.getAttribute('title');
        if (titleAttr && titleAttr.trim()) {
            return titleAttr.trim();
        }

        // 2. ä»spanå…ƒç´ çš„titleå±æ€§æå–
        const spanWithTitle = cell.querySelector('span[title]');
        if (spanWithTitle && spanWithTitle.getAttribute('title')) {
            return spanWithTitle.getAttribute('title').trim();
        }

        // 3. ä»é“¾æ¥å…ƒç´ æå–
        const linkElement = cell.querySelector('a');
        if (linkElement) {
            const linkTitle = linkElement.getAttribute('title');
            if (linkTitle && linkTitle.trim()) {
                return linkTitle.trim();
            }
            if (linkElement.textContent && linkElement.textContent.trim()) {
                return linkElement.textContent.trim();
            }
        }

        // 4. ä»spanæ–‡æœ¬å†…å®¹æå–
        const spanElement = cell.querySelector('span');
        if (spanElement && spanElement.textContent && spanElement.textContent.trim()) {
            return spanElement.textContent.trim();
        }

        // 5. ä»divå†…å®¹æå–
        const divElement = cell.querySelector('div');
        if (divElement && divElement.textContent && divElement.textContent.trim()) {
            return divElement.textContent.trim();
        }

        // 6. æœ€åä»å•å…ƒæ ¼æ–‡æœ¬æå–
        const cellText = (cell.textContent || '').trim();
        return cellText;
    }

    // é€šç”¨å•å…ƒæ ¼å†…å®¹æå–å‡½æ•°
    function extractGenericCellContent(cell) {
        // 1. ä»titleå±æ€§æå–
        const titleAttr = cell.getAttribute('title');
        if (titleAttr && titleAttr.trim()) {
            return titleAttr.trim();
        }

        // 2. ä»å­å…ƒç´ çš„titleå±æ€§æå–
        const elementWithTitle = cell.querySelector('[title]');
        if (elementWithTitle && elementWithTitle.getAttribute('title')) {
            return elementWithTitle.getAttribute('title').trim();
        }

        // 3. ä»é“¾æ¥æå–
        const linkElement = cell.querySelector('a');
        if (linkElement && linkElement.textContent && linkElement.textContent.trim()) {
            return linkElement.textContent.trim();
        }

        // 4. ä»è¡¨å•å…ƒç´ æå–
        const inputElement = cell.querySelector('input, select, textarea');
        if (inputElement) {
            return getInputValue(inputElement) || inputElement.value || '';
        }

        // 5. ä»æ–‡æœ¬å†…å®¹æå–
        return (cell.textContent || '').trim();
    }

    // æ”¹è¿›çš„å®é™…å€¼æå–å‡½æ•°
    function extractActualValue(contentEl) {
        if (!contentEl) return '';



        // ç­–ç•¥1: æŸ¥æ‰¾è¾“å…¥æ¡†çš„å®é™…å€¼
        const inputs = contentEl.querySelectorAll('input, textarea');
        for (const input of inputs) {
            const value = getInputValue(input);
            if (value && value.trim()) {
                return value; // getInputValueå·²ç»åŒ…å«äº†cleanTextå¤„ç†
            }
        }

        // å¤„ç†selectå…ƒç´ 
        const selects = contentEl.querySelectorAll('select');
        for (const select of selects) {
            const value = getSelectValue(select);
            if (value && value.trim() && !value.includes('(æœªé€‰æ‹©)')) {
                return value; // getSelectValueå·²ç»åŒ…å«äº†cleanTextå¤„ç†
            }
        }

        // ç­–ç•¥2: æŸ¥æ‰¾æ˜¾ç¤ºå€¼çš„å…ƒç´ ï¼ˆåŒ…æ‹¬å¯èƒ½è¢«æŠ˜å çš„å†…å®¹ï¼‰
        const valueSelectors = [
            '.form-value', '.field-value', '.input-value', '.display-value',
            '.h-input-inner', '.h-select-selection-selected-value',
            '.h-date-editor-input', '.h-input', '.value',
            '[class*="value"]', '[class*="text"]', '[class*="display"]',
            '.content', '.detail', '.description', '.summary',
            'span:not([class*="icon"]):not([class*="arrow"]):not([class*="placeholder"])',
            'div:not([class*="icon"]):not([class*="arrow"]):not([class*="placeholder"])'
        ];

        for (const selector of valueSelectors) {
            try {
                const elements = contentEl.querySelectorAll(selector);
                for (const element of elements) {
                    const text = (element.textContent || '').trim();

                    // æ’é™¤æ˜æ˜¾çš„UIå…ƒç´ å’Œå ä½ç¬¦
                    if (text &&
                        text.length > 0 &&
                        text !== 'è¯·é€‰æ‹©' &&
                        text !== 'è¯·è¾“å…¥' &&
                        text !== 'å¾…å¡«å†™' &&
                        text !== '...' &&
                        text !== 'â€”' &&
                        text !== 'å±•å¼€' &&
                        text !== 'æ”¶èµ·' &&
                        text !== 'æ›´å¤š' &&
                        !text.includes('icon') &&
                        !text.includes('arrow') &&
                        !text.includes('dropdown')) {

                        // æ£€æŸ¥æ˜¯å¦æ˜¯å®é™…çš„å†…å®¹è€Œä¸æ˜¯æ§ä»¶æ–‡æœ¬
                        if (isActualContent(text, element)) {
                            return cleanText(text);
                        }
                    }
                }
            } catch (e) {
                console.warn('æå–å€¼æ—¶é€‰æ‹©å™¨å¤±è´¥:', selector);
            }
        }

        // ç­–ç•¥3: å¼ºåˆ¶å±•å¼€å¹¶è·å–éšè—å†…å®¹
        const hiddenContent = extractHiddenContent(contentEl);
        if (hiddenContent) {
            return hiddenContent;
        }

        // ç­–ç•¥4: ç›´æ¥æå–å¯è§æ–‡æœ¬ï¼ˆè¿‡æ»¤æ‰æ§ä»¶å…ƒç´ ï¼‰
        const clone = contentEl.cloneNode(true);

        // ç§»é™¤æ‰€æœ‰æ§ä»¶å’Œè£…é¥°æ€§å…ƒç´ 
        const elementsToRemove = [
            'button', 'i[class*="icon"]', 'svg', '.h-icon',
            '[class*="icon"]', '[class*="arrow"]', '[class*="dropdown"]',
            '.h-select-arrow', '.h-form-item-extra', '.h-poptip',
            '.h-tooltip', '.t-tag-primary', 'script', 'style',
            '[class*="placeholder"]', '[class*="helper"]',
            '.t-base-view-common-title' // ç§»é™¤å±•å¼€æŒ‰é’®å®¹å™¨
        ];

        elementsToRemove.forEach(selector => {
            try {
                clone.querySelectorAll(selector).forEach(el => {
                    if (el.parentNode) {
                        el.parentNode.removeChild(el);
                    }
                });
            } catch (e) {
                console.warn('æ¸…ç†é€‰æ‹©å™¨å¤±è´¥:', selector);
            }
        });

        const textContent = getTextWithSeparators(clone);

        // è¿›ä¸€æ­¥æ¸…ç†æ–‡æœ¬
        const cleanedText = textContent
            .replace(/\s+/g, ' ')
            .replace(/è¯·é€‰æ‹©|è¯·è¾“å…¥|å¾…å¡«å†™|\.{3,}|â€”{2,}|å±•å¼€|æ”¶èµ·|æ›´å¤š/g, '')
            .trim();

        return cleanedText;
    }

    // æ–°å¢ï¼šæå–éšè—å†…å®¹çš„å‡½æ•°
    function extractHiddenContent(contentEl) {
        try {
            // æŸ¥æ‰¾å¯èƒ½åŒ…å«éšè—å†…å®¹çš„å…ƒç´ 
            const hiddenContainers = contentEl.querySelectorAll(
                '[style*="display: none"], [style*="display:none"], .collapsed, .hidden, [data-collapsed="true"]'
            );

            for (const container of hiddenContainers) {
                // ä¸´æ—¶æ˜¾ç¤ºå…ƒç´ ä»¥è·å–å†…å®¹
                const originalStyle = container.style.display;
                const originalClass = container.className;

                container.style.display = 'block';
                container.classList.remove('collapsed', 'hidden');

                const text = (container.textContent || '').trim();

                // æ¢å¤åŸæ ·å¼
                container.style.display = originalStyle;
                container.className = originalClass;

                if (text && text.length > 10 && !text.includes('å±•å¼€') && !text.includes('icon')) {
                    return cleanText(text);
                }
            }

            // æŸ¥æ‰¾å¯èƒ½çš„æŠ˜å å†…å®¹
            const collapsibleElements = contentEl.querySelectorAll(
                '[data-toggle], [onclick*="toggle"], [onclick*="expand"], .expandable'
            );

            for (const element of collapsibleElements) {
                const text = (element.textContent || '').trim();
                if (text && text.length > 10) {
                    return cleanText(text);
                }
            }

        } catch (e) {
            console.warn('æå–éšè—å†…å®¹å¤±è´¥:', e);
        }

        return '';
    }

    // æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºå®é™…å†…å®¹çš„å‡½æ•°
    function isActualContent(text, element) {
        // é•¿åº¦æ£€æŸ¥
        if (text.length > 100) return true; // é•¿æ–‡æœ¬å¾ˆå¯èƒ½æ˜¯å®é™…å†…å®¹
        if (text.length < 2) return false;   // å¤ªçŸ­çš„æ–‡æœ¬å¯èƒ½ä¸æ˜¯æœ‰æ•ˆå†…å®¹

        // æ•°å­—æ¨¡å¼æ£€æŸ¥ï¼ˆè´¢åŠ¡æ•°æ®ï¼‰
        if (/^\d{1,3}(,\d{3})*(\.\d+)?$/.test(text)) return true; // æ ¼å¼åŒ–çš„æ•°å­—
        if (/^\d+(\.\d+)?%?$/.test(text)) return true; // æ•°å­—æˆ–ç™¾åˆ†æ¯”
        if (/^\d{4}-\d{2}-\d{2}$/.test(text)) return true; // æ—¥æœŸæ ¼å¼

        // ä¸­æ–‡å†…å®¹æ£€æŸ¥
        if (/[\u4e00-\u9fa5]{2,}/.test(text)) {
            // æ’é™¤å¸¸è§çš„UIæ–‡æœ¬
            const uiTexts = ['è¯·é€‰æ‹©', 'è¯·è¾“å…¥', 'å¾…å¡«å†™', 'å±•å¼€', 'æ”¶èµ·', 'æ›´å¤š', 'ç¡®å®š', 'å–æ¶ˆ', 'ä¿å­˜'];
            return !uiTexts.some(ui => text.includes(ui));
        }

        // è‹±æ–‡å†…å®¹æ£€æŸ¥
        if (/^[a-zA-Z\s]{3,}$/.test(text)) {
            const uiTexts = ['select', 'input', 'choose', 'enter', 'more', 'expand', 'collapse'];
            return !uiTexts.some(ui => text.toLowerCase().includes(ui));
        }

        // æ£€æŸ¥å…ƒç´ çš„æ ·å¼å’Œä½ç½®
        if (element) {
            const computed = window.getComputedStyle(element);

            // å¦‚æœå…ƒç´ è¢«éšè—ï¼Œå¯èƒ½ä¸æ˜¯å®é™…å†…å®¹
            if (computed.display === 'none' || computed.visibility === 'hidden') {
                return false;
            }

            // å¦‚æœå…ƒç´ å¾ˆå°ï¼Œå¯èƒ½æ˜¯è£…é¥°æ€§çš„
            const rect = element.getBoundingClientRect();
            if (rect.width < 10 || rect.height < 10) {
                return false;
            }
        }

        return true;
    }

    function extractTableData(table) {
        if (!table) return '';


        const matrix = [];
        const rows = Array.from(table.querySelectorAll('tr'));

        if (rows.length === 0) {
            return '';
        }

        // å¤„ç†æ¯ä¸€è¡Œ
        rows.forEach((row, y) => {
            if (!matrix[y]) matrix[y] = [];
            let x = 0;

            const cells = Array.from(row.querySelectorAll('td, th'));

            cells.forEach((cell, cellIndex) => {
                // æ‰¾åˆ°ä¸‹ä¸€ä¸ªç©ºçš„ä½ç½®
                while (matrix[y][x] !== undefined) x++;

                const colspan = parseInt(cell.getAttribute('colspan')) || 1;
                const rowspan = parseInt(cell.getAttribute('rowspan')) || 1;

                // å…‹éš†å•å…ƒæ ¼ä»¥ç§»é™¤"å™ªéŸ³"å…ƒç´ ï¼Œé¿å…å½±å“åŸå§‹é¡µé¢
                const cellClone = cell.cloneNode(true);
                // ç§»é™¤æ‰€æœ‰å·²çŸ¥çš„å›¾æ ‡ã€æŒ‰é’®ç­‰éå†…å®¹å…ƒç´ ï¼Œä½†ä¿æŠ¤æœ‰titleå±æ€§çš„é“¾æ¥
                cellClone.querySelectorAll('.vportal, .setTop, button').forEach(el => el.remove());
                // ä¸ç§»é™¤æœ‰titleå±æ€§çš„<a>æ ‡ç­¾ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½åŒ…å«é‡è¦å†…å®¹

                // ç»¼åˆæå–å•å…ƒæ ¼å†…å®¹
                let cellContent = '';

                // 1. ä¼˜å…ˆä»å†…éƒ¨çš„ <a> æ ‡ç­¾çš„ title å±æ€§è·å–ï¼ˆæ–‡æ¡£æ ‡é¢˜ï¼‰
                const link = cellClone.querySelector('a[title]');
                if (link) {
                    const linkTitle = link.getAttribute('title') || '';
                    if (linkTitle.trim()) {
                        cellContent = cleanText(linkTitle);
                    }
                }

                // 2. å¦‚æœæ²¡æœ‰é“¾æ¥titleï¼Œä»å•å…ƒæ ¼çš„ title å±æ€§è·å–ï¼ˆç”¨æˆ·åã€æ—¶é—´ç­‰ï¼‰
                if (!cellContent) {
                    const titleText = (cell.getAttribute('title') || '').trim();
                    if (titleText) {
                        cellContent = cleanText(titleText);
                    }
                }

                // 3. å¦‚æœè¿˜æ˜¯ç©ºï¼Œä»æ–‡æœ¬å†…å®¹æå–
                if (!cellContent) {
                    const visibleText = (cellClone.textContent || cellClone.innerText || '').trim();
                    if (visibleText) {
                        cellContent = cleanText(visibleText);
                    }
                }

                // 4. æœ€åå°è¯•ä»è¾“å…¥æ¡†è·å–
                if (!cellContent) {
                    const input = cellClone.querySelector('input, textarea, select');
                    if (input) {
                        cellContent = getInputValue(input) || '';
                    }
                }

                // æ¸…ç†å’Œæ ¼å¼åŒ–å†…å®¹
                cellContent = cleanTableCellContent(cellContent);

                if (!cellContent) {
                    cellContent = '';  // ç©ºå•å…ƒæ ¼
                }

                // å¡«å……åˆå¹¶çš„å•å…ƒæ ¼
                for (let i = 0; i < rowspan; i++) {
                    for (let j = 0; j < colspan; j++) {
                        const currentY = y + i;
                        const currentX = x + j;
                        if (!matrix[currentY]) matrix[currentY] = [];
                        matrix[currentY][currentX] = (i === 0 && j === 0) ? cellContent : '';
                    }
                }
                x += colspan;
            });
        });

        if (matrix.length === 0) {
            return '';
        }

        // è¿‡æ»¤æ‰æ‰€æœ‰å•å…ƒæ ¼éƒ½ä¸ºç©ºçš„è¡Œ
        const filteredMatrix = matrix.filter(row => {
            if (!row) return false;
            return row.some(cell => cell && cell.trim());
        });

        if (filteredMatrix.length === 0) {
            return '';
        }

        // è®¡ç®—æœ€å¤§åˆ—æ•°
        const maxCols = Math.max(...filteredMatrix.map(row => row ? row.length : 0));

        if (maxCols === 0) {
            return '';
        }

        // ç¡®ä¿æ‰€æœ‰è¡Œéƒ½æœ‰ç›¸åŒçš„åˆ—æ•° - ä½¿ç”¨è¿‡æ»¤åçš„çŸ©é˜µ
        filteredMatrix.forEach((row, index) => {
            if (!row) filteredMatrix[index] = [];
            while (filteredMatrix[index].length < maxCols) {
                filteredMatrix[index].push('');
            }
        });

        // ç”ŸæˆMarkdownè¡¨æ ¼
        let markdown = '\n'; // æ·»åŠ å‰ç½®æ¢è¡Œ

        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¡¨å¤´è¡Œ (th) - åœ¨åŸå§‹è¡¨æ ¼ä¸­æ£€æŸ¥
        const hasHeader = rows[0] && rows[0].querySelector('th');

        // å¦‚æœåªæœ‰ä¸€è¡Œæ•°æ®ä¸”æ²¡æœ‰è¡¨å¤´ï¼Œå¯èƒ½æ˜¯åˆ†ç¦»çš„è¡¨æ ¼è¡Œï¼Œä¸æ·»åŠ åˆ†éš”ç¬¦
        const shouldAddSeparator = filteredMatrix.length > 1 || hasHeader;

        filteredMatrix.forEach((row, i) => {
            // ç¡®ä¿æ¯ä¸ªå•å…ƒæ ¼éƒ½ä¸ä¸ºç©ºï¼Œè‡³å°‘æ˜¯ä¸€ä¸ªç©ºæ ¼
            const formattedRow = row.map(cell => {
                // ç›´æ¥ä½¿ç”¨å·²ç»é€šè¿‡ cleanTableCellContent å¤„ç†è¿‡çš„å†…å®¹
                let content = (cell || '').toString();
                return content || ' '; // ç©ºå•å…ƒæ ¼ç”¨ç©ºæ ¼å ä½
            });

            const rowContent = formattedRow.join(' | ');
            markdown += `| ${rowContent} |\n`;

            // åœ¨ç¬¬ä¸€è¡Œåæ·»åŠ åˆ†éš”ç¬¦
            // åªæœ‰åœ¨å¤šè¡Œè¡¨æ ¼æˆ–æœ‰è¡¨å¤´çš„æƒ…å†µä¸‹æ‰æ·»åŠ åˆ†éš”ç¬¦
            if (i === 0 && shouldAddSeparator) {
                const separator = Array(maxCols).fill('---').join(' | ');
                markdown += `| ${separator} |\n`;
            }
        });

        markdown += '\n'; // æ·»åŠ åç½®æ¢è¡Œ

        return markdown;
    }

    // å¤„ç†CSSå¸ƒå±€çš„è¡¨æ ¼ï¼ˆå¦‚multiRowVariableColumnï¼‰
    function extractCSSTableData(container, processedElements = new Set()) {
        if (!container) return '';

        // æŸ¥æ‰¾è¡¨æ ¼è¡Œ (tr æˆ–è€…å…·æœ‰è¡Œç‰¹å¾çš„å…ƒç´ )
        const rows = container.querySelectorAll('tr, .row, [class*="row"], .h-editgird-row');

        // å¦‚æœæ˜¯editgirdè¡¨æ ¼ï¼ŒåŒæ—¶åŒ…å«è¡¨å¤´
        if (container.matches('[class*="editgird"]')) {
            const headerRows = container.querySelectorAll('.h-editgird-header tr');
            const bodyRows = container.querySelectorAll('.h-editgird-body tr, .h-editgird-row');
            const allRows = [...headerRows, ...bodyRows];
            if (allRows.length > 0) {
                return extractEditgirdTable(container, allRows);
            } else {
                // ç‰¹æ®Šå¤„ç†ï¼šseeyon OAç³»ç»Ÿçš„å¤šç§è¡¨æ ¼ç±»å‹
                if (container.matches('[class*="multiRowVariableColumn"]') ||
                    container.querySelector('.multiRowVariableColumn') ||
                    container.querySelector('td.col_first') ||
                    container.querySelector('td.variableColumn') ||
                    container.matches('[class*="section-body"]') && container.querySelector('table')) {
                    return extractOAMultiRowTable(container);
                }

                // å°è¯•ç›´æ¥æŸ¥æ‰¾ table æ ‡ç­¾ï¼ˆéOAè¡¨æ ¼ï¼‰
                const tables = container.querySelectorAll('table');
                if (tables.length > 0) {
                    const table = tables[0];
                    // æ£€æŸ¥æ˜¯å¦å·²åœ¨processedElementsä¸­
                    if (processedElements.has(table)) {
                        console.log('[MD Extractor] Tableåœ¨CSSæå–ä¸­å·²åœ¨processedElementsï¼Œè·³è¿‡');
                        return '';
                    }

                    // å°†tableåŠ å…¥processedElements
                    processedElements.add(table);

                    // æ£€æŸ¥æ˜¯å¦ä¸ºOAè¡¨æ ¼ï¼Œå¦‚æœæ˜¯åˆ™ä½¿ç”¨OAæå–å™¨
                    if (table.querySelector('td.col_first') && table.querySelector('td.variableColumn')) {
                        return extractOAMultiRowTable(container);
                    } else {
                        return extractTableData(table);
                    }
                }
            }
        }

        if (rows.length === 0) {
            return '';
        }

        const matrix = [];

        rows.forEach((row, y) => {
            if (!matrix[y]) matrix[y] = [];

            // æŸ¥æ‰¾å•å…ƒæ ¼ (td, th æˆ–è€…å…·æœ‰åˆ—ç‰¹å¾çš„å…ƒç´ )
            const cells = row.querySelectorAll('td, th, .col, [class*="col"], [class*="cell"], .h-editgird-cell');

            cells.forEach((cell, x) => {
                // è·³è¿‡ç©ºçš„æˆ–è€…åªæœ‰æ ·å¼çš„å•å…ƒæ ¼
                if (cell.classList.contains('setTopRow') || cell.classList.contains('col_first')) {
                    const isEmpty = !cell.textContent.trim() && !cell.getAttribute('title');
                    if (isEmpty) {
                        matrix[y][x] = '';
                        return;
                    }
                }

                let cellContent = '';

                // ä¸“é—¨å¤„ç† span å…ƒç´ çš„å†…å®¹
                const span = cell.querySelector('span[title]');
                if (span) {
                    // ä¼˜å…ˆä» span çš„ title å±æ€§è·å–
                    const titleText = span.getAttribute('title') || '';
                    if (titleText.trim()) {
                        cellContent = cleanText(titleText);
                    } else {
                        // ä» span çš„æ–‡æœ¬å†…å®¹è·å–
                        const textContent = getTextWithSeparators(span);
                        if (textContent.trim()) {
                            cellContent = cleanText(textContent);
                        }
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰ spanï¼Œå°è¯•ä»å•å…ƒæ ¼æœ¬èº«è·å–
                    const titleText = (cell.getAttribute('title') || '').trim();
                    if (titleText) {
                        cellContent = cleanText(titleText);
                    } else {
                        // ä»æ–‡æœ¬å†…å®¹è·å–
                        const textContent = getTextWithSeparators(cell);
                        if (textContent) {
                            cellContent = cleanText(textContent);
                        }
                    }
                }

                // æ¸…ç†æ ¼å¼
                cellContent = cleanTableCellContent(cellContent);

                matrix[y][x] = cellContent || '';
            });
        });

        if (matrix.length === 0) {
            return '';
        }

        // è®¡ç®—æœ€å¤§åˆ—æ•°
        const maxCols = Math.max(...matrix.map(row => row ? row.length : 0));

        if (maxCols === 0) {
            return '';
        }

        // ç¡®ä¿æ‰€æœ‰è¡Œéƒ½æœ‰ç›¸åŒçš„åˆ—æ•°
        matrix.forEach((row, index) => {
            if (!row) matrix[index] = [];
            while (matrix[index].length < maxCols) {
                matrix[index].push('');
            }
        });

        // è¿‡æ»¤æ‰å…¨ç©ºè¡Œ
        const filteredMatrix = matrix.filter(row =>
            row.some(cell => cell && cell.trim())
        );

        if (filteredMatrix.length === 0) {
            return '';
        }

        // ç”ŸæˆMarkdownè¡¨æ ¼
        let markdown = '\n';

        // å¦‚æœåªæœ‰ä¸€è¡Œæ•°æ®ï¼Œå¯èƒ½æ˜¯åˆ†ç¦»çš„è¡¨æ ¼è¡Œï¼Œä¸æ·»åŠ åˆ†éš”ç¬¦
        const shouldAddSeparator = filteredMatrix.length > 1;

        filteredMatrix.forEach((row, i) => {
            const formattedRow = row.map(cell => {
                // ç›´æ¥ä½¿ç”¨å·²ç»é€šè¿‡ cleanTableCellContent å¤„ç†è¿‡çš„å†…å®¹
                let content = (cell || '').toString();
                return content || ' ';
            });

            const rowContent = formattedRow.join(' | ');
            markdown += `| ${rowContent} |\n`;

            // åœ¨ç¬¬ä¸€è¡Œåæ·»åŠ åˆ†éš”ç¬¦
            // åªæœ‰åœ¨å¤šè¡Œè¡¨æ ¼çš„æƒ…å†µä¸‹æ‰æ·»åŠ åˆ†éš”ç¬¦
            if (i === 0 && shouldAddSeparator) {
                const separator = Array(maxCols).fill('---').join(' | ');
                markdown += `| ${separator} |\n`;
            }
        });

        markdown += '\n';

        return markdown;
    }

    // ä¸“é—¨å¤„ç† h-editgird è¡¨æ ¼
    function extractEditgirdTable(container, rows) {
        const matrix = [];

        rows.forEach((row, y) => {
            if (!matrix[y]) matrix[y] = [];

            // æŸ¥æ‰¾å•å…ƒæ ¼
            const cells = row.querySelectorAll('td, th');

            cells.forEach((cell, x) => {
                let cellContent = '';

                // å¯¹äº h-editgirdï¼Œä¼˜å…ˆä» span[title] è·å–å†…å®¹
                const span = cell.querySelector('span[title]');
                if (span) {
                    const titleText = span.getAttribute('title') || '';
                    if (titleText.trim()) {
                        cellContent = cleanText(titleText);
                    } else {
                        // å¦‚æœ title ä¸ºç©ºï¼Œè·å– span çš„æ–‡æœ¬
                        const spanText = span.textContent || '';
                        if (spanText.trim()) {
                            cellContent = cleanText(spanText);
                        }
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰ span[title]ï¼ŒæŸ¥æ‰¾ä»»ä½• span
                    const anySpan = cell.querySelector('span');
                    if (anySpan) {
                        const spanText = anySpan.textContent || '';
                        if (spanText.trim()) {
                            cellContent = cleanText(spanText);
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰ spanï¼Œä»å•å…ƒæ ¼çš„æ–‡æœ¬å†…å®¹è·å–
                        const textContent = getTextWithSeparators(cell);
                        if (textContent) {
                            cellContent = cleanText(textContent);
                        }
                    }
                }

                // æ¸…ç†æ ¼å¼
                cellContent = cleanTableCellContent(cellContent);

                matrix[y][x] = cellContent || '';
            });
        });

        if (matrix.length === 0) {
            return '';
        }

        // è®¡ç®—æœ€å¤§åˆ—æ•°
        const maxCols = Math.max(...matrix.map(row => row ? row.length : 0));

        if (maxCols === 0) {
            return '';
        }

        // ç¡®ä¿æ‰€æœ‰è¡Œéƒ½æœ‰ç›¸åŒçš„åˆ—æ•°
        matrix.forEach((row, index) => {
            if (!row) matrix[index] = [];
            while (matrix[index].length < maxCols) {
                matrix[index].push('');
            }
        });

        // ç”ŸæˆMarkdownè¡¨æ ¼
        let markdown = '\n';

        // å¦‚æœåªæœ‰ä¸€è¡Œæ•°æ®ï¼Œå¯èƒ½æ˜¯åˆ†ç¦»çš„è¡¨æ ¼è¡Œï¼Œä¸æ·»åŠ åˆ†éš”ç¬¦
        const shouldAddSeparator = matrix.length > 1;

        matrix.forEach((row, i) => {
            const formattedRow = row.map(cell => {
                // ç›´æ¥ä½¿ç”¨å·²ç»é€šè¿‡ cleanTableCellContent å¤„ç†è¿‡çš„å†…å®¹
                let content = (cell || '').toString();
                return content || ' ';
            });

            const rowContent = formattedRow.join(' | ');
            markdown += `| ${rowContent} |\n`;

            // åœ¨ç¬¬ä¸€è¡Œåæ·»åŠ åˆ†éš”ç¬¦
            if (i === 0 && shouldAddSeparator) {
                const separator = Array(maxCols).fill('---').join(' | ');
                markdown += `| ${separator} |\n`;
            }
        });

        markdown += '\n';

        return markdown;
    }

    // æ™ºèƒ½åˆ¤æ–­onclickå…ƒç´ æ˜¯å¦åº”è¯¥åˆ é™¤
    function shouldRemoveOnClickElement(element) {
        // å¦‚æœæ˜¯è¡¨æ ¼å†…çš„å†…å®¹é“¾æ¥ï¼Œæ›´åŠ ä¿å®ˆåœ°ä¿ç•™
        if (element.closest('table, tbody, tr, td, th, .h-editgird, .h-editgird-wrapper, .multiRowVariableColumn')) {
            const classList = element.className || '';
            const text = element.textContent || '';
            const title = element.title || '';

            // æ˜ç¡®çš„åŠŸèƒ½æŒ‰é’®ï¼Œåº”è¯¥åˆ é™¤
            if (classList.includes('setTop') || classList.includes('setTopRow') ||
                element.closest('.setTopRow') || element.closest('.setTop')) {
                console.log(`[MD Extractor] åˆ é™¤åŠŸèƒ½æŒ‰é’®: ${text}`);
                return true;
            }

            // æ£€æŸ¥çˆ¶å…ƒç´ æ˜¯å¦æ˜¯åŠŸèƒ½æŒ‰é’®å®¹å™¨
            const parentDiv = element.closest('div.setTop, div.setTopRow');
            if (parentDiv) {
                console.log(`[MD Extractor] åˆ é™¤åŠŸèƒ½æŒ‰é’®å®¹å™¨å†…å®¹: ${text}`);
                return true;
            }

            // å¯¹äºè¡¨æ ¼å†…çš„å…¶ä»–onclickå…ƒç´ ï¼Œé»˜è®¤ä¿ç•™
            // åªåˆ é™¤æ˜ç¡®åŒ¹é…åƒåœ¾æ¨¡å¼çš„å†…å®¹
            for (const pattern of CONFIG.ONCLICK_JUNK_PATTERNS) {
                if (pattern.test(text) || pattern.test(title)) {
                    console.log(`[MD Extractor] åˆ é™¤åƒåœ¾å†…å®¹: ${text}`);
                    return true;
                }
            }

            // è¡¨æ ¼å†…çš„å…¶ä»–onclickå…ƒç´ é»˜è®¤ä¿ç•™
            console.log(`[MD Extractor] ä¿ç•™è¡¨æ ¼å†…å®¹: ${text}`);
            return false;
        }

        // éè¡¨æ ¼åŒºåŸŸçš„onclickå…ƒç´ ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯åƒåœ¾
        const text = element.textContent || '';
        const title = element.title || '';

        for (const pattern of CONFIG.ONCLICK_JUNK_PATTERNS) {
            if (pattern.test(text) || pattern.test(title)) {
                return true;
            }
        }

        // é»˜è®¤ä¿ç•™
        return false;
    }

    // ä¸“é—¨å¤„ç†OAç³»ç»Ÿçš„ multiRowVariableColumn è¡¨æ ¼
    function extractOAMultiRowTable(container) {
        // é˜²é‡å¤å¤„ç†æ ‡è®°
        if (container.dataset && container.dataset.mdExtractorProcessed) {
            console.log('[MD Extractor] OAè¡¨æ ¼å·²å¤„ç†ï¼Œè·³è¿‡é‡å¤å¤„ç†');
            return '';
        }

        // æ ‡è®°ä¸ºå·²å¤„ç†
        if (container.dataset) {
            container.dataset.mdExtractorProcessed = 'true';
        }

        // æŸ¥æ‰¾æ‰€æœ‰çš„è¡¨æ ¼è¡Œ - æ”¹è¿›å®¹å™¨æŸ¥æ‰¾é€»è¾‘
        let tableContainer = container.querySelector('.multiRowVariableColumn') || container;
        let rows = tableContainer.querySelectorAll('table tr');

        // å¦‚æœæ‰¾ä¸åˆ°è¡Œï¼Œå°è¯•ç›´æ¥åœ¨å®¹å™¨ä¸­æŸ¥æ‰¾
        if (rows.length === 0) {
            rows = container.querySelectorAll('tr');
        }

        // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œå°è¯•æŸ¥æ‰¾tableå…ƒç´ 
        if (rows.length === 0) {
            const table = container.querySelector('table');
            if (table) {
                rows = table.querySelectorAll('tr');
            }
        }

        if (rows.length === 0) {
            console.log('OAè¡¨æ ¼æå–ï¼šæœªæ‰¾åˆ°è¡¨æ ¼è¡Œ');
            return '';
        }

        console.log(`[MD Extractor] OAè¡¨æ ¼æå–ï¼šæ‰¾åˆ° ${rows.length} è¡Œï¼Œå®¹å™¨:`, container.tagName, container.className);
        console.log(`[MD Extractor] ç¬¬ä¸€è¡ŒHTML:`, rows[0] ? rows[0].innerHTML : 'null');

        const matrix = [];

        // åˆ†æç¬¬ä¸€è¡Œï¼Œç¡®å®šåˆ—çš„ç»“æ„
        const firstRow = rows[0];
        const firstRowCells = firstRow.querySelectorAll('td');
        const columnNames = [];

        // æ™ºèƒ½æ¨æ–­åˆ—åï¼šæ ¹æ®å®é™…æ•°æ®å†…å®¹å’Œä½ç½®
        firstRowCells.forEach((cell, index) => {
            if (cell.classList.contains('col_first')) {
                columnNames.push('æ ‡é¢˜');
            } else if (cell.classList.contains('setTopRow')) {
                // è·³è¿‡ç½®é¡¶æŒ‰é’®åˆ—ï¼Œä¸æ·»åŠ åˆ°columnNames
                return;
            } else if (cell.classList.contains('variableColumn')) {
                // æ ¹æ®å†…å®¹æ¨æ–­åˆ—å
                const titleAttr = cell.getAttribute('title') || '';
                const textContent = getTextWithSeparators(cell);

                // é€šè¿‡å†…å®¹æ¨¡å¼æ¨æ–­åˆ—ç±»å‹
                if (/^\d{4}-\d{2}-\d{2}/.test(titleAttr) || /^\d{2}-\d{2}/.test(titleAttr) || /ä»Šæ—¥|æ˜¨æ—¥|\d{2}:\d{2}/.test(textContent)) {
                    columnNames.push('æ—¶é—´');
                } else if (/[\u4e00-\u9fa5]{2,4}/.test(titleAttr) && titleAttr.length <= 10 && !/(å¾…åŠ|å·²åŠ|å‘æ–‡|åˆåŒ|å®¡æ‰¹|éƒ¨é—¨|å…¬å¸|ç»„ç»‡)/.test(titleAttr)) {
                    // ä¸­æ–‡å§“åï¼š2-4ä¸ªä¸­æ–‡å­—ç¬¦ä¸”ä¸æ˜¯ä¸šåŠ¡æœ¯è¯­
                    columnNames.push('äººå‘˜');
                } else if (/å¾…åŠ|å·²åŠ|å‘æ–‡|åˆåŒ|å®¡æ‰¹|é€šçŸ¥|ç”³è¯·|æŠ¥å‘Š/.test(titleAttr)) {
                    columnNames.push('ç±»å‹');
                } else if (/éƒ¨é—¨|å…¬å¸|ç»„ç»‡|åˆ†å…¬å¸|å­å…¬å¸|ä¸­å¿ƒ/.test(titleAttr)) {
                    columnNames.push('éƒ¨é—¨');
                } else if (/é‡è¦|ç´§æ€¥|ä¸€èˆ¬|é«˜|ä¸­|ä½/.test(titleAttr)) {
                    columnNames.push('ä¼˜å…ˆçº§');
                } else if (/æœªè¯»|å·²è¯»|å·²å¤„ç†|å¾…å¤„ç†/.test(titleAttr)) {
                    columnNames.push('çŠ¶æ€');
                } else if (/^\d+$/.test(titleAttr)) {
                    columnNames.push('ç¼–å·');
                } else {
                    // é»˜è®¤åˆ—åï¼šæ ¹æ®ä½ç½®æ¨æ–­
                    const columnIndex = columnNames.length + 1;
                    if (columnIndex === 2) {
                        columnNames.push('å‘èµ·äºº');
                    } else if (columnIndex === 3) {
                        columnNames.push('æ—¶é—´');
                    } else {
                        columnNames.push(`åˆ—${columnIndex}`);
                    }
                }
            } else {
                columnNames.push(`åˆ—${columnNames.length + 1}`);
            }
        });

        // æ·»åŠ è¡¨å¤´
        if (columnNames.length > 0) {
            matrix.push(columnNames);
        }

        rows.forEach((row, rowIndex) => {
            const cells = row.querySelectorAll('td');
            const rowData = [];

            cells.forEach((cell, cellIndex) => {
                // è·³è¿‡ç½®é¡¶æŒ‰é’®åˆ—
                if (cell.classList.contains('setTopRow')) {
                    return;
                }

                let cellContent = '';

                if (cell.classList.contains('col_first')) {
                    // ç¬¬ä¸€åˆ—ï¼šæå–æ ‡é¢˜ä¿¡æ¯
                    cellContent = extractFirstColumnContent(cell);
                    console.log(`[MD Extractor] ç¬¬ä¸€åˆ—å†…å®¹: "${cellContent}", HTML:`, cell.innerHTML);
                } else if (cell.classList.contains('variableColumn')) {
                    // å…¶ä»–åˆ—ï¼šæå–å„ç§ç±»å‹çš„å†…å®¹
                    cellContent = extractVariableColumnContent(cell);
                    console.log(`[MD Extractor] å˜é‡åˆ—å†…å®¹: "${cellContent}", title: "${cell.getAttribute('title')}"`);
                } else {
                    // æ™®é€šå•å…ƒæ ¼
                    cellContent = extractGenericCellContent(cell);
                    console.log(`[MD Extractor] æ™®é€šå•å…ƒæ ¼å†…å®¹: "${cellContent}"`);
                }

                if (cellContent && cellContent.trim()) {
                    rowData.push(cleanTableCellContent(cellContent));
                } else {
                    rowData.push(''); // ä¿æŒåˆ—å¯¹é½
                }
            });

            // è¿‡æ»¤æ‰ç©ºè¡Œ
            if (rowData.length > 0 && rowData.some(cell => cell.trim())) {
                matrix.push(rowData);
            }
        });

        console.log(`[MD Extractor] å¤„ç†å®Œæ‰€æœ‰è¡Œåï¼ŒçŸ©é˜µé•¿åº¦: ${matrix.length}`);
        console.log(`[MD Extractor] çŸ©é˜µå†…å®¹:`, matrix);

        if (matrix.length === 0) {
            console.log('[MD Extractor] OAè¡¨æ ¼çŸ©é˜µä¸ºç©ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²');
            return '';
        }

        // è®¡ç®—æœ€å¤§åˆ—æ•°
        const maxCols = Math.max(...matrix.map(row => row.length));

        // ç¡®ä¿æ‰€æœ‰è¡Œéƒ½æœ‰ç›¸åŒçš„åˆ—æ•°
        matrix.forEach((row, index) => {
            while (row.length < maxCols) {
                row.push('');
            }
        });

        // ç”ŸæˆMarkdownè¡¨æ ¼
        let markdown = '\n';

        // å¦‚æœåªæœ‰ä¸€è¡Œæ•°æ®ï¼Œå¯èƒ½æ˜¯åˆ†ç¦»çš„è¡¨æ ¼è¡Œï¼Œä¸æ·»åŠ åˆ†éš”ç¬¦
        const shouldAddSeparator = matrix.length > 1;

        matrix.forEach((row, i) => {
            const formattedRow = row.map(cell => cell || ' ');
            const rowContent = formattedRow.join(' | ');
            markdown += `| ${rowContent} |\n`;

            // åœ¨ç¬¬ä¸€è¡Œåæ·»åŠ åˆ†éš”ç¬¦
            // åªæœ‰åœ¨å¤šè¡Œè¡¨æ ¼çš„æƒ…å†µä¸‹æ‰æ·»åŠ åˆ†éš”ç¬¦
            if (i === 0 && shouldAddSeparator) {
                const separator = Array(maxCols).fill('---').join(' | ');
                markdown += `| ${separator} |\n`;
            }
        });

        markdown += '\n';

        console.log(`[MD Extractor] ç”Ÿæˆçš„markdowné•¿åº¦: ${markdown.length}`);
        console.log(`[MD Extractor] ç”Ÿæˆçš„markdownå†…å®¹:`, markdown);

        return markdown;
    }

    // =================================================================================
    // --- è¾…åŠ©å‡½æ•° (Helper Functions) ---
    // =================================================================================

    // ä¸“é—¨ç”¨äºæ¸…ç†è¡¨æ ¼å•å…ƒæ ¼å†…å®¹çš„å‡½æ•°
    function cleanTableCellContent(content) {
        if (!content) return '';

        let cleaned = content.toString();

        // 1. ç§»é™¤HTMLæ ‡ç­¾å’Œæ³¨é‡Š
        cleaned = cleaned
            .replace(/<[^>]*>/g, '')           // ç§»é™¤HTMLæ ‡ç­¾
            .replace(/<!--[\s\S]*?-->/g, '')  // ç§»é™¤HTMLæ³¨é‡Š
            .replace(/&nbsp;/g, ' ')          // è½¬æ¢&nbsp;ä¸ºç©ºæ ¼
            .replace(/&[a-zA-Z0-9]+;/g, ' '); // ç§»é™¤HTMLå®ä½“

        // 2. æ™ºèƒ½å¤„ç†æ¢è¡Œç¬¦ - æ›´ä¿å®ˆçš„å¤„ç†
        cleaned = cleaned
            .replace(/\r\n/g, '\n')           // ç»Ÿä¸€æ¢è¡Œç¬¦
            .replace(/\n{3,}/g, '\n\n')       // æœ€å¤šä¿ç•™ä¸¤ä¸ªæ¢è¡Œç¬¦
            .replace(/\n\s*\n/g, '\n')        // åˆå¹¶è¿ç»­çš„ç©ºè¡Œ
            .replace(/\n\s*[-â€¢*]\s*/g, '; ')  // åˆ—è¡¨é¡¹è½¬ä¸ºåˆ†å·åˆ†éš”
            .replace(/\n\s*\d+\.\s*/g, '; ')  // æ•°å­—åˆ—è¡¨è½¬ä¸ºåˆ†å·åˆ†éš”
            .replace(/\n{2,}/g, ' ')          // æ®µè½åˆ†éš”è½¬ä¸ºå•ä¸ªç©ºæ ¼
            .replace(/\n/g, ' ')              // å‰©ä½™æ¢è¡Œç¬¦è½¬ç©ºæ ¼
            .replace(/\s+/g, ' ')             // å¤šä¸ªç©ºæ ¼åˆå¹¶
            .trim();

        // 3. è½¬ä¹‰Markdownç‰¹æ®Šå­—ç¬¦ï¼ˆåªè½¬ä¹‰ä¼šç ´åè¡¨æ ¼çš„å­—ç¬¦ï¼‰
        cleaned = cleaned
            .replace(/\|/g, '\\|');           // è½¬ä¹‰ç®¡é“ç¬¦

        // 4. å¤„ç†è¿‡é•¿å†…å®¹
        if (cleaned.length > 150) {
            cleaned = cleaned.substring(0, 147) + '...';
        }

        return cleaned || ' '; // ç©ºå•å…ƒæ ¼ç”¨ç©ºæ ¼å ä½
    }

    // è·å–å¸¦ç»“æ„åˆ†éš”ç¬¦çš„æ–‡æœ¬å†…å®¹
    function getTextWithSeparators(element) {
        if (!element) return '';

        let result = '';

        function traverse(node) {
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent.trim();
                if (text) {
                    // å¦‚æœå‰é¢æœ‰æ–‡æœ¬ä¸”å½“å‰ä¸ä»¥ç©ºæ ¼ç»“å°¾ï¼Œæ·»åŠ ç©ºæ ¼
                    if (result && !result.endsWith(' ')) {
                        result += ' ';
                    }
                    result += text;
                }
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                // å¿½ç•¥ä¸å¯è§å…ƒç´ 
                const style = window.getComputedStyle(node);
                if (style.display === 'none' || style.visibility === 'hidden') {
                    return;
                }

                const tagName = node.tagName;

                // å¤„ç†cap4-radioç»„ä»¶
                if (node.classList && (node.classList.contains('cap4-radio__left') || node.classList.contains('cap4-radio'))) {
                    const labelElement = node.querySelector('.label-margin, .cap4-ctrl__label, .cap4-radio__left .label-margin, .cap4-radio__left .cap4-ctrl__label');
                    if (labelElement) {
                        const labelText = labelElement.textContent.trim();
                        if (labelText) {
                            // æ£€æŸ¥æ˜¯å¦é€‰ä¸­ï¼šæŸ¥æ‰¾æ˜¯-checkedæˆ–å…¶ä»–é€‰ä¸­çŠ¶æ€çš„ç±»
                            let isChecked = false;
                            const radioContainer = node.closest('.cap4-radio') || node;
                            if (radioContainer && radioContainer.classList) {
                                isChecked = radioContainer.classList.contains('is-checked') ||
                                           radioContainer.classList.contains('checked') ||
                                           radioContainer.classList.contains('selected');
                            }

                            const symbol = isChecked ? 'âŠ™' : 'â—‹';
                            if (result && !result.endsWith(' ')) {
                                result += ' ';
                            }
                            result += `${symbol} ${labelText}`;
                            if (!result.endsWith(' ')) {
                                result += ' ';
                            }
                            return; // å·²å¤„ç†ï¼Œä¸éœ€è¦ç»§ç»­é€’å½’
                        }
                    }
                }

                // æ‰©å±•éœ€è¦åˆ†éš”ç¬¦çš„å…ƒç´ ç±»å‹
                const isBlockElement = ['DIV', 'P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'LI', 'TD', 'TH', 'SECTION', 'ARTICLE', 'HEADER', 'FOOTER', 'UL', 'OL', 'DL', 'FORM', 'FIELDSET'].includes(tagName);
                const isInlineElementNeedsSeparator = ['SPAN', 'LABEL', 'A', 'BUTTON', 'INPUT', 'SELECT', 'TEXTAREA', 'EM', 'STRONG', 'B', 'I', 'CODE', 'KBD', 'SAMP', 'VAR'].includes(tagName);

                // æ£€æŸ¥æ˜¯å¦æ˜¯ç›¸é‚»çš„å…„å¼Ÿå…ƒç´ ï¼Œå¦‚æœæ˜¯åˆ™åœ¨å‰é¢æ·»åŠ åˆ†éš”ç¬¦
                const isAdjacentSibling = node.previousSibling &&
                    node.previousSibling.nodeType === Node.ELEMENT_NODE &&
                    result && !result.endsWith(' ');

                // æ£€æŸ¥æ˜¯å¦æ˜¯æ®µè½å¼€å§‹ï¼ˆé¿å…åœ¨æ®µè½å¼€å§‹æ·»åŠ ç©ºæ ¼ï¼‰
                const isParagraphStart = result === '' || result.endsWith('\n') || result.endsWith('\n\n');

                // åœ¨å…ƒç´ å¼€å§‹å‰æ·»åŠ åˆ†éš”ç¬¦ï¼ˆå¦‚æœéœ€è¦ä¸”ä¸æ˜¯æ®µè½å¼€å§‹ï¼‰
                if ((isBlockElement || isInlineElementNeedsSeparator || isAdjacentSibling) &&
                    result && !result.endsWith(' ') && !isParagraphStart) {
                    result += ' ';
                }

                // é€’å½’å¤„ç†å­èŠ‚ç‚¹
                for (let child of node.childNodes) {
                    traverse(child);
                }

                // åœ¨å…ƒç´ ç»“æŸåæ·»åŠ åˆ†éš”ç¬¦ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if ((isBlockElement || isInlineElementNeedsSeparator) && result && !result.endsWith(' ')) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…„å¼Ÿå…ƒç´ ï¼Œå¦‚æœæœ‰åˆ™æ·»åŠ åˆ†éš”ç¬¦
                    const hasNextSibling = node.nextSibling &&
                        (node.nextSibling.nodeType === Node.ELEMENT_NODE ||
                         (node.nextSibling.nodeType === Node.TEXT_NODE && node.nextSibling.textContent.trim()));

                    if (hasNextSibling) {
                        result += ' ';
                    }
                }
            }
        }

        traverse(element);

        // æ¸…ç†å¤šä½™çš„ç©ºç™½ç¬¦
        return result.replace(/\s+/g, ' ').trim();
    }

    function cleanText(text) {
        if (typeof text !== 'string') return '';

        let cleanedText = text;

        // åº”ç”¨æ¸…ç†è§„åˆ™ï¼Œä½†ä¿ç•™æœ‰æ„ä¹‰çš„å†…å®¹
        CONFIG.CLEANUP_KEYWORDS.forEach(keyword => {
            if (keyword instanceof RegExp) {
                cleanedText = cleanedText.replace(keyword, '');
            }
        });

        // æ¸…ç†å¤šä½™çš„ç©ºç™½å­—ç¬¦ï¼Œä½†ä¿ç•™æ ¼å¼
        cleanedText = cleanedText
            .replace(/\r\n/g, '\n')          // ç»Ÿä¸€æ¢è¡Œç¬¦
            .replace(/\t/g, ' ')             // Tabè½¬ç©ºæ ¼
            .replace(/[ ]{2,}/g, ' ')        // å¤šä¸ªç©ºæ ¼åˆå¹¶ä¸ºä¸€ä¸ªï¼ˆä¿ç•™å•ä¸ªç©ºæ ¼ï¼‰
            .replace(/\n +/g, '\n')          // è¡Œé¦–ç©ºæ ¼
            .replace(/ +\n/g, '\n')          // è¡Œå°¾ç©ºæ ¼
            .replace(/\n{3,}/g, '\n\n')      // å¤šä¸ªæ¢è¡Œç¬¦åˆå¹¶ä¸ºä¸¤ä¸ª
            .trim();

        // ç§»é™¤å¸¸è§çš„æ— æ„ä¹‰æ–‡æœ¬ï¼Œä½†ä¿ç•™å®é™…æ•°æ®
        const meaninglessPatterns = [
            /^è¯·é€‰æ‹©$/,
            /^è¯·è¾“å…¥$/,
            /^å¾…å¡«å†™$/,
            /^\.{3,}$/,
            /^â€”+$/,
            /^-+$/,
            /^\s*$/,
            /^undefined$/,
            /^null$/,
            /^NaN$/
        ];

        for (const pattern of meaninglessPatterns) {
            if (pattern.test(cleanedText)) {
                return '';
            }
        }

        // å¦‚æœæ–‡æœ¬å¾ˆçŸ­ä¸”å¯èƒ½æ˜¯UIå…ƒç´ æ–‡æœ¬ï¼Œè¿›è¡Œé¢å¤–æ£€æŸ¥
        if (cleanedText.length < 10) {
            const uiTexts = [
                'å±•å¼€', 'æ”¶èµ·', 'æ›´å¤š', 'ç¡®å®š', 'å–æ¶ˆ', 'ä¿å­˜', 'ç¼–è¾‘', 'åˆ é™¤',
                'æ·»åŠ ', 'æ–°å¢', 'ä¿®æ”¹', 'æŸ¥çœ‹', 'è¯¦æƒ…', 'è¿”å›', 'å…³é—­', 'æäº¤',
                'icon', 'arrow', 'dropdown'
            ];

            if (uiTexts.some(ui => cleanedText.includes(ui))) {
                return '';
            }
        }

        return cleanedText;
    }

    // å¢å¼ºçš„å†…å®¹æ£€æŸ¥å‡½æ•°ï¼ˆæ¥è‡ªv6.3.1çš„æ”¹è¿›ï¼‰
    function isActualContent(text, element) {
        // é•¿åº¦æ£€æŸ¥
        if (text.length > 100) return true; // é•¿æ–‡æœ¬å¯èƒ½æ˜¯å®é™…å†…å®¹
        if (text.length < 2) return false;   // å¤ªçŸ­æ— æ³•æˆä¸ºæœ‰æ•ˆå†…å®¹

        // æ•°å­—æ¨¡å¼æ£€æŸ¥ï¼ˆè´¢åŠ¡æ•°æ®ï¼‰
        if (/^\d{1,3}(,\d{3})*(\.\d+)?$/.test(text)) return true; // æ ¼å¼åŒ–æ•°å­—
        if (/^\d+(\.\d+)?%?$/.test(text)) return true; // æ•°å­—æˆ–ç™¾åˆ†æ¯”
        if (/^\d{4}-\d{2}-\d{2}$/.test(text)) return true; // æ—¥æœŸæ ¼å¼

        // ä¸­æ–‡å†…å®¹æ£€æŸ¥
        if (/[\u4e00-\u9fa5]{2,}/.test(text)) {
            const uiTexts = ['è¯·é€‰æ‹©', 'è¯·è¾“å…¥', 'å¾…å¡«å†™', 'å±•å¼€', 'æ”¶èµ·', 'æ›´å¤š', 'ç¡®å®š', 'å–æ¶ˆ', 'ä¿å­˜'];
            return !uiTexts.some(ui => text.includes(ui));
        }

        // è‹±æ–‡å†…å®¹æ£€æŸ¥
        if (/^[a-zA-Z\s]{3,}$/.test(text)) {
            const uiTexts = ['select', 'input', 'choose', 'enter', 'more', 'expand', 'collapse'];
            return !uiTexts.some(ui => text.toLowerCase().includes(ui));
        }

        // å…ƒç´ æ ·å¼å’Œä½ç½®æ£€æŸ¥
        if (element) {
            const computed = window.getComputedStyle(element);

            // éšè—å…ƒç´ å¯èƒ½ä¸æ˜¯å®é™…å†…å®¹
            if (computed.display === 'none' || computed.visibility === 'hidden') {
                return false;
            }

            // éå¸¸å°çš„å…ƒç´ å¯èƒ½æ˜¯è£…é¥°æ€§çš„
            const rect = element.getBoundingClientRect();
            if (rect.width < 10 || rect.height < 10) {
                return false;
            }
        }

        return true;
    }


    function autoDetectContent() {
        console.log('ğŸ” å¼€å§‹æ™ºèƒ½æ£€æµ‹...');

        const selectors = [
            // å¸¸è§çš„ä¸»å†…å®¹åŒºåŸŸé€‰æ‹©å™¨
            '[class*="tbase-factor-main"]',
            '#subapp-container',
            '#data_app_container',
            '.h-layout-main-container',
            '.h-layout-content',
            '[class*="tbase-page"]',
            '.bizframe',
            '[class*="main-content"]',
            'main',
            '[role="main"]',
            '.container',
            '.content',
            '#content',
            '.main-container',
            '.page-content'
        ];

        for (const selector of selectors) {
            try {
                const element = document.querySelector(selector);
                if (element && isValidContent(element)) {
                    const selectorInput = document.getElementById('selector-input');
                    if (selectorInput) {
                        selectorInput.value = selector;
                    }
                    highlightElement(selector);
                    showStatus(`âœ… æ™ºèƒ½æ£€æµ‹æˆåŠŸ: ${selector}`, 'success');
                    return;
                }
            } catch (e) {
                console.warn('æ™ºèƒ½æ£€æµ‹é€‰æ‹©å™¨æ— æ•ˆ:', selector, e);
            }
        }

        showStatus('âŒ æœªæ£€æµ‹åˆ°æœ€ä½³å†…å®¹åŒºåŸŸï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©', 'error');
    }

    function isValidContent(element) {
        if (!element || typeof element.getBoundingClientRect !== 'function') {
            return false;
        }

        try {
            const rect = element.getBoundingClientRect();
            if (rect.width < 200 || rect.height < 100) {
                return false;
            }

            const text = element.innerText || element.textContent || '';
            if (text.trim().length < 50) {
                return false;
            }

            // æ£€æŸ¥æ˜¯å¦åŒ…å«æœ‰æ„ä¹‰çš„å†…å®¹
            const hasFormContent = element.querySelector('form, table, .h-form-item, input, textarea, select');
            const hasBusinessContent = /äº§å“|ä¿¡æ‰˜|æŠ•èµ„|å®¡æ‰¹|å†…å®¹|ä¿¡æ¯|æ•°æ®|è¡¨æ ¼/.test(text);

            return hasFormContent || hasBusinessContent || text.length > 500;
        } catch (e) {
            console.warn('éªŒè¯å†…å®¹æ—¶å‡ºé”™:', e);
            return false;
        }
    }

    async function autoExpandContent(element) {
        if (!element) return;

        try {
            showStatus('æ­£åœ¨æŸ¥æ‰¾å¯å±•å¼€å†…å®¹...', 'info');

            // åˆ†å¤šè½®è¿›è¡Œå±•å¼€ï¼Œç¡®ä¿å±•å¼€åæ–°å‡ºç°çš„å†…å®¹ä¹Ÿèƒ½è¢«å±•å¼€
            let totalExpanded = 0;
            const maxRounds = 3; // æœ€å¤š3è½®å±•å¼€

            for (let round = 0; round < maxRounds; round++) {
                console.log(`å¼€å§‹ç¬¬ ${round + 1} è½®å±•å¼€...`);

                const expandedThisRound = await performExpandRound(element);
                totalExpanded += expandedThisRound;

                if (expandedThisRound === 0) {
                    console.log('æœ¬è½®æœªæ‰¾åˆ°æ–°çš„å±•å¼€å†…å®¹ï¼Œåœæ­¢');
                    break;
                }

                // ç­‰å¾…é¡µé¢æ›´æ–°
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            if (totalExpanded > 0) {
                showStatus(`æ€»å…±æˆåŠŸå±•å¼€ ${totalExpanded} ä¸ªå†…å®¹åŒºåŸŸ`, 'success');
            } else {
                showStatus('æœªæ‰¾åˆ°å¯å±•å¼€å†…å®¹', 'info');
            }

        } catch (e) {
            console.warn('è‡ªåŠ¨å±•å¼€å†…å®¹æ—¶å‡ºé”™:', e);
            showStatus('è‡ªåŠ¨å±•å¼€æ—¶å‡ºç°é”™è¯¯', 'error');
        }
    }

    async function performExpandRound(element) {
        const clickTargets = [];

        // ç­–ç•¥1: æŸ¥æ‰¾åŒ…å«"å±•å¼€"æ–‡æœ¬çš„å…ƒç´ 
        const textElements = element.querySelectorAll('*');
        for (const el of textElements) {
            const text = el.textContent || '';
            const hasExpandText = /å±•å¼€|æ›´å¤š|æŸ¥çœ‹æ›´å¤š|æ˜¾ç¤ºæ›´å¤š|show more|expand/i.test(text);

            if (hasExpandText && text.trim().length < 20) { // é¿å…é€‰ä¸­åŒ…å«å¤§é‡æ–‡æœ¬çš„å®¹å™¨
                // æ£€æŸ¥æ˜¯å¦å¯èƒ½æ˜¯ç‚¹å‡»ç›®æ ‡
                const isClickTarget = el.onclick ||
                                    el.getAttribute('onclick') ||
                                    el.style.cursor === 'pointer' ||
                                    ['A', 'BUTTON'].includes(el.tagName) ||
                                    el.classList.contains('clickable') ||
                                    el.hasAttribute('data-click') ||
                                    el.closest('[onclick]') ||
                                    el.querySelector('[onclick]');

                if (isClickTarget || el.classList.contains('t-base-view-common-title')) {
                    clickTargets.push(el);
                    console.log('æ‰¾åˆ°å±•å¼€ç›®æ ‡:', el, 'æ–‡æœ¬:', text.trim());
                }
            }
        }

        // ç­–ç•¥2: æŸ¥æ‰¾ç‰¹å®šçš„å±•å¼€ç»“æ„
        const expandStructures = [
            '.t-base-view-common-title',
            '[class*="expand"]',
            '[class*="more"]',
            '[class*="toggle"]',
            '[class*="collapse"]',
            '[data-toggle]',
            '[data-expand]',
            '.expandable',
            '.collapsible'
        ];

        for (const selector of expandStructures) {
            try {
                const elements = element.querySelectorAll(selector);
                elements.forEach(el => {
                    const text = el.textContent || '';
                    if (/å±•å¼€|æ›´å¤š|expand|more/i.test(text) && !clickTargets.includes(el)) {
                        clickTargets.push(el);
                        console.log('æ‰¾åˆ°å±•å¼€ç»“æ„:', el, 'é€‰æ‹©å™¨:', selector);
                    }
                });
            } catch (e) {
                console.warn('å±•å¼€ç»“æ„æŸ¥æ‰¾å¤±è´¥:', selector, e);
            }
        }

        // ç­–ç•¥3: æŸ¥æ‰¾å¸¦æœ‰ç‰¹å®šå›¾æ ‡çš„å¯ç‚¹å‡»å…ƒç´ 
        const iconElements = element.querySelectorAll('i[class*="arrow"], i[class*="down"], i[class*="expand"], .iconfont, [class*="icon-"]');
        iconElements.forEach(icon => {
            const clickableParent = icon.closest('[onclick], .clickable, button, a') || icon.parentElement;
            if (clickableParent) {
                const text = clickableParent.textContent || '';
                if (/å±•å¼€|æ›´å¤š|expand|more/i.test(text) && !clickTargets.includes(clickableParent)) {
                    clickTargets.push(clickableParent);
                    console.log('æ‰¾åˆ°å›¾æ ‡å±•å¼€æŒ‰é’®:', clickableParent);
                }
            }
        });

        // å»é‡å¹¶è¿‡æ»¤å·²å¤„ç†çš„å…ƒç´ 
        const uniqueTargets = [...new Set(clickTargets)].filter(target => {
            // é¿å…é‡å¤ç‚¹å‡»å·²ç»å±•å¼€çš„å†…å®¹
            const text = target.textContent || '';
            return !text.includes('æ”¶èµ·') && !target.dataset.expanded;
        });

        if (uniqueTargets.length === 0) {
            return 0;
        }

        console.log(`æœ¬è½®æ‰¾åˆ° ${uniqueTargets.length} ä¸ªå±•å¼€ç›®æ ‡`);

        let successCount = 0;
        for (const btn of uniqueTargets) {
            try {
                console.log('å°è¯•ç‚¹å‡»å±•å¼€æŒ‰é’®:', btn);

                const success = await tryClickElement(btn);
                if (success) {
                    successCount++;
                    btn.dataset.expanded = 'true'; // æ ‡è®°å·²å¤„ç†

                    // æ¯æ¬¡ç‚¹å‡»åç­‰å¾…ä¸€ä¸‹
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

            } catch (e) {
                console.warn('ç‚¹å‡»å±•å¼€æŒ‰é’®å¤±è´¥:', btn, e);
            }
        }

        return successCount;
    }

    async function tryClickElement(element) {
        const clickMethods = [
            // æ–¹æ³•1: æ ‡å‡†ç‚¹å‡»
            () => {
                element.click();
                return true;
            },

            // æ–¹æ³•2: äº‹ä»¶åˆ†å‘
            () => {
                const event = new MouseEvent('click', {
                    bubbles: true,
                    cancelable: true,
                    view: window
                });
                return element.dispatchEvent(event);
            },

            // æ–¹æ³•3: æ‰§è¡Œonclickå±æ€§
            () => {
                const onclick = element.getAttribute('onclick');
                if (onclick) {
                    try {
                        new Function(onclick).call(element);
                        return true;
                    } catch (e) {
                        console.warn('æ‰§è¡Œonclickå¤±è´¥:', e);
                        return false;
                    }
                }
                return false;
            },

            // æ–¹æ³•4: è°ƒç”¨onclickå‡½æ•°
            () => {
                if (typeof element.onclick === 'function') {
                    element.onclick();
                    return true;
                }
                return false;
            },

            // æ–¹æ³•5: å°è¯•ç‚¹å‡»å­å…ƒç´ 
            () => {
                const clickableChild = element.querySelector('span, div, i, a, button');
                if (clickableChild) {
                    clickableChild.click();
                    return true;
                }
                return false;
            },

            // æ–¹æ³•6: æ¨¡æ‹Ÿé¼ æ ‡äº‹ä»¶åºåˆ—
            () => {
                ['mousedown', 'mouseup', 'click'].forEach(eventType => {
                    const event = new MouseEvent(eventType, {
                        bubbles: true,
                        cancelable: true,
                        view: window
                    });
                    element.dispatchEvent(event);
                });
                return true;
            }
        ];

        // å°è¯•æ¯ç§ç‚¹å‡»æ–¹å¼
        for (let i = 0; i < clickMethods.length; i++) {
            try {
                const result = clickMethods[i]();
                if (result) {
                    console.log(`ç‚¹å‡»æ–¹æ³• ${i + 1} æˆåŠŸ`);
                    return true;
                }
            } catch (e) {
                console.warn(`ç‚¹å‡»æ–¹æ³• ${i + 1} å¤±è´¥:`, e);
            }
        }

        console.warn('æ‰€æœ‰ç‚¹å‡»æ–¹æ³•éƒ½å¤±è´¥äº†');
        return false;
    }

    async function copyToClipboard(text) {
        if (!text) {
            showStatus('æ²¡æœ‰å†…å®¹å¯å¤åˆ¶', 'error');
            return false;
        }

        try {
            // ä¼˜å…ˆä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                showStatus(`âœ… å·²å¤åˆ¶ ${text.length} å­—ç¬¦`, 'success');
                return true;
            }
        } catch (err) {
            console.warn('Clipboard API å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ–¹æ³•:', err);
        }

        // å›é€€åˆ°ä¼ ç»Ÿæ–¹æ³•
        return execCommandCopy(text);
    }

    function execCommandCopy(text) {
        try {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.cssText = `
                position: fixed !important;
                top: -9999px !important;
                left: -9999px !important;
                opacity: 0 !important;
                pointer-events: none !important;
            `;

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);

            if (successful) {
                showStatus(`âœ… å·²å¤åˆ¶ ${text.length} å­—ç¬¦ (å…¼å®¹æ¨¡å¼)`, 'success');
                return true;
            } else {
                showStatus('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·ä½¿ç”¨æ‰‹åŠ¨å¤åˆ¶', 'error');
                console.error('execCommand copy failed');
                return false;
            }
        } catch (err) {
            console.error('Fallback copy failed:', err);
            showStatus('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·ä½¿ç”¨æ‰‹åŠ¨å¤åˆ¶', 'error');
            return false;
        }
    }

    async function previewContent() {
        showStatus('æ­£åœ¨ç”Ÿæˆé¢„è§ˆ...', 'info');

        if (selectionContext.source === 'iframe') {
            let iframeEl = document.getElementById(selectionContext.iframeId);

            // å¦‚æœé€šè¿‡IDæ‰¾ä¸åˆ°ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
            if (!iframeEl && selectionContext.iframeId) {
                console.warn('é¢„è§ˆ: é€šè¿‡IDæœªæ‰¾åˆ°iframeï¼Œå°è¯•æŸ¥æ‰¾æ‰€æœ‰iframe');
                const iframes = document.querySelectorAll('iframe');
                for (let iframe of iframes) {
                    if (iframe.id === selectionContext.iframeId ||
                        iframe.id.includes('mde-iframe')) {
                        iframeEl = iframe;
                        console.log('é¢„è§ˆ: æ‰¾åˆ°å¤‡é€‰iframe:', iframe.id);
                        break;
                    }
                }
            }

            if (iframeEl) {
                console.log('Requesting preview from iframe:', selectionContext.iframeId, 'with selector:', selectionContext.selector);
                const autoExpand = document.getElementById('auto-expand').checked;
                const structuredMode = document.getElementById('structured-mode').checked;
                iframeEl.contentWindow.postMessage({
                    type: 'doPreview',
                    selector: selectionContext.selector,
                    autoExpand,
                    structuredMode
                }, '*');
            } else {
                showStatus('é”™è¯¯: æ‰¾ä¸åˆ°æºiframeã€‚å°è¯•åœ¨å½“å‰é¡µé¢é¢„è§ˆ...', 'warning');
                // é™çº§åˆ°å½“å‰é¡µé¢é¢„è§ˆ
                selectionContext.source = 'top';
                const selectorInput = document.getElementById('selector-input');
                if (selectorInput && selectionContext.selector) {
                    selectorInput.value = selectionContext.selector;
                    // é€’å½’è°ƒç”¨ï¼Œç°åœ¨ä½¿ç”¨topæ¨¡å¼
                    await previewContent();
                    return;
                } else {
                    showStatus('æ— æ³•é¢„è§ˆï¼šé€‰æ‹©å™¨ä¸¢å¤±', 'error');
                }
            }
            return;
        }

        const selector = document.getElementById('selector-input').value.trim();
        if (!selector) {
            showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…ƒç´ ', 'error');
            return;
        }

        try {
            const element = document.querySelector(selector);
            if (!element) {
                showStatus('æœªæ‰¾åˆ°å…ƒç´ ', 'error');
                return;
            }

            const autoExpandCheckbox = document.getElementById('auto-expand');
            if (autoExpandCheckbox && autoExpandCheckbox.checked) {
                await autoExpandContent(element);
            }

            const structuredModeCheckbox = document.getElementById('structured-mode');
            const structuredMode = structuredModeCheckbox ? structuredModeCheckbox.checked : true;

            const content = processExtraction(element, structuredMode);

            if (!content || !content.trim()) {
                showStatus('é¢„è§ˆå†…å®¹ä¸ºç©º', 'error');
                openPreviewWindow('<!-- é¢„è§ˆå†…å®¹ä¸ºç©º -->', 'Markdown é¢„è§ˆ (ç©º)');
                return;
            }

            openPreviewWindow(content);
            showStatus('é¢„è§ˆå·²ç”Ÿæˆ', 'success');

        } catch (error) {
            showStatus(`é¢„è§ˆå¤±è´¥: ${error.message}`, 'error');
            console.error('é¢„è§ˆé”™è¯¯:', error);
        }
    }

    async function handleExportHtml() {
        showStatus('æ­£åœ¨å¯¼å‡ºHTML...', 'info');

        if (selectionContext.source === 'iframe') {
            const iframeEl = document.getElementById(selectionContext.iframeId);
            if (iframeEl) {
                console.log('Requesting HTML export from iframe:', selectionContext.iframeId, 'with selector:', selectionContext.selector);
                iframeEl.contentWindow.postMessage({
                    type: 'doExportHtml',
                    selector: selectionContext.selector,
                }, '*');
            } else {
                showStatus('é”™è¯¯: æ‰¾ä¸åˆ°æºiframeã€‚', 'error');
            }
            return;
        }

        const selector = document.getElementById('selector-input').value.trim();
        if (!selector) {
            showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…ƒç´ ', 'error');
            return;
        }

        console.log('[HTML Export] å½“å‰é€‰æ‹©å™¨:', selector);
        showStatus(`æ­£åœ¨å¯¼å‡ºHTML... é€‰æ‹©å™¨: ${selector}`, 'info');

        try {
            const element = document.querySelector(selector);
            if (!element) {
                showStatus('æœªæ‰¾åˆ°å…ƒç´ ', 'error');
                return;
            }

            // æ£€æŸ¥é€‰æ‹©çš„å…ƒç´ æ˜¯å¦åŒ…å«å·¥å…·ç•Œé¢
            if (element.closest('#md-extractor-toolbar') ||
                element.closest('#md-extractor-preview-window') ||
                element.closest('#md-extractor-modal') ||
                element.closest('[id*="md-extractor"]') ||
                element.querySelector('#md-extractor-toolbar') ||
                element.querySelector('#md-extractor-preview-window') ||
                element.querySelector('#md-extractor-modal') ||
                element.querySelector('[id*="md-extractor"]')) {
                showStatus('é€‰æ‹©èŒƒå›´åŒ…å«å·¥å…·ç•Œé¢ï¼Œè¯·é‡æ–°é€‰æ‹©æ›´ç²¾ç¡®çš„å…ƒç´ ', 'error');
                return;
            }

            // ä½¿ç”¨ä¸Markdownæå–ç›¸åŒçš„é€»è¾‘ï¼Œå…ˆæ¸…ç†ä¸å¯è§å…ƒç´ 
            const clonedElement = element.cloneNode(true);

            // ç§»é™¤ä¸å¯è§å’Œåƒåœ¾å…ƒç´ ï¼Œç¡®ä¿ä¸Markdownæå–ä¸€è‡´ï¼Œä½†ä¿æŠ¤è¡¨æ ¼å†…å®¹
            CONFIG.JUNK_SELECTORS.forEach(selector => {
                try {
                    clonedElement.querySelectorAll(selector).forEach(junk => {
                        // å¦‚æœæ˜¯è¡¨æ ¼å†…çš„å†…å®¹ï¼Œè·³è¿‡æ¸…ç†
                        if (junk.closest('table, tbody, tr, td, th, .h-editgird, .h-editgird-wrapper, .multiRowVariableColumn')) {
                            return;
                        }
                        if (junk.parentNode) {
                            junk.parentNode.removeChild(junk);
                        }
                    });
                } catch (e) {
                    console.warn(`[MD Extractor] Invalid selector: ${selector}`, e);
                }
            });

            // æ™ºèƒ½æ¸…ç†onclickå…ƒç´ 
            const onClickElements = clonedElement.querySelectorAll('[onclick]');
            onClickElements.forEach(element => {
                if (shouldRemoveOnClickElement(element)) {
                    if (element.parentNode) {
                        element.parentNode.removeChild(element);
                    }
                }
            });

            // ç§»é™¤å·¥å…·è‡ªèº«çš„UIå…ƒç´ ï¼Œé¿å…å¯¼å‡ºHTMLä¸­åŒ…å«å·¥å…·ç•Œé¢
            console.log('[HTML Export] å¼€å§‹æ¸…ç†å·¥å…·å…ƒç´ ...');
            console.log('[HTML Export] æ¸…ç†å‰HTMLé•¿åº¦:', clonedElement.outerHTML.length);

            const toolSelectors = [
                // ä¼˜å…ˆä½¿ç”¨æ–°çš„æ ‡è®°å±æ€§
                '[data-md-extractor-ui]',
                '[data-exclude-from-export]',
                // ä¼ ç»Ÿçš„å·¥å…·é€‰æ‹©å™¨
                '#md-extractor-toolbar',
                '#md-extractor-overlay',
                '#md-extractor-modal',
                '#manual-copy-dialog',
                '#md-extractor-preview-window',
                '#md-extractor-preview-overlay',
                '.md-extractor-highlight',
                '[id*="md-extractor"]',
                '[class*="md-extractor"]',
                '#md-extractor-styles',
                'style[id="md-extractor-styles"]',
                'div[id*="md-extractor"]',
                '*[data-md-extractor]'
            ];

            let removedCount = 0;
            toolSelectors.forEach(selector => {
                const elements = clonedElement.querySelectorAll(selector);
                console.log(`[HTML Export] é€‰æ‹©å™¨ "${selector}" æ‰¾åˆ° ${elements.length} ä¸ªå…ƒç´ `);
                elements.forEach(toolEl => {
                    if (toolEl.parentNode) {
                        console.log(`[HTML Export] ç§»é™¤å…ƒç´ :`, toolEl.tagName, toolEl.id || '', toolEl.className || '');
                        toolEl.parentNode.removeChild(toolEl);
                        removedCount++;
                    }
                });
            });

            console.log(`[HTML Export] æ€»å…±ç§»é™¤äº† ${removedCount} ä¸ªå·¥å…·å…ƒç´ `);
            console.log('[HTML Export] æ¸…ç†åHTMLé•¿åº¦:', clonedElement.outerHTML.length);

            // å¦‚æœæ¸…ç†åçš„HTMLä»ç„¶å¾ˆå¤§ä¸”åŒ…å«å¯ç–‘å†…å®¹ï¼Œè­¦å‘Šç”¨æˆ·
            const cleanedHtml = clonedElement.outerHTML;
            if (cleanedHtml.length > 50000 ||
                cleanedHtml.includes('copyHtmlContent') ||
                cleanedHtml.includes('downloadHtmlFile') ||
                cleanedHtml.includes('å¯¼å‡ºHTMLå†…å®¹') ||
                cleanedHtml.includes('å¯¼å‡ºçš„HTMLå†…å®¹')) {
                showStatus('è­¦å‘Š: é€‰æ‹©èŒƒå›´å¯èƒ½è¿‡å¤§ï¼Œå»ºè®®é€‰æ‹©æ›´å…·ä½“çš„å…ƒç´ ', 'error');
                console.warn('[HTML Export] æ£€æµ‹åˆ°å¯èƒ½åŒ…å«å·¥å…·ç•Œé¢çš„å¤§èŒƒå›´é€‰æ‹©');
                return;
            }

            // æ¸…ç†æ‰€æœ‰å…ƒç´ ä¸Šçš„å·¥å…·ç›¸å…³ç±»åï¼ŒåŒ…æ‹¬æ ¹å…ƒç´ 
            // å…ˆæ¸…ç†æ ¹å…ƒç´ 
            if (clonedElement.className) {
                clonedElement.className = clonedElement.className
                    .replace(/\bmd-extractor-highlighted\b/g, '')
                    .replace(/\bmd-extractor-hover-highlight\b/g, '')
                    .replace(/\bmd-extractor-[a-zA-Z-]+\b/g, '')
                    .trim();
            }
            // ç„¶åæ¸…ç†æ‰€æœ‰å­å…ƒç´ 
            const allElements = clonedElement.querySelectorAll('*');
            allElements.forEach(el => {
                if (el.className) {
                    el.className = el.className
                        .replace(/\bmd-extractor-highlighted\b/g, '')
                        .replace(/\bmd-extractor-hover-highlight\b/g, '')
                        .replace(/\bmd-extractor-[a-zA-Z-]+\b/g, '')
                        .trim();
                }
                // ç§»é™¤å·¥å…·ç›¸å…³çš„å±æ€§
                if (el.id && el.id.includes('md-extractor')) {
                    el.removeAttribute('id');
                }
            });

            const html = clonedElement.outerHTML;

            if (!html) {
                showStatus('å¯¼å‡ºå†…å®¹ä¸ºç©º', 'error');
                return;
            }

            // ç›´æ¥å¤„ç†HTMLå¯¼å‡ºï¼Œä¸ä½¿ç”¨é¢„è§ˆçª—å£
            console.log('[HTML Export] æ¸…ç†åçš„HTML:', html);

            // æ–¹æ¡ˆ1: ç›´æ¥å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(html).then(function() {
                showStatus(`HTMLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ (${clonedElement.tagName.toLowerCase()}, ${clonedElement.textContent.length}å­—ç¬¦)`, 'success');
                console.log('[HTML Export] HTMLå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(function(err) {
                console.warn('è‡ªåŠ¨å¤åˆ¶å¤±è´¥:', err);
                // æ–¹æ¡ˆ2: é™çº§åˆ°æ‰‹åŠ¨å¤åˆ¶
                const textarea = document.createElement('textarea');
                textarea.value = html;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                const success = document.execCommand('copy');
                document.body.removeChild(textarea);

                if (success) {
                    showStatus(`HTMLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ (${clonedElement.tagName.toLowerCase()}, ${clonedElement.textContent.length}å­—ç¬¦)`, 'success');
                } else {
                    // æ–¹æ¡ˆ3: æä¾›ä¸‹è½½
                    const blob = new Blob([html], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'extracted_content.html';
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showStatus(`HTMLå·²ä¸‹è½½åˆ°æ–‡ä»¶ (${clonedElement.tagName.toLowerCase()}, ${clonedElement.textContent.length}å­—ç¬¦)`, 'success');
                }
            });

        } catch (error) {
            showStatus(`å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            console.error('å¯¼å‡ºHTMLé”™è¯¯:', error);
        }
    }

    function highlightElement(selector) {
        // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
        document.querySelectorAll(`.${CONFIG.HIGHLIGHT_CLASS}`).forEach(el => {
            el.classList.remove(CONFIG.HIGHLIGHT_CLASS);
        });

        if (!selector || !selector.trim()) {
            return;
        }

        try {
            console.log('å°è¯•é«˜äº®é€‰æ‹©å™¨:', selector);
            const elements = document.querySelectorAll(selector);
            console.log('æ‰¾åˆ°å…ƒç´ æ•°é‡:', elements.length);

            if (elements.length === 0) {
                console.warn('é€‰æ‹©å™¨æœªæ‰¾åˆ°ä»»ä½•å…ƒç´ :', selector);
                showStatus('é€‰æ‹©å™¨æ— æ•ˆï¼šæœªæ‰¾åˆ°åŒ¹é…å…ƒç´ ', 'error');
                return;
            }

            if (elements.length > 1) {
                console.warn('é€‰æ‹©å™¨åŒ¹é…äº†å¤šä¸ªå…ƒç´ :', elements.length);
                showStatus(`é€‰æ‹©å™¨åŒ¹é…äº† ${elements.length} ä¸ªå…ƒç´ ï¼Œå°†é«˜äº®ç¬¬ä¸€ä¸ª`, 'info');
            }

            // é«˜äº®ç¬¬ä¸€ä¸ªåŒ¹é…çš„å…ƒç´ 
            const element = elements[0];
            element.classList.add(CONFIG.HIGHLIGHT_CLASS);

            // æ»šåŠ¨åˆ°å…ƒç´ ä½ç½®
            try {
                element.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center',
                    inline: 'nearest'
                });
            } catch (e) {
                console.warn('æ»šåŠ¨åˆ°å…ƒç´ å¤±è´¥:', e);
            }

            console.log('æˆåŠŸé«˜äº®å…ƒç´ :', element);

        } catch (e) {
            console.error('é«˜äº®å…ƒç´ å¤±è´¥:', selector, e);
            showStatus('é€‰æ‹©å™¨è¯­æ³•é”™è¯¯', 'error');
        }

    }

    // æ‰‹åŠ¨æå–å’Œå¤åˆ¶å‡½æ•°
    async function manualExtractAndCopy() {
        const selectorInput = document.getElementById('selector-input');
        if (!selectorInput) {
            showStatus('UIå…ƒç´ æœªæ‰¾åˆ°', 'error');
            return;
        }

        const selector = selectorInput.value.trim();
        if (!selector) {
            showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…ƒç´ ', 'error');
            return;
        }

        try {
            const element = document.querySelector(selector);
            if (!element) {
                showStatus('æœªæ‰¾åˆ°å…ƒç´ ï¼Œè¯·é‡æ–°é€‰æ‹©', 'error');
                return;
            }

            showStatus('æ­£åœ¨æå–å†…å®¹...', 'info');

            const autoExpandCheckbox = document.getElementById('auto-expand');
            if (autoExpandCheckbox && autoExpandCheckbox.checked) {
                await autoExpandContent(element);
            }

            const structuredModeCheckbox = document.getElementById('structured-mode');
            const structuredMode = structuredModeCheckbox ? structuredModeCheckbox.checked : true;

            const content = processExtraction(element, structuredMode);

            if (content && content.trim()) {
                // ç›´æ¥æ˜¾ç¤ºæ‰‹åŠ¨å¤åˆ¶ç•Œé¢
                showManualCopyDialog(content);
                showStatus('è¯·æ‰‹åŠ¨å¤åˆ¶å†…å®¹', 'info');
            } else {
                showStatus('æå–å†…å®¹ä¸ºç©º', 'error');
            }
        } catch (error) {
            showStatus(`æå–å¤±è´¥: ${error.message}`, 'error');
            console.error("æ‰‹åŠ¨æå–é”™è¯¯:", error);
        }
    }

    // iframeåˆ†æåŠŸèƒ½
    async function performIframeAnalysis() {
        showStatus('æ­£åœ¨åˆ†æé¡µé¢ä¸­çš„iframe...', 'info');

        try {
            const analysis = await analyzeAllIframes();
            displayIframeAnalysisResults(analysis);
        } catch (error) {
            showStatus(`iframeåˆ†æå¤±è´¥: ${error.message}`, 'error');
            console.error('iframeåˆ†æé”™è¯¯:', error);
        }
    }

    // åˆ†ææ‰€æœ‰iframe
    async function analyzeAllIframes() {
        const iframes = document.querySelectorAll('iframe');
        const analysis = {
            totalCount: iframes.length,
            accessible: [],
            crossOrigin: [],
            empty: [],
            recommendations: []
        };

        if (iframes.length === 0) {
            analysis.recommendations.push('å½“å‰é¡µé¢æ²¡æœ‰å‘ç°ä»»ä½•iframeå…ƒç´ ');
            return analysis;
        }

        for (let i = 0; i < iframes.length; i++) {
            const iframe = iframes[i];
            const info = await analyzeIframeDetails(iframe, i);

            if (info.accessible) {
                analysis.accessible.push(info);
            } else if (info.crossOrigin) {
                analysis.crossOrigin.push(info);
            } else {
                analysis.empty.push(info);
            }
        }

        // ç”Ÿæˆå»ºè®®
        analysis.recommendations = generateIframeRecommendations(analysis);

        return analysis;
    }

    // åˆ†æå•ä¸ªiframeçš„è¯¦ç»†ä¿¡æ¯
    async function analyzeIframeDetails(iframe, index) {
        const info = {
            index: index,
            id: iframe.id || `iframe-${index}`,
            src: iframe.src || 'about:blank',
            accessible: false,
            crossOrigin: false,
            contentLength: 0,
            hasContent: false,
            dimensions: {
                width: iframe.offsetWidth,
                height: iframe.offsetHeight
            },
            content: null,
            error: null
        };

        try {
            // å°è¯•è®¿é—®iframeå†…å®¹
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (iframeDoc) {
                info.accessible = true;

                // æå–å†…å®¹
                const content = extractContentFromDocument(iframeDoc);
                if (content && content.trim()) {
                    info.hasContent = true;
                    info.contentLength = content.length;
                    info.content = content.substring(0, 500) + (content.length > 500 ? '...' : '');
                }
            }
        } catch (e) {
            // è·¨åŸŸæˆ–å…¶ä»–è®¿é—®é”™è¯¯
            if (e.name === 'SecurityError' || e.message.includes('cross-origin')) {
                info.crossOrigin = true;
                info.error = 'è·¨åŸŸé™åˆ¶';
            } else {
                info.error = e.message;
            }
        }

        return info;
    }

    // ç”Ÿæˆiframeå¤„ç†å»ºè®®
    function generateIframeRecommendations(analysis) {
        const recommendations = [];

        if (analysis.accessible.length > 0) {
            recommendations.push(`âœ… å‘ç°${analysis.accessible.length}ä¸ªå¯ç›´æ¥è®¿é—®çš„iframeï¼Œå¯ä»¥ç›´æ¥æå–å†…å®¹`);
        }

        if (analysis.crossOrigin.length > 0) {
            recommendations.push(`âš ï¸ å‘ç°${analysis.crossOrigin.length}ä¸ªè·¨åŸŸiframeï¼Œéœ€è¦åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å¤„ç†`);
        }

        if (analysis.empty.length > 0) {
            recommendations.push(`â„¹ï¸ å‘ç°${analysis.empty.length}ä¸ªç©ºiframeæˆ–æ— æ³•è®¿é—®çš„iframe`);
        }

        if (analysis.totalCount === 0) {
            recommendations.push('âœ… å½“å‰é¡µé¢æ²¡æœ‰iframeï¼Œå†…å®¹æå–ä¸å—å½±å“');
        }

        return recommendations;
    }

    // æ˜¾ç¤ºiframeåˆ†æç»“æœ
    function displayIframeAnalysisResults(analysis) {
        const content = generateIframeAnalysisReport(analysis);
        openPreviewWindow(content, 'iframeç»“æ„åˆ†ææŠ¥å‘Š');
        showStatus(`iframeåˆ†æå®Œæˆï¼šå…±å‘ç°${analysis.totalCount}ä¸ªiframe`, 'success');
    }

    // ç”Ÿæˆiframeåˆ†ææŠ¥å‘Š
    function generateIframeAnalysisReport(analysis) {
        let report = `=== iframeç»“æ„åˆ†ææŠ¥å‘Š ===\n\n`;
        report += `æ€»è®¡å‘ç°: ${analysis.totalCount} ä¸ªiframe\n`;
        report += `å¯è®¿é—®: ${analysis.accessible.length} ä¸ª\n`;
        report += `è·¨åŸŸé™åˆ¶: ${analysis.crossOrigin.length} ä¸ª\n`;
        report += `å…¶ä»–çŠ¶æ€: ${analysis.empty.length} ä¸ª\n\n`;

        // è¯¦ç»†åˆ†æ
        if (analysis.accessible.length > 0) {
            report += `ğŸ“‹ å¯è®¿é—®çš„iframeè¯¦æƒ…:\n`;
            report += `${'='.repeat(40)}\n`;
            analysis.accessible.forEach((iframe, idx) => {
                report += `${idx + 1}. ID: ${iframe.id}\n`;
                report += `   URL: ${iframe.src}\n`;
                report += `   å°ºå¯¸: ${iframe.dimensions.width}x${iframe.dimensions.height}px\n`;
                report += `   å†…å®¹é•¿åº¦: ${iframe.contentLength} å­—ç¬¦\n`;
                if (iframe.hasContent && iframe.content) {
                    report += `   å†…å®¹é¢„è§ˆ: ${iframe.content.replace(/\n/g, ' ')}\n`;
                }
                report += `   å»ºè®®: å¯ç›´æ¥ä½¿ç”¨é€‰æ‹©å™¨æå–å†…å®¹\n\n`;
            });
        }

        if (analysis.crossOrigin.length > 0) {
            report += `ğŸš« è·¨åŸŸiframeè¯¦æƒ…:\n`;
            report += `${'='.repeat(40)}\n`;
            analysis.crossOrigin.forEach((iframe, idx) => {
                report += `${idx + 1}. ID: ${iframe.id}\n`;
                report += `   URL: ${iframe.src}\n`;
                report += `   å°ºå¯¸: ${iframe.dimensions.width}x${iframe.dimensions.height}px\n`;
                report += `   é”™è¯¯: ${iframe.error}\n`;
                report += `   å»ºè®®: å³é”®ç‚¹å‡»iframeé€‰æ‹©"åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€"ï¼Œç„¶ååœ¨æ–°é¡µé¢ä½¿ç”¨æå–å·¥å…·\n\n`;
            });
        }

        if (analysis.empty.length > 0) {
            report += `â“ å…¶ä»–çŠ¶æ€iframeè¯¦æƒ…:\n`;
            report += `${'='.repeat(40)}\n`;
            analysis.empty.forEach((iframe, idx) => {
                report += `${idx + 1}. ID: ${iframe.id}\n`;
                report += `   URL: ${iframe.src}\n`;
                report += `   å°ºå¯¸: ${iframe.dimensions.width}x${iframe.dimensions.height}px\n`;
                if (iframe.error) {
                    report += `   é”™è¯¯: ${iframe.error}\n`;
                }
                report += `   çŠ¶æ€: ç©ºiframeæˆ–æ— æ³•è®¿é—®\n\n`;
            });
        }

        // å¤„ç†å»ºè®®
        report += `ğŸ’¡ å¤„ç†å»ºè®®:\n`;
        report += `${'='.repeat(40)}\n`;
        analysis.recommendations.forEach(rec => {
            report += `â€¢ ${rec}\n`;
        });

        report += `\n=== æŠ¥å‘Šç»“æŸ ===\n`;
        return report;
    }

    // æ‰¹é‡iframeå†…å®¹æå–åŠŸèƒ½
    async function performBatchIframeExtraction() {
        showStatus('å¼€å§‹æ‰¹é‡æå–iframeå†…å®¹...', 'info');

        try {
            const results = await batchExtractIframeContents();
            displayBatchExtractionResults(results);
        } catch (error) {
            showStatus(`æ‰¹é‡æå–å¤±è´¥: ${error.message}`, 'error');
            console.error('æ‰¹é‡iframeæå–é”™è¯¯:', error);
        }
    }

    // æ‰¹é‡æå–æ‰€æœ‰å¯è®¿é—®iframeçš„å†…å®¹
    async function batchExtractIframeContents() {
        const iframes = document.querySelectorAll('iframe');
        const results = {
            totalCount: iframes.length,
            successful: [],
            failed: [],
            crossOrigin: [],
            empty: []
        };

        if (iframes.length === 0) {
            throw new Error('å½“å‰é¡µé¢æ²¡æœ‰å‘ç°ä»»ä½•iframe');
        }

        showStatus(`æ­£åœ¨å¤„ç†${iframes.length}ä¸ªiframe...`, 'info');

        for (let i = 0; i < iframes.length; i++) {
            const iframe = iframes[i];
            const iframeId = iframe.id || `iframe-${i}`;

            try {
                showStatus(`æ­£åœ¨å¤„ç†iframe ${i + 1}/${iframes.length}: ${iframeId}`, 'info');

                const content = await extractSingleIframeContent(iframe, iframeId);

                if (content && content.trim()) {
                    results.successful.push({
                        id: iframeId,
                        src: iframe.src || 'about:blank',
                        content: content,
                        contentLength: content.length
                    });
                } else {
                    results.empty.push({
                        id: iframeId,
                        src: iframe.src || 'about:blank',
                        reason: 'å†…å®¹ä¸ºç©º'
                    });
                }
            } catch (error) {
                if (error.message.includes('è·¨åŸŸ') || error.message.includes('cross-origin')) {
                    results.crossOrigin.push({
                        id: iframeId,
                        src: iframe.src || 'about:blank',
                        error: error.message
                    });
                } else {
                    results.failed.push({
                        id: iframeId,
                        src: iframe.src || 'about:blank',
                        error: error.message
                    });
                }
            }
        }

        return results;
    }

    // æå–å•ä¸ªiframeçš„å†…å®¹
    async function extractSingleIframeContent(iframe, iframeId) {
        return new Promise((resolve, reject) => {
            try {
                // æ–¹æ³•1: ç›´æ¥è®¿é—®åŒæºiframe
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (iframeDoc) {
                    const content = extractContentFromDocument(iframeDoc);
                    resolve(content);
                    return;
                }
            } catch (e) {
                // è·¨åŸŸé™åˆ¶ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
            }

            // æ–¹æ³•2: æ¶ˆæ¯é€šä¿¡
            let messageReceived = false;
            const timeout = setTimeout(() => {
                if (!messageReceived) {
                    reject(new Error('è·¨åŸŸé™åˆ¶æˆ–æ— æ³•è®¿é—®'));
                }
            }, 2000);

            const messageHandler = (event) => {
                if (event.data.type === 'iframeContent' && event.data.iframeId === iframeId) {
                    messageReceived = true;
                    clearTimeout(timeout);
                    window.removeEventListener('message', messageHandler);

                    if (event.data.content) {
                        resolve(event.data.content);
                    } else {
                        reject(new Error(event.data.error || 'æ— æ³•è·å–å†…å®¹'));
                    }
                }
            };

            window.addEventListener('message', messageHandler);

            try {
                iframe.contentWindow.postMessage({
                    type: 'requestContent',
                    iframeId: iframeId
                }, '*');
            } catch (e) {
                clearTimeout(timeout);
                window.removeEventListener('message', messageHandler);
                reject(new Error('è·¨åŸŸé™åˆ¶'));
            }
        });
    }

    // æ˜¾ç¤ºæ‰¹é‡æå–ç»“æœ
    function displayBatchExtractionResults(results) {
        const report = generateBatchExtractionReport(results);

        // å¦‚æœæœ‰æˆåŠŸæå–çš„å†…å®¹ï¼Œåˆå¹¶æ˜¾ç¤º
        if (results.successful.length > 0) {
            const combinedContent = results.successful.map((item, index) => {
                return `=== iframe ${index + 1}: ${item.id} ===\næ¥æº: ${item.src}\né•¿åº¦: ${item.contentLength} å­—ç¬¦\n\n${item.content}\n\n`;
            }).join('\n');

            openPreviewWindow(combinedContent, `æ‰¹é‡iframeå†…å®¹ (${results.successful.length}ä¸ª)`);
        }

        // æ˜¾ç¤ºè¯¦ç»†æŠ¥å‘Š
        setTimeout(() => {
            openPreviewWindow(report, 'æ‰¹é‡iframeæå–æŠ¥å‘Š');
        }, 500);

        showStatus(`æ‰¹é‡æå–å®Œæˆï¼šæˆåŠŸ${results.successful.length}ä¸ªï¼Œå¤±è´¥${results.failed.length + results.crossOrigin.length}ä¸ª`, 'success');
    }

    // ç”Ÿæˆæ‰¹é‡æå–æŠ¥å‘Š
    function generateBatchExtractionReport(results) {
        let report = `=== æ‰¹é‡iframeå†…å®¹æå–æŠ¥å‘Š ===\n\n`;
        report += `æ€»è®¡å¤„ç†: ${results.totalCount} ä¸ªiframe\n`;
        report += `æˆåŠŸæå–: ${results.successful.length} ä¸ª\n`;
        report += `è·¨åŸŸé™åˆ¶: ${results.crossOrigin.length} ä¸ª\n`;
        report += `æå–å¤±è´¥: ${results.failed.length} ä¸ª\n`;
        report += `å†…å®¹ä¸ºç©º: ${results.empty.length} ä¸ª\n\n`;

        if (results.successful.length > 0) {
            report += `âœ… æˆåŠŸæå–çš„iframe:\n`;
            report += `${'='.repeat(40)}\n`;
            results.successful.forEach((item, index) => {
                report += `${index + 1}. ID: ${item.id}\n`;
                report += `   URL: ${item.src}\n`;
                report += `   å†…å®¹é•¿åº¦: ${item.contentLength} å­—ç¬¦\n`;
                report += `   çŠ¶æ€: âœ… æå–æˆåŠŸ\n\n`;
            });
        }

        if (results.crossOrigin.length > 0) {
            report += `ğŸš« è·¨åŸŸé™åˆ¶çš„iframe:\n`;
            report += `${'='.repeat(40)}\n`;
            results.crossOrigin.forEach((item, index) => {
                report += `${index + 1}. ID: ${item.id}\n`;
                report += `   URL: ${item.src}\n`;
                report += `   é”™è¯¯: ${item.error}\n`;
                report += `   å»ºè®®: åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å¤„ç†\n\n`;
            });
        }

        if (results.failed.length > 0) {
            report += `âŒ æå–å¤±è´¥çš„iframe:\n`;
            report += `${'='.repeat(40)}\n`;
            results.failed.forEach((item, index) => {
                report += `${index + 1}. ID: ${item.id}\n`;
                report += `   URL: ${item.src}\n`;
                report += `   é”™è¯¯: ${item.error}\n\n`;
            });
        }

        if (results.empty.length > 0) {
            report += `ğŸ“„ å†…å®¹ä¸ºç©ºçš„iframe:\n`;
            report += `${'='.repeat(40)}\n`;
            results.empty.forEach((item, index) => {
                report += `${index + 1}. ID: ${item.id}\n`;
                report += `   URL: ${item.src}\n`;
                report += `   åŸå› : ${item.reason}\n\n`;
            });
        }

        report += `\n=== æŠ¥å‘Šç»“æŸ ===\n`;
        return report;
    }

    function showStatus(message, type = 'info') {
        const statusEl = document.getElementById('status');
        if (!statusEl) return;

        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (statusTimeout) {
            clearTimeout(statusTimeout);
        }

        statusEl.textContent = message;
        statusEl.className = `status ${type}`;

        // 5ç§’åæ¸…é™¤çŠ¶æ€
        statusTimeout = setTimeout(() => {
            statusEl.textContent = '';
            statusEl.className = 'status';
        }, 5000);

        console.log(`[MDæå–å™¨] ${type.toUpperCase()}: ${message}`);
    }

    function makeDraggable() {
        const toolbar = document.getElementById(CONFIG.TOOLBAR_ID);
        const header = toolbar ? toolbar.querySelector('.toolbar-header') : null;

        if (!toolbar || !header) return;

        let isDragging = false;
        let offsetX = 0;
        let offsetY = 0;

        function handleMouseDown(e) {
            e.preventDefault();
            isDragging = true;

            const rect = toolbar.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);

            // æ·»åŠ æ‹–æ‹½æ ·å¼
            toolbar.style.cursor = 'grabbing';
            header.style.cursor = 'grabbing';
        }

        function handleMouseMove(e) {
            if (!isDragging) return;

            e.preventDefault();

            let newX = e.clientX - offsetX;
            let newY = e.clientY - offsetY;

            // é™åˆ¶åœ¨è§†çª—èŒƒå›´å†…
            const maxX = window.innerWidth - toolbar.offsetWidth;
            const maxY = window.innerHeight - toolbar.offsetHeight;

            newX = Math.max(0, Math.min(newX, maxX));
            newY = Math.max(0, Math.min(newY, maxY));

            toolbar.style.left = `${newX}px`;
            toolbar.style.top = `${newY}px`;
            toolbar.style.right = 'auto'; // ç§»é™¤rightå®šä½
        }

        function handleMouseUp() {
            isDragging = false;

            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);

            // æ¢å¤æ ·å¼
            toolbar.style.cursor = '';
            header.style.cursor = 'move';
        }

        header.addEventListener('mousedown', handleMouseDown);
    }

    // =================================================================================
    // --- æ¸…ç†å‡½æ•° (Cleanup) ---
    // =================================================================================
    function cleanup() {
        if (isPickingMode) {
            exitPickingMode();
        }

        if (statusTimeout) {
            clearTimeout(statusTimeout);
        }

        // ç§»é™¤é«˜äº®æ ·å¼
        document.querySelectorAll(`.${CONFIG.HIGHLIGHT_CLASS}`).forEach(el => {
            el.classList.remove(CONFIG.HIGHLIGHT_CLASS);
        });

        document.querySelectorAll(`.${CONFIG.HOVER_HIGHLIGHT_CLASS}`).forEach(el => {
            el.classList.remove(CONFIG.HOVER_HIGHLIGHT_CLASS);
        });
    }

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', cleanup);

    // =================================================================================
    // --- Iframe é€šä¿¡å¤„ç† (Iframe Communication) ---
    // =================================================================================

    function handleFrameMessage(event) {
        if (!isTopWindow) return;

        const { type, selector, message, iframeId, content, error } = event.data;

        switch (type) {
            case 'ping':
                // å“åº”åµŒå¥—çª—å£çš„pingæ¶ˆæ¯
                try {
                    event.source.postMessage({ type: 'pong' }, '*');
                    console.log('[MD Extractor] å“åº”åµŒå¥—çª—å£ping');
                } catch (e) {
                    console.warn('[MD Extractor] æ— æ³•å“åº”åµŒå¥—çª—å£ping:', e);
                }
                break;
            case 'elementSelected':
                console.log('æ”¶åˆ°æ¥è‡ª iframe çš„é€‰æ‹©å™¨:', selector);

                // éªŒè¯iframeæ˜¯å¦å­˜åœ¨
                let iframeEl = null;
                if (iframeId) {
                    iframeEl = document.getElementById(iframeId);
                    if (!iframeEl) {
                        console.warn(`iframe#${iframeId} ä¸å­˜åœ¨ï¼Œå°è¯•æŸ¥æ‰¾æ›¿ä»£iframe`);
                        // å°è¯•é€šè¿‡å…¶ä»–æ–¹å¼æ‰¾åˆ°iframe
                        const iframes = document.querySelectorAll('iframe');
                        for (let iframe of iframes) {
                            try {
                                if (iframe.contentWindow === event.source) {
                                    iframeEl = iframe;
                                    if (!iframe.id) {
                                        iframe.id = iframeId; // è®¾ç½®ç¼ºå¤±çš„ID
                                    }
                                    console.log('é€šè¿‡äº‹ä»¶æºæ‰¾åˆ°åŒ¹é…çš„iframe:', iframe.id);
                                    break;
                                }
                            } catch (e) {
                                // è·¨åŸŸé™åˆ¶ï¼Œæ— æ³•è®¿é—®contentWindow
                                continue;
                            }
                        }
                    }
                }

                selectionContext = { source: 'iframe', selector: selector, iframeId: iframeId };
                const selectorInput = document.getElementById('selector-input');
                if (selectorInput) {
                    selectorInput.value = selector;

                    // åªæœ‰å½“iframeç¡®å®å­˜åœ¨æ—¶æ‰å°è¯•é«˜äº®
                    if (iframeEl) {
                        const iframeSelector = `iframe#${CSS.escape(iframeId)}`;
                        highlightElement(iframeSelector);
                    } else {
                        console.warn('æ— æ³•é«˜äº®iframeï¼Œä½†é€‰æ‹©å™¨å·²è®¾ç½®');
                    }
                }
                showStatus('å·²ä» iframe ä¸­é€‰æ‹©å…ƒç´ ï¼', 'success');
                exitPickingMode();
                break;
            case 'selectorError':
                showStatus(message, 'error');
                exitPickingMode();
                break;
            case 'extractionResult':
                 (async () => {
                    if (error) {
                        showStatus(error, 'error');
                        return;
                    }
                    if (content && content.trim()) {
                        console.log('å†…å®¹æå–æˆåŠŸï¼Œé•¿åº¦:', content.length);
                        const copySuccess = await copyToClipboard(content);
                        if (!copySuccess) {
                            showManualCopyDialog(content);
                            showStatus('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'info');
                        }
                    } else {
                        showStatus('ä»iframeæå–å†…å®¹ä¸ºç©º', 'error');
                    }
                })();
                break;
            case 'previewResult':
                console.log('Top window received previewResult from iframe.');
                if (error) {
                    showStatus(error, 'error');
                    return;
                }
                if (content && content.trim()) {
                    openPreviewWindow(content);
                    showStatus('é¢„è§ˆå·²ç”Ÿæˆ', 'success');
                } else {
                    showStatus('ä»iframeé¢„è§ˆå†…å®¹ä¸ºç©º', 'error');
                }
                break;
            case 'diagnosticResult':
                console.log('Top window received diagnosticResult from iframe.');
                if (error) {
                    showStatus(error, 'error');
                    return;
                }
                if (content) {
                    openPreviewWindow(content, 'DOM éå†è¯Šæ–­æŠ¥å‘Š (æ¥è‡ª iframe)');
                    showStatus('è¯Šæ–­æŠ¥å‘Šå·²ç”Ÿæˆ', 'success');
                }
                break;
            case 'htmlDumpResult':
                console.log('Top window received htmlDumpResult from iframe.');
                if (error) {
                    showStatus(error, 'error');
                    return;
                }
                if (content) {
                    // è·å–åŸå§‹å…ƒç´ ä¿¡æ¯ï¼ˆä»iframeæ¥çš„å†…å®¹éœ€è¦è§£æï¼‰
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const originalElement = tempDiv.firstElementChild;

                    // ç›´æ¥å¤„ç†HTMLå¯¼å‡ºï¼Œä¸ä½¿ç”¨é¢„è§ˆçª—å£
                    console.log('[HTML Export] iframeæ¸…ç†åçš„HTML:', content);

                    // ç›´æ¥å¤åˆ¶åˆ°å‰ªè´´æ¿
                    navigator.clipboard.writeText(content).then(function() {
                        showStatus(`HTMLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ (æ¥è‡ªiframe: ${originalElement ? originalElement.tagName.toLowerCase() : 'unknown'}, ${originalElement ? originalElement.textContent.length : 0}å­—ç¬¦)`, 'success');
                    }).catch(function(err) {
                        console.warn('è‡ªåŠ¨å¤åˆ¶å¤±è´¥:', err);
                        // é™çº§æ–¹æ¡ˆ
                        const blob = new Blob([content], { type: 'text/html' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'extracted_content_iframe.html';
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        showStatus(`HTMLå·²ä¸‹è½½åˆ°æ–‡ä»¶ (æ¥è‡ªiframe: ${originalElement ? originalElement.tagName.toLowerCase() : 'unknown'}, ${originalElement ? originalElement.textContent.length : 0}å­—ç¬¦)`, 'success');
                    });
                }
                break;
            case 'htmlExportResult':
                // å¤„ç†æ–°çš„HTMLå¯¼å‡ºç»“æœ
                if (event.data.content) {
                    const { content, elementInfo } = event.data;
                    navigator.clipboard.writeText(content).then(function() {
                        showStatus(`HTMLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ (æ¥è‡ªiframe: ${elementInfo.tagName}, ${elementInfo.textLength}å­—ç¬¦)`, 'success');
                    }).catch(function(err) {
                        console.warn('è‡ªåŠ¨å¤åˆ¶å¤±è´¥:', err);
                        const blob = new Blob([content], { type: 'text/html' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'extracted_content_iframe.html';
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        showStatus(`HTMLå·²ä¸‹è½½åˆ°æ–‡ä»¶ (æ¥è‡ªiframe: ${elementInfo.tagName}, ${elementInfo.textLength}å­—ç¬¦)`, 'success');
                    });
                }
                break;
            case 'connectionTest':
                // å“åº”iframeçš„è¿æ¥æµ‹è¯•ï¼Œç¡®è®¤é€šä¿¡æ­£å¸¸
                console.log('[MD Extractor] æ”¶åˆ°iframeè¿æ¥æµ‹è¯•æ¶ˆæ¯');
                break;
        }
    }

    function handleMasterMessage(event) {
        if (isTopWindow) return;

        const { type, selector, autoExpand, structuredMode } = event.data;

        switch (type) {
            case 'enterPickingMode':
                debugLog('iframe æ”¶åˆ°æŒ‡ä»¤: enterPickingModeï¼Œå¼€å§‹è¿›å…¥é€‰æ‹©æ¨¡å¼');
                enterPickingMode();

                // çº§è”ä¼ é€’ï¼šé€šçŸ¥å­iframe
                const childIframes = document.querySelectorAll('iframe');
                if (childIframes.length > 0) {
                    debugLog(`iframeå‘ç°${childIframes.length}ä¸ªå­iframeï¼Œçº§è”ä¼ é€’é€‰æ‹©æ¨¡å¼`);
                    childIframes.forEach((iframe, index) => {
                        try {
                            iframe.contentWindow.postMessage({ type: 'enterPickingMode' }, '*');
                            debugLog(`âœ… å­iframe-${index} å·²é€šçŸ¥`);
                        } catch (e) {
                            debugLog(`âŒ å­iframe-${index} é€šçŸ¥å¤±è´¥:`, e.message);
                        }
                    });
                }
                break;
            case 'requestContent':
                debugLog('iframeæ”¶åˆ°å†…å®¹è¯·æ±‚:', event.data.iframeId);
                handleContentRequest(event);
                break;
            case 'exitPickingMode':
                 console.log('iframe æ”¶åˆ°æŒ‡ä»¤: exitPickingMode');
                exitPickingMode();

                // çº§è”ä¼ é€’ï¼šé€šçŸ¥å­iframe
                document.querySelectorAll('iframe').forEach(iframe => {
                    try {
                        iframe.contentWindow.postMessage({ type: 'exitPickingMode' }, '*');
                    } catch (e) {
                        console.warn('iframeçº§è”ä¼ é€’æ¶ˆæ¯å¤±è´¥:', e);
                    }
                });
                break;
            case 'doExtract':
                console.log('Iframe received doExtract for selector:', selector);
                (async () => {
                    try {
                        const element = document.querySelector(selector);
                        if (!element) {
                            window.top.postMessage({ type: 'extractionResult', error: 'Iframe é”™è¯¯: æœªæ‰¾åˆ°å…ƒç´ ' }, '*');
                            return;
                        }
                        if (autoExpand) {
                            await autoExpandContent(element);
                        }
                        console.log('Iframe starting extraction process...');
                        const content = processExtraction(element, structuredMode);
                        console.log('Iframe finished extraction, content length:', (content || '').length);
                        console.log('Iframe sending extractionResult to top window.');
                        window.top.postMessage({ type: 'extractionResult', content: content, error: null }, '*');
                    } catch (e) {
                        window.top.postMessage({ type: 'extractionResult', content: null, error: 'Iframe é”™è¯¯: ' + e.message }, '*');
                    }
                })();
                break;
            case 'doPreview':
                console.log('Iframe received doPreview for selector:', selector);
                 (async () => {
                    try {
                        const element = document.querySelector(selector);
                        if (!element) {
                            window.top.postMessage({ type: 'previewResult', error: 'Iframe é”™è¯¯: æœªæ‰¾åˆ°å…ƒç´ ' }, '*');
                            return;
                        }
                        if (autoExpand) {
                            await autoExpandContent(element);
                        }
                        const content = processExtraction(element, structuredMode);
                        window.top.postMessage({ type: 'previewResult', content: content, error: null }, '*');
                    } catch (e) {
                        window.top.postMessage({ type: 'previewResult', content: null, error: 'Iframe é”™è¯¯: ' + e.message }, '*');
                    }
                })();
                break;
            case 'doExportHtml':
                console.log('Iframe received doExportHtml for selector:', selector);
                 (() => {
                    try {
                        const element = document.querySelector(selector);
                        if (!element) {
                            window.top.postMessage({ type: 'htmlDumpResult', error: 'Iframe é”™è¯¯: æœªæ‰¾åˆ°å…ƒç´ ' }, '*');
                            return;
                        }

                        // å…‹éš†å…ƒç´ è¿›è¡Œæ¸…ç†ï¼Œé¿å…ä¿®æ”¹åŸå§‹DOM
                        const clonedElement = element.cloneNode(true);

                        // åº”ç”¨ä¸ä¸»é¡µé¢ç›¸åŒçš„æ¸…ç†é€»è¾‘
                        // ç§»é™¤åƒåœ¾å…ƒç´ ï¼Œä½†ä¿æŠ¤è¡¨æ ¼å†…å®¹
                        CONFIG.JUNK_SELECTORS.forEach(selector => {
                            try {
                                clonedElement.querySelectorAll(selector).forEach(junk => {
                                    // å¦‚æœæ˜¯è¡¨æ ¼å†…çš„å†…å®¹ï¼Œè·³è¿‡æ¸…ç†
                                    if (junk.closest('table, tbody, tr, td, th, .h-editgird, .h-editgird-wrapper, .multiRowVariableColumn')) {
                                        return;
                                    }
                                    if (junk.parentNode) {
                                        junk.parentNode.removeChild(junk);
                                    }
                                });
                            } catch (e) {
                                console.warn(`[MD Extractor] Invalid selector: ${selector}`, e);
                            }
                        });

                        // æ™ºèƒ½æ¸…ç†onclickå…ƒç´ 
                        const onClickElements = clonedElement.querySelectorAll('[onclick]');
                        onClickElements.forEach(element => {
                            if (shouldRemoveOnClickElement(element)) {
                                if (element.parentNode) {
                                    element.parentNode.removeChild(element);
                                }
                            }
                        });

                        // ç§»é™¤å·¥å…·è‡ªèº«çš„UIå…ƒç´ 
                        const toolElements = clonedElement.querySelectorAll('#md-extractor-toolbar, #md-extractor-overlay, #md-extractor-modal, #manual-copy-dialog, #md-extractor-preview-window, #md-extractor-preview-overlay, .md-extractor-highlight, [id*="md-extractor"], [class*="md-extractor"], #md-extractor-styles');
                        toolElements.forEach(toolEl => {
                            if (toolEl.parentNode) {
                                toolEl.parentNode.removeChild(toolEl);
                            }
                        });

                        // æ¸…ç†æ‰€æœ‰å…ƒç´ ä¸Šçš„å·¥å…·ç›¸å…³ç±»åï¼ŒåŒ…æ‹¬æ ¹å…ƒç´ 
                        // å…ˆæ¸…ç†æ ¹å…ƒç´ 
                        if (clonedElement.className) {
                            clonedElement.className = clonedElement.className
                                .replace(/\bmd-extractor-highlighted\b/g, '')
                                .replace(/\bmd-extractor-hover-highlight\b/g, '')
                                .replace(/\bmd-extractor-[a-zA-Z-]+\b/g, '')
                                .trim();
                        }
                        // ç„¶åæ¸…ç†æ‰€æœ‰å­å…ƒç´ 
                        const allElements = clonedElement.querySelectorAll('*');
                        allElements.forEach(el => {
                            if (el.className) {
                                el.className = el.className
                                    .replace(/\bmd-extractor-highlighted\b/g, '')
                                    .replace(/\bmd-extractor-hover-highlight\b/g, '')
                                    .replace(/\bmd-extractor-[a-zA-Z-]+\b/g, '')
                                    .trim();
                            }
                            // ç§»é™¤å·¥å…·ç›¸å…³çš„å±æ€§
                            if (el.id && el.id.includes('md-extractor')) {
                                el.removeAttribute('id');
                            }
                        });

                        const html = clonedElement.outerHTML;
                        console.log('Iframe finished HTML export, content length:', (html || '').length);
                        window.top.postMessage({ type: 'htmlDumpResult', content: html, error: null }, '*');
                    } catch (e) {
                        window.top.postMessage({ type: 'htmlDumpResult', content: null, error: 'Iframe é”™è¯¯: ' + e.message }, '*');
                    }
                })();
                break;
            case 'doDiagnose':
                console.log('Iframe received doDiagnose for selector:', selector);
                try {
                    const element = document.querySelector(selector);
                    if (!element) {
                        window.top.postMessage({ type: 'diagnosticResult', error: 'Iframe é”™è¯¯: æœªæ‰¾åˆ°å…ƒç´ ' }, '*');
                        return;
                    }
                    const report = generateDiagnosticReport(element);
                    window.top.postMessage({ type: 'diagnosticResult', content: report, error: null }, '*');
                } catch (e) {
                    window.top.postMessage({ type: 'diagnosticResult', content: null, error: 'Iframe é”™è¯¯: ' + e.message }, '*');
                }
                break;
            case 'doHtmlDump':
                console.log('Iframe received doHtmlDump for selector:', selector);
                try {
                    const element = document.querySelector(selector);
                    if (!element) {
                        window.top.postMessage({ type: 'htmlDumpResult', error: 'Iframe é”™è¯¯: æœªæ‰¾åˆ°å…ƒç´ ' }, '*');
                        return;
                    }
                    const html = element.outerHTML;
                    const escapedHtml = html.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    window.top.postMessage({ type: 'htmlDumpResult', content: `<pre>${escapedHtml}</pre>`, error: null }, '*');
                } catch (e) {
                    window.top.postMessage({ type: 'htmlDumpResult', content: null, error: 'Iframe é”™è¯¯: ' + e.message }, '*');
                }
                break;
        }
    }

    // =================================================================================
    // --- è¯Šæ–­åŠŸèƒ½ (Diagnostics) ---
    // =================================================================================
    function generateDiagnosticReport(rootElement) {
        let report = '--- DOM éå†è¯Šæ–­æŠ¥å‘Š ---\n\n';
        report += `æ ¹å…ƒç´ é€‰æ‹©å™¨: ${generateUniqueSelector(rootElement)}\n`;
        report += `æ ¹å…ƒç´ æ ‡ç­¾: <${rootElement.tagName.toLowerCase()}>\n`;
        report += '---------------------------\n\n';
        let nodeCount = 0;

        function traverse(node, indent = '', depth = 0) {
            if (!node || depth > 20) return; // é™åˆ¶é€’å½’æ·±åº¦
            nodeCount++;

            const nodeType = node.nodeType;
            const tagName = node.tagName ? node.tagName.toLowerCase() : '';

            if (nodeType === (Node.TEXT_NODE || 3)) {
                const text = (node.textContent || '').trim();
                if (text) {
                    report += `${indent}- [æ–‡æœ¬] "${text}"\n`;
                }
                return;
            }

            if (nodeType !== Node.ELEMENT_NODE) {
                report += `${indent}- [éå…ƒç´ èŠ‚ç‚¹] Type: ${nodeType}\n`;
                return;
            }

            const visible = isVisible(node);
            report += `${indent}- <${tagName}> | å¯è§: ${visible ? 'âœ…' : 'âŒ'}\n`;

            if (visible) {
                Array.from(node.childNodes).forEach(child => traverse(child, indent + '  ', depth + 1));
            } else {
                const style = window.getComputedStyle(node);
                report += `${indent}  - [éšè—åŸå› ] display: ${style.display}, visibility: ${style.visibility}, opacity: ${style.opacity}\n`;
                const rect = node.getBoundingClientRect();
                report += `${indent}  - [éšè—åŸå› ] å°ºå¯¸: ${rect.width}x${rect.height}\n`;
            }
        }

        traverse(rootElement);
        report += `\n--- æŠ¥å‘Šç»“æŸ (å…±å¤„ç† ${nodeCount} ä¸ªèŠ‚ç‚¹) ---\n`;
        return report;
    }


    function openPreviewWindow(content, title = 'Markdown é¢„è§ˆ') {
        const previewId = 'md-extractor-preview-window';
        const overlayId = 'md-extractor-preview-overlay';

        // åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§é¢„è§ˆçª—å£
        let existingOverlay = document.getElementById(overlayId);
        if (existingOverlay) {
            existingOverlay.remove();
        }

        // åˆ›å»ºé®ç½©å±‚
        const overlay = document.createElement('div');
        overlay.id = overlayId;
        overlay.setAttribute('data-md-extractor-ui', 'true');
        overlay.setAttribute('data-exclude-from-export', 'true');
        overlay.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.5) !important;
            z-index: 9999998 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        `;

        // åˆ›å»ºé¢„è§ˆçª—å£
        const previewWindow = document.createElement('div');
        previewWindow.id = previewId;
        previewWindow.setAttribute('data-md-extractor-ui', 'true');
        previewWindow.setAttribute('data-exclude-from-export', 'true');
        previewWindow.style.cssText = `
            width: 80vw;
            height: 80vh;
            max-width: 1000px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 9999999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        `;

        previewWindow.innerHTML = `
            <div class="preview-header" style="background: #007bff; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; cursor: move;">
                <h3 style="margin: 0; font-size: 16px;">${title}</h3>
                <button class="close-preview" style="background: none; border: none; font-size: 24px; cursor: pointer; color: white; padding:0; line-height: 1;">&times;</button>
            </div>
            <div class="preview-content" style="padding: 20px; overflow: auto; flex-grow: 1; font-size: 14px; line-height: 1.6;">
                <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: 'SF Mono', 'Courier New', monospace; font-size: 13px; margin: 0;">${content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
            </div>
            <div class="preview-footer" style="background: #f7f7f7; padding: 15px 20px; border-top: 1px solid #e5e5e5; display: flex; justify-content: space-between; align-items: center;">
                <div style="color: #666; font-size: 12px;">
                    ${content.length} å­—ç¬¦, ${content.split('\n').length} è¡Œ
                </div>
                <div>
                    <button class="select-all-preview-btn" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 14px;">å…¨é€‰</button>
                    <button class="copy-preview-btn" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 14px;">å¤åˆ¶</button>
                    <button class="close-preview-btn" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 14px;">å…³é—­</button>
                </div>
            </div>
        `;

        overlay.appendChild(previewWindow);
        document.body.appendChild(overlay);

        // ç»‘å®šäº‹ä»¶
        const close = () => {
            if (document.body.contains(overlay)) {
                document.body.removeChild(overlay);
            }
        };

        const closeBtn = previewWindow.querySelector('.close-preview');
        const closeBtnBottom = previewWindow.querySelector('.close-preview-btn');
        const selectAllBtn = previewWindow.querySelector('.select-all-preview-btn');
        const copyBtn = previewWindow.querySelector('.copy-preview-btn');
        const preContent = previewWindow.querySelector('pre');

        closeBtn.addEventListener('click', close);
        closeBtnBottom.addEventListener('click', close);

        // å…¨é€‰åŠŸèƒ½
        selectAllBtn.addEventListener('click', () => {
            const range = document.createRange();
            range.selectNodeContents(preContent);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        });

        // å¤åˆ¶åŠŸèƒ½
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(content);
                copyBtn.textContent = 'å·²å¤åˆ¶!';
                copyBtn.style.background = '#28a745';
                setTimeout(() => {
                    copyBtn.textContent = 'å¤åˆ¶';
                    copyBtn.style.background = '#28a745';
                }, 2000);
            } catch (err) {
                console.warn('å¤åˆ¶å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•');
                // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = content;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                copyBtn.textContent = 'å·²å¤åˆ¶!';
                setTimeout(() => {
                    copyBtn.textContent = 'å¤åˆ¶';
                }, 2000);
            }
        });

        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                close();
            }
        });

        // ESCé”®å…³é—­
        const handleKeydown = (e) => {
            if (e.key === 'Escape') {
                close();
                document.removeEventListener('keydown', handleKeydown);
            }
        };
        document.addEventListener('keydown', handleKeydown);

        // æ‹–æ‹½åŠŸèƒ½
        const header = previewWindow.querySelector('.preview-header');
        let isDragging = false;
        let offsetX, offsetY;

        header.addEventListener('mousedown', (e) => {
            isDragging = true;
            const rect = previewWindow.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            header.style.userSelect = 'none';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const newX = e.clientX - offsetX;
                const newY = e.clientY - offsetY;

                // é™åˆ¶åœ¨è§†çª—èŒƒå›´å†…
                const maxX = window.innerWidth - previewWindow.offsetWidth;
                const maxY = window.innerHeight - previewWindow.offsetHeight;

                const constrainedX = Math.max(0, Math.min(newX, maxX));
                const constrainedY = Math.max(0, Math.min(newY, maxY));

                previewWindow.style.position = 'fixed';
                previewWindow.style.left = `${constrainedX}px`;
                previewWindow.style.top = `${constrainedY}px`;
                previewWindow.style.transform = 'none';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            header.style.userSelect = '';
        });

        // æ·»åŠ æŒ‰é’®æ‚¬åœæ•ˆæœ
        const buttons = previewWindow.querySelectorAll('button');
        buttons.forEach(button => {
            button.addEventListener('mouseenter', () => {
                if (button.classList.contains('select-all-preview-btn')) {
                    button.style.background = '#0056b3';
                } else if (button.classList.contains('copy-preview-btn')) {
                    button.style.background = '#218838';
                } else if (button.classList.contains('close-preview-btn')) {
                    button.style.background = '#5a6268';
                }
            });

            button.addEventListener('mouseleave', () => {
                if (button.classList.contains('select-all-preview-btn')) {
                    button.style.background = '#007bff';
                } else if (button.classList.contains('copy-preview-btn')) {
                    button.style.background = '#28a745';
                } else if (button.classList.contains('close-preview-btn')) {
                    button.style.background = '#6c757d';
                }
            });
        });
    }


    function isVisible(el) {
        if (!(el instanceof Element)) {
            return true; // Text nodes, etc., are considered "visible" by default.
        }

        // For data extraction, we should be more lenient. We only care if an element is truly removed from the layout.
        // We walk up the tree to check for `display: none`.
        // We ignore `visibility`, `opacity`, and zero-size rects because content can be
        // programmatically hidden but still be valid data (e.g., in inactive tabs or scrollable areas).
        let current = el;
        while (current && current !== document.body) {
            if (window.getComputedStyle(current).display === 'none') {
                return false;
            }
            current = current.parentElement;
        }

        return true;
    }

    // Aboutå¯¹è¯æ¡†
    function showAboutDialog() {
        const existingDialog = document.getElementById('agom-about-dialog');
        if (existingDialog) {
            existingDialog.remove();
        }

        const dialog = document.createElement('div');
        dialog.id = 'agom-about-dialog';
        dialog.innerHTML = `
            <div class="about-overlay">
                <div class="about-content">
                    <div class="about-header">
                        <h3>ğŸ“ Agom Markdownæå–å™¨</h3>
                        <button class="about-close-btn">Ã—</button>
                    </div>
                    <div class="about-body">
                        <p><strong>ç‰ˆæœ¬ï¼š</strong> v${SCRIPT_VERSION}</p>
                        <p><strong>ä½œè€…ï¼š</strong> Agom Liou</p>
                        <p><strong>å¾®ä¿¡ï¼š</strong> uncleliou</p>
                        <p><strong>åŠŸèƒ½ï¼š</strong> æ™ºèƒ½æå–ç½‘é¡µå†…å®¹å¹¶è½¬æ¢ä¸ºMarkdownæ ¼å¼</p>
                        <div class="about-actions">
                            <button class="donate-btn">ğŸ’° æ”¯æŒä½œè€…</button>
                            <button class="close-about-btn">å…³é—­</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const style = document.createElement('style');
        style.textContent = `
            .about-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 999999;
            }
            .about-content {
                background: white;
                border-radius: 8px;
                width: 400px;
                max-width: 90vw;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
            .about-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                border-bottom: 1px solid #eee;
            }
            .about-header h3 {
                margin: 0;
                color: #333;
                font-size: 18px;
            }
            .about-close-btn {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #999;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .about-body {
                padding: 20px;
            }
            .about-body p {
                margin: 10px 0;
                color: #666;
                line-height: 1.5;
            }
            .about-actions {
                margin-top: 20px;
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }
            .donate-btn, .close-about-btn {
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }
            .donate-btn {
                background: #ff6b35;
                color: white;
            }
            .close-about-btn {
                background: #6c757d;
                color: white;
            }
            .donate-btn:hover {
                background: #e55a2e;
            }
            .close-about-btn:hover {
                background: #5a6268;
            }
        `;

        dialog.appendChild(style);
        document.body.appendChild(dialog);

        // ç»‘å®šäº‹ä»¶
        dialog.querySelector('.about-close-btn').addEventListener('click', () => {
            dialog.remove();
        });
        dialog.querySelector('.close-about-btn').addEventListener('click', () => {
            dialog.remove();
        });
        dialog.querySelector('.donate-btn').addEventListener('click', () => {
            showPaymentQR();
        });
        dialog.querySelector('.about-overlay').addEventListener('click', (e) => {
            if (e.target === dialog.querySelector('.about-overlay')) {
                dialog.remove();
            }
        });
    }

    // æ˜¾ç¤ºæ”¶æ¬¾ç 
    function showPaymentQR() {
        const existingQR = document.getElementById('agom-payment-qr');
        if (existingQR) {
            existingQR.remove();
        }

        const qrDialog = document.createElement('div');
        qrDialog.id = 'agom-payment-qr';
        qrDialog.innerHTML = `
            <div class="qr-overlay">
                <div class="qr-content">
                    <div class="qr-header">
                        <h3>ğŸ’° æ”¯æŒä½œè€…</h3>
                        <button class="qr-close-btn">Ã—</button>
                    </div>
                    <div class="qr-body">
                        <p>å¦‚æœè¿™ä¸ªè„šæœ¬å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œå¯ä»¥æ‰“èµæˆ‘ä¸€äº›æ‚¨å–ç­æˆåŠŸåçš„å°æ—¶å·¥èµ„</p>
                        <img src="data:image/png;base64,${PAYMENT_QR_BASE64}" alt="æ”¶æ¬¾ç " style="width: 200px; height: 200px; margin: 10px auto; display: block;">
                        <p style="text-align: center; color: #666; margin-top: 10px;">å¾®ä¿¡æ‰«ç æ”¯æŒ</p>
                    </div>
                </div>
            </div>
        `;

        const qrStyle = document.createElement('style');
        qrStyle.textContent = `
            .qr-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 999999;
            }
            .qr-content {
                background: white;
                border-radius: 8px;
                width: 320px;
                max-width: 90vw;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
            .qr-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                border-bottom: 1px solid #eee;
            }
            .qr-header h3 {
                margin: 0;
                color: #333;
                font-size: 18px;
            }
            .qr-close-btn {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #999;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .qr-body {
                padding: 20px;
                text-align: center;
            }
            .qr-body p {
                margin: 10px 0;
                color: #666;
                line-height: 1.5;
            }
        `;

        qrDialog.appendChild(qrStyle);
        document.body.appendChild(qrDialog);

        // ç»‘å®šäº‹ä»¶
        qrDialog.querySelector('.qr-close-btn').addEventListener('click', () => {
            qrDialog.remove();
        });
        qrDialog.querySelector('.qr-overlay').addEventListener('click', (e) => {
            if (e.target === qrDialog.querySelector('.qr-overlay')) {
                qrDialog.remove();
            }
        });
    }

    // æ¯æ—¥æç¤ºåŠŸèƒ½ - å·²ç¦ç”¨
    function checkDailyReminder() {
        // æ‰“èµå¼¹çª—å·²ç¦ç”¨
        return;
    }

    // åœ¨é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œæ¯æ—¥æç¤ºæ£€æŸ¥
    if (isTopWindow) {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkDailyReminder);
        } else {
            setTimeout(checkDailyReminder, 1000);
        }
    }


})();